<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="/resources/spdi-openaccess-jats.xsl"?>
<!DOCTYPE response [
	
<!ENTITY % article SYSTEM "http://jats.nlm.nih.gov/archiving/1.2/JATS-archivearticle1.dtd">
<!ENTITY % book-part-wrapper SYSTEM "http://jats.nlm.nih.gov/extensions/bits/2.0/BITS-book2.dtd">
	]><response><apiMessage>This XML was provided by Springer Nature</apiMessage><query>doi:10.1007/s00158-022-03389-5</query><apiKey>87ba7cb21f89ce78154df796840621f4</apiKey><result><total>1</total><start>1</start><pageLength>2</pageLength><recordsDisplayed>1</recordsDisplayed></result><records><article dtd-version="1.2" article-type="research-article" xml:lang="en" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="publisher-id">158</journal-id><journal-id journal-id-type="doi">10.1007/158.1615-1488</journal-id><journal-title-group><journal-title>Structural and Multidisciplinary Optimization</journal-title><abbrev-journal-title abbrev-type="publisher">Struct Multidisc Optim</abbrev-journal-title></journal-title-group><issn pub-type="ppub">1615-147X</issn><issn pub-type="epub">1615-1488</issn><publisher><publisher-name>Springer Berlin Heidelberg</publisher-name><publisher-loc>Berlin/Heidelberg</publisher-loc></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">s00158-022-03389-5</article-id><article-id pub-id-type="manuscript">3389</article-id><article-id pub-id-type="doi">10.1007/s00158-022-03389-5</article-id><article-categories><subj-group subj-group-type="heading"><subject>Research Paper</subject></subj-group></article-categories><title-group><article-title xml:lang="en">Trace formulation for photonic inverse design with incoherent sources</article-title></title-group><contrib-group><contrib contrib-type="author" id="Au1"><contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-3165-8724</contrib-id><name><surname>Yao</surname><given-names>Wenjie</given-names></name><xref ref-type="aff" rid="Aff1">1</xref></contrib><contrib contrib-type="author" id="Au2"><name><surname>Verdugo</surname><given-names>Francesc</given-names></name><xref ref-type="aff" rid="Aff2">2</xref></contrib><contrib contrib-type="author" id="Au3"><name><surname>Christiansen</surname><given-names>Rasmus E.</given-names></name><xref ref-type="aff" rid="Aff3">3</xref><xref ref-type="aff" rid="Aff4">4</xref></contrib><contrib contrib-type="author" corresp="yes" id="Au4"><name><surname>Johnson</surname><given-names>Steven G.</given-names></name><address><email>stevenj@mit.edu</email></address><xref ref-type="aff" rid="Aff5">5</xref><xref ref-type="corresp" rid="IDs00158022033895_cor4">d</xref></contrib><aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.116068.8</institution-id><institution-id institution-id-type="ISNI">0000 0001 2341 2786</institution-id><institution content-type="org-division">Department of Electrical Engineering and Computer Science</institution><institution content-type="org-name">Massachusetts Institute of Technology</institution></institution-wrap><addr-line content-type="city">Cambridge</addr-line><addr-line content-type="state">MA</addr-line><country country="US">USA</country></aff><aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.423759.e</institution-id><institution-id institution-id-type="ISNI">0000 0004 1763 8297</institution-id><institution content-type="org-division">CIMNE</institution><institution content-type="org-name">Centre Internacional de Mètodes Numèrics a l’Enginyeria</institution></institution-wrap><addr-line content-type="city">Castelldefels</addr-line><country country="ES">Spain</country></aff><aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.5170.3</institution-id><institution-id institution-id-type="ISNI">0000 0001 2181 8870</institution-id><institution content-type="org-division">NanoPhoton–Center for Nanophotonics</institution><institution content-type="org-name">Technical University of Denmark</institution></institution-wrap><addr-line content-type="city">Kgs. Lyngby</addr-line><country country="DK">Denmark</country></aff><aff id="Aff4"><label>4</label><institution-wrap><institution-id institution-id-type="GRID">grid.5170.3</institution-id><institution-id institution-id-type="ISNI">0000 0001 2181 8870</institution-id><institution content-type="org-division">Department of Civil and Mechanical Engineering</institution><institution content-type="org-name">Technical University of Denmark</institution></institution-wrap><addr-line content-type="city">Kgs. Lyngby</addr-line><country country="DK">Denmark</country></aff><aff id="Aff5"><label>5</label><institution-wrap><institution-id institution-id-type="GRID">grid.116068.8</institution-id><institution-id institution-id-type="ISNI">0000 0001 2341 2786</institution-id><institution content-type="org-division">Department of Mathematics</institution><institution content-type="org-name">Massachusetts Institute of Technology</institution></institution-wrap><addr-line content-type="city">Cambridge</addr-line><addr-line content-type="state">MA</addr-line><country country="US">USA</country></aff></contrib-group><author-notes><fn fn-type="com"><p>Responsible Editor: Shikui Chen</p></fn><corresp id="IDs00158022033895_cor4"><label>d</label><email>stevenj@mit.edu</email></corresp></author-notes><pub-date date-type="pub" publication-format="electronic"><day>15</day><month>11</month><year>2022</year></pub-date><pub-date date-type="pub" publication-format="print"><month>11</month><year>2022</year></pub-date><volume>65</volume><issue seq="32">11</issue><elocation-id>336</elocation-id><history><date date-type="registration"><day>1</day><month>9</month><year>2022</year></date><date date-type="received"><day>25</day><month>11</month><year>2021</year></date><date date-type="rev-recd"><day>7</day><month>7</month><year>2022</year></date><date date-type="accepted"><day>31</day><month>8</month><year>2022</year></date><date date-type="online"><day>15</day><month>11</month><year>2022</year></date></history><permissions><copyright-statement content-type="compact">© The Author(s) 2022</copyright-statement><copyright-year>2022</copyright-year><copyright-holder>The Author(s)</copyright-holder><license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/4.0/"><license-p><bold>Open Access</bold>This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons licence, and indicate if changes were made. The images or other third party material in this article are included in the article's Creative Commons licence, unless indicated otherwise in a credit line to the material. If material is not included in the article's Creative Commons licence and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this licence, visit <ext-link xlink:href="http://creativecommons.org/licenses/by/4.0/" ext-link-type="uri">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p></license></permissions><abstract xml:lang="en" id="Abs1"><title>Abstract</title><p id="Par1">Spatially incoherent light sources, such as spontaneously emitting atoms, naively require Maxwell’s equations to be solved many times to obtain the total emission, which becomes computationally intractable in conjunction with large-scale optimization (inverse design). We present a trace formulation of incoherent emission that can be efficiently combined with inverse design, even for topology optimization over thousands of design degrees of freedom. Our formulation includes previous reciprocity-based approaches, limited to a few output channels (e.g., normal emission), as special cases but generalizes to a continuum of emission directions by exploiting the low-rank structure of emission problems. We present several examples of incoherent-emission topology optimization, including tailoring the geometry of fluorescent particles, a periodically emitting surface, and a structure emitting into a waveguide mode, as well as discussing future applications to problems such as Raman sensing and cathodoluminescence.</p></abstract><kwd-group xml:lang="en"><title>Keywords</title><kwd>Incoherent emission</kwd><kwd>Topology optimization</kwd><kwd>Inverse design</kwd></kwd-group><funding-group><award-group><funding-source><institution-wrap><institution>Defense Advanced Research Projects Agency</institution><institution-id institution-id-type="doi" vocab="open-funder-registry">http://dx.doi.org/10.13039/100000185</institution-id></institution-wrap></funding-source><award-id award-type="FundRef grant">R0011-20-90016</award-id><principal-award-recipient><name><surname>Johnson</surname><given-names>Steven G.</given-names></name></principal-award-recipient></award-group><award-group><funding-source><institution-wrap><institution>Army Research Laboratory</institution><institution-id institution-id-type="doi" vocab="open-funder-registry">http://dx.doi.org/10.13039/100006754</institution-id></institution-wrap></funding-source><award-id award-type="FundRef grant">W911NF-13-D-0001</award-id><principal-award-recipient><name><surname>Johnson</surname><given-names>Steven G.</given-names></name></principal-award-recipient></award-group><award-group><funding-source><institution-wrap><institution>Severo Ochoa Centre of Excellence</institution></institution-wrap></funding-source><award-id award-type="FundRef grant">CEX2018-000797-S</award-id><principal-award-recipient><name><surname>Verdugo</surname><given-names>Francesc</given-names></name></principal-award-recipient></award-group><award-group><funding-source><institution-wrap><institution>Danish National Research Foundation</institution></institution-wrap></funding-source><award-id award-type="FundRef grant">DNRF147 -NanoPhoton</award-id><principal-award-recipient><name><surname>Christiansen</surname><given-names>Rasmus E.</given-names></name></principal-award-recipient></award-group><award-group><funding-source><institution-wrap><institution>Massachusetts Institute of Technology (MIT)</institution></institution-wrap></funding-source></award-group></funding-group><custom-meta-group><custom-meta><meta-name>publisher-imprint-name</meta-name><meta-value>Springer</meta-value></custom-meta><custom-meta><meta-name>volume-issue-count</meta-name><meta-value>12</meta-value></custom-meta><custom-meta><meta-name>issue-article-count</meta-name><meta-value>35</meta-value></custom-meta><custom-meta><meta-name>issue-toc-levels</meta-name><meta-value>0</meta-value></custom-meta><custom-meta><meta-name>issue-pricelist-year</meta-name><meta-value>2022</meta-value></custom-meta><custom-meta><meta-name>issue-copyright-holder</meta-name><meta-value>Springer-Verlag GmbH Germany, part of Springer Nature</meta-value></custom-meta><custom-meta><meta-name>issue-copyright-year</meta-name><meta-value>2022</meta-value></custom-meta><custom-meta><meta-name>article-contains-esm</meta-name><meta-value>No</meta-value></custom-meta><custom-meta><meta-name>article-numbering-style</meta-name><meta-value>ContentOnly</meta-value></custom-meta><custom-meta><meta-name>article-registration-date-year</meta-name><meta-value>2022</meta-value></custom-meta><custom-meta><meta-name>article-registration-date-month</meta-name><meta-value>9</meta-value></custom-meta><custom-meta><meta-name>article-registration-date-day</meta-name><meta-value>1</meta-value></custom-meta><custom-meta><meta-name>article-toc-levels</meta-name><meta-value>0</meta-value></custom-meta><custom-meta><meta-name>toc-levels</meta-name><meta-value>0</meta-value></custom-meta><custom-meta><meta-name>volume-type</meta-name><meta-value>Regular</meta-value></custom-meta><custom-meta><meta-name>journal-product</meta-name><meta-value>ArchiveJournal</meta-value></custom-meta><custom-meta><meta-name>numbering-style</meta-name><meta-value>ContentOnly</meta-value></custom-meta><custom-meta><meta-name>article-grants-type</meta-name><meta-value>OpenChoice</meta-value></custom-meta><custom-meta><meta-name>metadata-grant</meta-name><meta-value>OpenAccess</meta-value></custom-meta><custom-meta><meta-name>abstract-grant</meta-name><meta-value>OpenAccess</meta-value></custom-meta><custom-meta><meta-name>bodypdf-grant</meta-name><meta-value>OpenAccess</meta-value></custom-meta><custom-meta><meta-name>bodyhtml-grant</meta-name><meta-value>OpenAccess</meta-value></custom-meta><custom-meta><meta-name>bibliography-grant</meta-name><meta-value>OpenAccess</meta-value></custom-meta><custom-meta><meta-name>esm-grant</meta-name><meta-value>OpenAccess</meta-value></custom-meta><custom-meta><meta-name>online-first</meta-name><meta-value>false</meta-value></custom-meta><custom-meta><meta-name>pdf-file-reference</meta-name><meta-value>BodyRef/PDF/158_2022_Article_3389.pdf</meta-value></custom-meta><custom-meta><meta-name>pdf-type</meta-name><meta-value>Typeset</meta-value></custom-meta><custom-meta><meta-name>target-type</meta-name><meta-value>OnlinePDF</meta-value></custom-meta><custom-meta><meta-name>issue-online-date-year</meta-name><meta-value>2022</meta-value></custom-meta><custom-meta><meta-name>issue-online-date-month</meta-name><meta-value>11</meta-value></custom-meta><custom-meta><meta-name>issue-online-date-day</meta-name><meta-value>26</meta-value></custom-meta><custom-meta><meta-name>issue-print-date-year</meta-name><meta-value>2022</meta-value></custom-meta><custom-meta><meta-name>issue-print-date-month</meta-name><meta-value>11</meta-value></custom-meta><custom-meta><meta-name>issue-print-date-day</meta-name><meta-value>26</meta-value></custom-meta><custom-meta><meta-name>issue-type</meta-name><meta-value>Regular</meta-value></custom-meta><custom-meta><meta-name>article-type</meta-name><meta-value>OriginalPaper</meta-value></custom-meta><custom-meta><meta-name>journal-subject-primary</meta-name><meta-value>Engineering</meta-value></custom-meta><custom-meta><meta-name>journal-subject-secondary</meta-name><meta-value>Theoretical and Applied Mechanics</meta-value></custom-meta><custom-meta><meta-name>journal-subject-secondary</meta-name><meta-value>Computational Mathematics and Numerical Analysis</meta-value></custom-meta><custom-meta><meta-name>journal-subject-secondary</meta-name><meta-value>Engineering Design</meta-value></custom-meta><custom-meta><meta-name>journal-subject-collection</meta-name><meta-value>Engineering</meta-value></custom-meta><custom-meta><meta-name>open-access</meta-name><meta-value>true</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="Sec1"><title>Introduction</title><p id="Par2">Incoherent emission (light emission from random current sources) arises in many problems in optics: spontaneous emission (fluorescence) (Milonni <xref ref-type="bibr" rid="CR58">1976</xref>; Kim <xref ref-type="bibr" rid="CR40">1986</xref>; Polimeridis et al. <xref ref-type="bibr" rid="CR72">2015</xref>), thermal emission in both far (Carey et al. <xref ref-type="bibr" rid="CR12">2008</xref>) and near (Basu et al. <xref ref-type="bibr" rid="CR6">2009</xref>; Rodriguez et al. <xref ref-type="bibr" rid="CR77">2013</xref>) fields, scintillation (Brenny et al. <xref ref-type="bibr" rid="CR10">2014</xref>; Roques-Carmes et al. <xref ref-type="bibr" rid="CR79">2021</xref>), Casimir and van der Waals forces (Gong et al. <xref ref-type="bibr" rid="CR24">2021</xref>), Raman scattering in fluid suspensions (Pilot et al. <xref ref-type="bibr" rid="CR71">2019</xref>), incoherent incident waves (Wolf <xref ref-type="bibr" rid="CR89">2007</xref>) (which can be transformed to random sources via the equivalence principle Harrington <xref ref-type="bibr" rid="CR28">2001</xref>), and even scattering from surface roughness via a Born approximation (Johnson et al. <xref ref-type="bibr" rid="CR39">2005</xref>). However, accurate modeling of such spatially random sources can pose severe computational challenges, because a direct approach would involve averaging the results of many simulations over an ensemble of sources (Rodriguez et al. <xref ref-type="bibr" rid="CR76">2011</xref>; Luo et al. <xref ref-type="bibr" rid="CR54">2004</xref>; Bao et al. <xref ref-type="bibr" rid="CR5">2019</xref>); the statistics (correlation functions) of the <italic>sources</italic> are known, but the difficulty is converting this into statistics (e.g., average power) of the resulting <italic>fields</italic>. In the cases of fluorescence (Polimeridis et al. <xref ref-type="bibr" rid="CR72">2015</xref>), near-field thermal radiation (Rodriguez et al. <xref ref-type="bibr" rid="CR77">2013</xref>), and Casimir forces (Gong et al. <xref ref-type="bibr" rid="CR24">2021</xref>), for example, tractable methods for arbitrary geometries were only obtained recently. This challenge is compounded when one wishes to perform <italic>inverse design</italic> (Molesky et al. <xref ref-type="bibr" rid="CR59">2018</xref>)—large-scale optimization of emission over many geometric parameters, perhaps even over “every pixel” of a design region via topology optimization (TopOpt) (Jensen and Sigmund <xref ref-type="bibr" rid="CR33">2011</xref>)—because one must then repeat the computation 10–1000 s of times as the design evolves, e.g., to maximize spontaneous emission (Rogobete et al. <xref ref-type="bibr" rid="CR78">2003</xref>; Liang and Johnson <xref ref-type="bibr" rid="CR52">2013</xref>; Wang et al. <xref ref-type="bibr" rid="CR88">2018</xref>; Yao et al. <xref ref-type="bibr" rid="CR91">2020</xref>) or Raman emission (Christiansen et al. <xref ref-type="bibr" rid="CR16">2020</xref>) from a single molecule, much less a distribution of sources.</p><p id="Par3">In this paper, we present a unified framework for inverse design of incoherent emission, combining a <italic>trace formulation</italic> adapted from recent work (Rodriguez et al. <xref ref-type="bibr" rid="CR77">2013</xref>; Polimeridis et al. <xref ref-type="bibr" rid="CR72">2015</xref>; Reid et al. <xref ref-type="bibr" rid="CR73">2017</xref>) (Sect. <xref rid="Sec2" ref-type="sec">2</xref>) with a new algorithm to <italic>simultaneously</italic> optimize the geometry and evolve to an accurate estimate of the average emission/trace (Sect. <xref rid="Sec7" ref-type="sec">2.5</xref>). We apply this framework to perform density-based TopOpt (Jensen and Sigmund <xref ref-type="bibr" rid="CR33">2011</xref>) on several example problems in two dimensions: fluorescence from an optimized nanoparticle (Sect. <xref rid="Sec10" ref-type="sec">4.1</xref>), enhanced emission from a corrugated surface analogous to a light-emitting diode (Erchak et al. <xref ref-type="bibr" rid="CR20">2001</xref>) (Sect. <xref rid="Sec11" ref-type="sec">4.2</xref>), and optimized emission into a waveguide (Sect. <xref rid="Sec12" ref-type="sec">4.3</xref>). In each case, the emission is not from a single molecule, but the average power produced by an ensemble of incoherent emitters at every point in some material. We show that this emission can be computed by a small number of “eigen-sources” of a Hermitian operator, which can be determined by a Rayleigh-quotient optimization (Li <xref ref-type="bibr" rid="CR51">2015</xref>) that is <italic>combined</italic> with the inverse-design (geometric) optimization. In the special case of emission into a small number <italic>K</italic> of channels, such as <italic>K</italic> far-field directions, <italic>K</italic> waveguide modes, or <italic>K</italic> points in space, we show that a simple algebraic manipulation transforms the problem into <italic>K</italic> simulations (Sect. <xref rid="Sec5" ref-type="sec">2.3</xref>)—this unifies and generalizes known results based on Kirchhoff’s law of thermal radiation (Reif <xref ref-type="bibr" rid="CR74">1965</xref>; Greffet et al. <xref ref-type="bibr" rid="CR25">2018</xref>) or (more generally) reciprocity (Roques-Carmes et al. <xref ref-type="bibr" rid="CR79">2021</xref>; Janssen et al. <xref ref-type="bibr" rid="CR32">2010</xref>) for computing emission into a single planewave direction—but our alternative approach (Sect. <xref rid="Sec7" ref-type="sec">2.5</xref>) yields a small number of solves even for <inline-formula id="IEq1"><alternatives><mml:math id="IEq1_Math"><mml:mrow><mml:mi>K</mml:mi><mml:mo stretchy="false">→</mml:mo><mml:mi>∞</mml:mi></mml:mrow></mml:math><tex-math id="IEq1_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$K\rightarrow \infty$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq1.gif"/></alternatives></inline-formula>. The other well-known special case is that of a single-emitter location with a random orientation, which reduces to the local density of states (LDOS) via three Maxwell solves (Milonni <xref ref-type="bibr" rid="CR58">1976</xref>; Oskooi and Johnson <xref ref-type="bibr" rid="CR65">2013</xref>), and this appears as another low-rank special case in our formulation (Sect. <xref rid="Sec6" ref-type="sec">2.4</xref>). We believe that this computational framework will enable many future developments in the computational design of complex optical devices involving a wide variety of incoherent processes (Sect. <xref rid="Sec13" ref-type="sec">5</xref>).</p><p id="Par4">Density-based TopOpt has attracted increasing interest over the last few decades because of its ability to reveal surprising high-efficiency designs by optimizing over thousands or even millions of design degrees of freedom (Jensen and Sigmund <xref ref-type="bibr" rid="CR33">2011</xref>). It parameterizes a structure by an artificial “density” <inline-formula id="IEq2"><alternatives><mml:math id="IEq2_Math"><mml:mrow><mml:mi>ρ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>∈</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:math><tex-math id="IEq2_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho (\mathbf {x}) \in [0,1]$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq2.gif"/></alternatives></inline-formula> at <italic>every point</italic> (or every “pixel”) in a design region, which is typically passed through smoothing and threshold steps to yield a physical “binary” design consisting of one of two materials at every point. We apply a damped-diffusion filter (Lazarov and Sigmund <xref ref-type="bibr" rid="CR50">2011</xref>), which regularizes the problem by setting a minimum length scale on the design. (Additional manufacturing constraints can be imposed by well-known techniques Hammond et al. <xref ref-type="bibr" rid="CR27">2021</xref>, but in the present work, we focus on the fundamental algorithms and not on experimental realization.) Once a scalar objective function (to be optimized) is defined, such as the emitted power (e.g., the new formulation in this paper), its derivatives (sensitivities) with respect to all the design parameters can be efficiently computed with a single additional simulation via adjoint methods (Molesky et al. <xref ref-type="bibr" rid="CR59">2018</xref>; Tortorelli and Michaleris <xref ref-type="bibr" rid="CR83">1994</xref>). Given the objective function and its derivatives, a variety of large-scale optimization algorithms are available; we use the CCSA/MMA method (Svanberg <xref ref-type="bibr" rid="CR82">2002</xref>). We employ a recent free/open-source finite-element method (FEM) package, Gridap.jl (Badia and Verdugo <xref ref-type="bibr" rid="CR4">2020</xref>), in the Julia language (Bezanson et al. <xref ref-type="bibr" rid="CR9">2017</xref>), which allows us to efficiently code highly customized FEM-based trace formulations in a high-level language, with the construction of the adjoint problem aided by automatic-differentiation (AD) tools (Revels et al. <xref ref-type="bibr" rid="CR75">2016</xref>; Innes <xref ref-type="bibr" rid="CR30">2018</xref>).</p></sec><sec id="Sec2"><title>Trace formulation</title><p id="Par5">In this section, we first review the formulation of the frequency-domain Maxwell equations as a linear equation, discretized for numerical computation, with physical quantities like power as quadratic forms. Then we show how the ensemble average of such an expression over a distribution of random current sources can be rewritten as a deterministic trace formula. Finally, we explain how such a trace formula can be evaluated efficiently in the context of photonics optimization, both in the “easy” cases of coupling to a small number of output/input channels as well as in the more general cases of a continuum of outputs.</p><sec id="Sec3"><title>Wave sources and quadratic outputs</title><p id="Par6">In the frequency domain, the linear Maxwell equations for the electric field <inline-formula id="IEq3"><alternatives><mml:math id="IEq3_Math"><mml:mi mathvariant="bold">E</mml:mi></mml:math><tex-math id="IEq3_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {E}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq3.gif"/></alternatives></inline-formula> in response to a time-harmonic current source at a frequency <inline-formula id="IEq4"><alternatives><mml:math id="IEq4_Math"><mml:mi>ω</mml:mi></mml:math><tex-math id="IEq4_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\omega$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq4.gif"/></alternatives></inline-formula> are (Jin <xref ref-type="bibr" rid="CR34">2014</xref>)<disp-formula id="Equ1"><label>1</label><alternatives><mml:math display="block" id="Equ1_Math"><mml:mrow><mml:mfenced close="]" open="["><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>μ</mml:mi></mml:mfrac><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mo>-</mml:mo><mml:msup><mml:mfenced close=")" open="("><mml:mfrac><mml:mi>ω</mml:mi><mml:mi>c</mml:mi></mml:mfrac></mml:mfenced><mml:mn>2</mml:mn></mml:msup><mml:mi>ε</mml:mi></mml:mfenced><mml:mi mathvariant="bold">E</mml:mi><mml:mo>=</mml:mo><mml:mi mathvariant="bold">f</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ1_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left[ \nabla \times \frac{1}{\mu }\nabla \times -\left( \frac{\omega }{c}\right) ^{2}\varepsilon \right] \mathbf {E}=\mathbf {f},$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ1.gif"/></alternatives></disp-formula>where <inline-formula id="IEq5"><alternatives><mml:math id="IEq5_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo>,</mml:mo><mml:mi>ω</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq5_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon (\mathbf {x},\omega )$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq5.gif"/></alternatives></inline-formula> is the relative electric permittivity, <inline-formula id="IEq6"><alternatives><mml:math id="IEq6_Math"><mml:mi>μ</mml:mi></mml:math><tex-math id="IEq6_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq6.gif"/></alternatives></inline-formula> is the relative magnetic permeability, (<inline-formula id="IEq7"><alternatives><mml:math id="IEq7_Math"><mml:mrow><mml:mi>μ</mml:mi><mml:mo>≈</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><tex-math id="IEq7_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu \approx 1$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq7.gif"/></alternatives></inline-formula> for most materials at optical and infrared wavelengths, so we assume <inline-formula id="IEq8"><alternatives><mml:math id="IEq8_Math"><mml:mrow><mml:mi>μ</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><tex-math id="IEq8_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu =1$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq8.gif"/></alternatives></inline-formula> throughout this work), <italic>c</italic> is the speed of light in vacuum, and <inline-formula id="IEq9"><alternatives><mml:math id="IEq9_Math"><mml:mrow><mml:mi mathvariant="bold">f</mml:mi><mml:mo>=</mml:mo><mml:mtext>i</mml:mtext><mml:mi>ω</mml:mi><mml:mi mathvariant="bold">J</mml:mi></mml:mrow></mml:math><tex-math id="IEq9_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {f}={\text{i}}\omega \mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq9.gif"/></alternatives></inline-formula> is a current-source term.</p><p id="Par7">Numerically, one discretizes the problem (e.g., using finite elements Jin <xref ref-type="bibr" rid="CR34">2014</xref>) into a linear equation:<disp-formula id="Equ2"><label>2</label><alternatives><mml:math display="block" id="Equ2_Math"><mml:mrow><mml:mi mathvariant="bold">A</mml:mi><mml:mi mathvariant="bold">u</mml:mi><mml:mo>=</mml:mo><mml:mi mathvariant="bold">b</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ2_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}\mathbf {u}=\mathbf {b} ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ2.gif"/></alternatives></disp-formula>where <inline-formula id="IEq10"><alternatives><mml:math id="IEq10_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq10_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq10.gif"/></alternatives></inline-formula> is a matrix representing the Maxwell operator on the left hand of Eq. (<xref rid="Equ1" ref-type="disp-formula">1</xref>), <inline-formula id="IEq11"><alternatives><mml:math id="IEq11_Math"><mml:mi mathvariant="bold">u</mml:mi></mml:math><tex-math id="IEq11_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {u}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq11.gif"/></alternatives></inline-formula> is a vector representing the discretized electric (and/or magnetic) field, and <inline-formula id="IEq12"><alternatives><mml:math id="IEq12_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq12_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq12.gif"/></alternatives></inline-formula> is a vector representing the discretized source term. In the following, it is algebraically convenient to work with such a discretized (finite-dimensional) form, to avoid cumbersome infinite-dimensional linear algebra, but one could straightforwardly translate to the latter context as well (Joannopoulos et al. <xref ref-type="bibr" rid="CR35">2008</xref>).</p><p id="Par8">Most physical quantities <italic>P</italic> of interest in photonics—such as power (via the Poynting flux), energy density, and force (via the Maxwell stress tensor)—can be expressed as quadratic functions of the electromagnetic fields <inline-formula id="IEq13"><alternatives><mml:math id="IEq13_Math"><mml:mi mathvariant="bold">u</mml:mi></mml:math><tex-math id="IEq13_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {u}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq13.gif"/></alternatives></inline-formula>. Since these are real-valued quantities, they correspond in particular to Hermitian quadratic forms:<disp-formula id="Equ3"><label>3</label><alternatives><mml:math display="block" id="Equ3_Math"><mml:mrow><mml:mi>P</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mi mathvariant="bold">u</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ3_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P = \mathbf {u}^{\dagger} \mathbf {O} \mathbf {u} ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ3.gif"/></alternatives></disp-formula>where <inline-formula id="IEq14"><alternatives><mml:math id="IEq14_Math"><mml:mo>†</mml:mo></mml:math><tex-math id="IEq14_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\dagger$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq14.gif"/></alternatives></inline-formula> denotes the conjugate transpose (adjoint) and <inline-formula id="IEq15"><alternatives><mml:math id="IEq15_Math"><mml:mrow><mml:mi mathvariant="bold">O</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">O</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup></mml:mrow></mml:math><tex-math id="IEq15_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}=\mathbf {O}^{\dagger}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq15.gif"/></alternatives></inline-formula> is a Hermitian matrix/operator. In this paper, we are mainly concerned with computing emitted <italic>power</italic><italic>P</italic>, which is constrained by the outgoing boundary conditions to be non-negative, in which case <inline-formula id="IEq16"><alternatives><mml:math id="IEq16_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq16_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq16.gif"/></alternatives></inline-formula> must furthermore be a <italic>positive semidefinite</italic> Hermitian matrix (i.e., non-negative eigenvalues) in the subspace of permissible <inline-formula id="IEq17"><alternatives><mml:math id="IEq17_Math"><mml:mi mathvariant="bold">u</mml:mi></mml:math><tex-math id="IEq17_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {u}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq17.gif"/></alternatives></inline-formula>, a property that will be useful in Sect. <xref rid="Sec7" ref-type="sec">2.5</xref>.</p></sec><sec id="Sec4"><title>Trace formula for random sources</title><p id="Par9">Now, consider the case where one has an ensemble of random current sources <inline-formula id="IEq18"><alternatives><mml:math id="IEq18_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq18_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq18.gif"/></alternatives></inline-formula> drawn from some statistical distribution with zero mean and a known correlation function (e.g., a known mean-square current at each point if they are spatially uncorrelated). In this case, we wish to compute the ensemble average, denoted by <inline-formula id="IEq19"><alternatives><mml:math id="IEq19_Math"><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mo>⋯</mml:mo><mml:mo stretchy="false">⟩</mml:mo></mml:mrow></mml:math><tex-math id="IEq19_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle \cdots \rangle$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq19.gif"/></alternatives></inline-formula>, of our quadratic form Eq. (<xref rid="Equ3" ref-type="disp-formula">3</xref>):<disp-formula id="Equ4"><label>4</label><alternatives><mml:math display="block" id="Equ4_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfenced close="〉" open="〈"><mml:msup><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mi mathvariant="bold">u</mml:mi></mml:mfenced><mml:mo>=</mml:mo><mml:mfenced close="〉" open="〈"><mml:msup><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">b</mml:mi></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ4_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle P \rangle = \left\langle \mathbf {u}^{\dagger} \mathbf {O}\mathbf {u}\right\rangle = \left\langle \mathbf {b}^{\dagger} \mathbf {A}^{-\dagger }\mathbf {O}\mathbf {A}^{-1}\mathbf {b}\right\rangle ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ4.gif"/></alternatives></disp-formula>where <inline-formula id="IEq20"><alternatives><mml:math id="IEq20_Math"><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup></mml:math><tex-math id="IEq20_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-\dagger }$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq20.gif"/></alternatives></inline-formula> denotes <inline-formula id="IEq21"><alternatives><mml:math id="IEq21_Math"><mml:mrow><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><tex-math id="IEq21_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$(\mathbf {A}^{-1})^{\dagger} = (\mathbf {A}^{\dagger} )^{-1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq21.gif"/></alternatives></inline-formula>. Note that only <inline-formula id="IEq22"><alternatives><mml:math id="IEq22_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq22_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq22.gif"/></alternatives></inline-formula> is random in the right-hand expression.</p><p id="Par10">Naively, this average could be computed by a brute-force method in which one explicitly solves the Maxwell equations (<inline-formula id="IEq23"><alternatives><mml:math id="IEq23_Math"><mml:mrow><mml:mi mathvariant="bold">u</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">b</mml:mi></mml:mrow></mml:math><tex-math id="IEq23_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {u} = \mathbf {A}^{-1}\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq23.gif"/></alternatives></inline-formula>) for many possible sources <inline-formula id="IEq24"><alternatives><mml:math id="IEq24_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq24_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq24.gif"/></alternatives></inline-formula> and then integrates over the distribution, perhaps by a Monte Carlo (random-sampling) method. That approach is possible and has been accomplished, e.g., for evaluating thermal radiation (Rodriguez et al. <xref ref-type="bibr" rid="CR76">2011</xref>; Luo et al. <xref ref-type="bibr" rid="CR54">2004</xref>), but is computationally expensive. Worse, such a direct approach quickly becomes prohibitive in the context of inverse design, where the averaging must be repeated for many geometries over the course of solving an optimization problem using an iterative algorithm.</p><p id="Par11">Instead, we adapt “trace formula” techniques that have been developed for similar problems in thermal radiation (Rodriguez et al. <xref ref-type="bibr" rid="CR77">2013</xref>) and spontaneous emission (Polimeridis et al. <xref ref-type="bibr" rid="CR72">2015</xref>), where one must compute the average effect of many random current sources distributed throughout a volume. The basic trick (as reviewed in yet another related setting in Reid et al. <xref ref-type="bibr" rid="CR73">2017</xref>) is to write the scalar <inline-formula id="IEq25"><alternatives><mml:math id="IEq25_Math"><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow></mml:math><tex-math id="IEq25_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle P \rangle$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq25.gif"/></alternatives></inline-formula> as a <inline-formula id="IEq26"><alternatives><mml:math id="IEq26_Math"><mml:mrow><mml:mn>1</mml:mn><mml:mo>×</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><tex-math id="IEq26_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$1 \times 1$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq26.gif"/></alternatives></inline-formula> “matrix” trace and then employ the cyclic-shift property (Lax <xref ref-type="bibr" rid="CR49">2013</xref>) to group the <inline-formula id="IEq27"><alternatives><mml:math id="IEq27_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq27_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq27.gif"/></alternatives></inline-formula> terms together:<disp-formula id="Equ5"><label>5</label><alternatives><mml:math display="block" id="Equ5_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfenced close="〉" open="〈"><mml:msup><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">b</mml:mi></mml:mfenced><mml:mo>=</mml:mo><mml:mtext>tr</mml:mtext><mml:mfenced close="〉" open="〈"><mml:msup><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">b</mml:mi></mml:mfenced><mml:mo>=</mml:mo><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi mathvariant="bold">b</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mo stretchy="false">⟩</mml:mo></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ5_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle P \rangle = \left\langle \mathbf {b}^{\dagger} \mathbf {A}^{-\dagger }\mathbf {O}\mathbf {A}^{-1}\mathbf {b}\right\rangle ={\text {tr}}\left\langle \mathbf {b}^{\dagger} \mathbf {A}^{-\dagger }\mathbf {O}\mathbf {A}^{-1}\mathbf {b}\right\rangle ={\text {tr}}\left[ \mathbf {A}^{-\dagger }\mathbf {O}\mathbf {A}^{-1}\langle \mathbf {b}\mathbf {b}^{\dagger} \rangle \right] .$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ5.gif"/></alternatives></disp-formula>Here, the ensemble average is now confined to the <inline-formula id="IEq28"><alternatives><mml:math id="IEq28_Math"><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi mathvariant="bold">b</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mo stretchy="false">⟩</mml:mo></mml:mrow></mml:math><tex-math id="IEq28_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle \mathbf {b}\mathbf {b}^{\dagger} \rangle$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq28.gif"/></alternatives></inline-formula> term, which is just the correlation matrix <inline-formula id="IEq29"><alternatives><mml:math id="IEq29_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq29_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq29.gif"/></alternatives></inline-formula> (Johnson and Wichern <xref ref-type="bibr" rid="CR36">2018</xref>) of the currents; such a matrix is positive semidefinite, so it can be factorized (Trefethen and Bau <xref ref-type="bibr" rid="CR84">1997</xref>) (for convenience below) as follows:<disp-formula id="Equ6"><label>6</label><alternatives><mml:math display="block" id="Equ6_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi mathvariant="bold">b</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi mathvariant="bold">B</mml:mi><mml:mo>=</mml:mo><mml:mi mathvariant="bold">D</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ6_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle \mathbf {b}\mathbf {b}^{\dagger} \rangle =\mathbf {B}=\mathbf {D}\mathbf {D}^{\dagger} ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ6.gif"/></alternatives></disp-formula>for some known matrix <inline-formula id="IEq30"><alternatives><mml:math id="IEq30_Math"><mml:mi mathvariant="bold">D</mml:mi></mml:math><tex-math id="IEq30_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq30.gif"/></alternatives></inline-formula>. Further information about constructing the matrix <inline-formula id="IEq31"><alternatives><mml:math id="IEq31_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq31_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq31.gif"/></alternatives></inline-formula> or its factorization <inline-formula id="IEq32"><alternatives><mml:math id="IEq32_Math"><mml:mi mathvariant="bold">D</mml:mi></mml:math><tex-math id="IEq32_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq32.gif"/></alternatives></inline-formula> is given in “<xref rid="Sec14" ref-type="sec">Appendix 1</xref>.” (For the case of finite-element discretizations, we show that <inline-formula id="IEq33"><alternatives><mml:math id="IEq33_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq33_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq33.gif"/></alternatives></inline-formula> is a sparse matrix that is straightforward to assemble and <inline-formula id="IEq34"><alternatives><mml:math id="IEq34_Math"><mml:mi mathvariant="bold">D</mml:mi></mml:math><tex-math id="IEq34_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq34.gif"/></alternatives></inline-formula> is, for example, a sparse Cholesky factor Davis <xref ref-type="bibr" rid="CR17">2006</xref>.) Algebraically, expressing our results in terms of <inline-formula id="IEq35"><alternatives><mml:math id="IEq35_Math"><mml:mi mathvariant="bold">D</mml:mi></mml:math><tex-math id="IEq35_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq35.gif"/></alternatives></inline-formula> below leads to convenient Hermitian matrices, but we show in “<xref rid="Sec15" ref-type="sec">Appendix 2</xref>” that the final algorithms can easily employ <inline-formula id="IEq36"><alternatives><mml:math id="IEq36_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq36_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq36.gif"/></alternatives></inline-formula> directly to avoid the computational cost of an explicit factorization. In the simple case where random currents are <italic>spatially uncorrelated</italic>, which holds for spontaneous emission and thermal emission in local materials (Landau et al. <xref ref-type="bibr" rid="CR48">1980</xref>), <inline-formula id="IEq37"><alternatives><mml:math id="IEq37_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq37_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq37.gif"/></alternatives></inline-formula> and <inline-formula id="IEq38"><alternatives><mml:math id="IEq38_Math"><mml:mi mathvariant="bold">D</mml:mi></mml:math><tex-math id="IEq38_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq38.gif"/></alternatives></inline-formula> are conceptually <italic>diagonal</italic> linear operators whose diagonal entries are the mean-square and root-mean-square currents, respectively, at each point in space. Whether this leads to a strictly diagonal <italic>matrix</italic> depend on the discretization scheme as explained in “<xref rid="Sec14" ref-type="sec">Appendix 1</xref>.” For instance, in the case of thermal and quantum fluctuations, the mean-square currents are given by the fluctuation–dissipation theorem (FDT; Landau et al. <xref ref-type="bibr" rid="CR48">1980</xref>), while for spontaneous emission, one can use the FDT with a “negative temperature” determined by the population inversion (Pick et al. <xref ref-type="bibr" rid="CR70">2015</xref>; Patra <xref ref-type="bibr" rid="CR67">2015</xref>).</p><p id="Par12">Inserting Eq. (<xref rid="Equ6" ref-type="disp-formula">6</xref>) into Eq. (<xref rid="Equ5" ref-type="disp-formula">5</xref>), we obtain our objective as the trace of a deterministic Hermitian matrix <inline-formula id="IEq39"><alternatives><mml:math id="IEq39_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq39_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq39.gif"/></alternatives></inline-formula> (which is positive-semidefinite if <inline-formula id="IEq40"><alternatives><mml:math id="IEq40_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq40_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq40.gif"/></alternatives></inline-formula> is, as for power), given by<disp-formula id="Equ7"><label>7</label><alternatives><mml:math display="block" id="Equ7_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mtext>tr</mml:mtext><mml:munder><mml:munder accentunder="true"><mml:mfenced close="]" open="["><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfenced><mml:mo>⏟</mml:mo></mml:munder><mml:mi mathvariant="bold">H</mml:mi></mml:munder><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ7_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle P \rangle ={\text {tr}}\underbrace{\left[ (\mathbf {A}^{-1}\mathbf {D})^{\dagger} \mathbf {O}(\mathbf {A}^{-1}\mathbf {D})\right] }_\mathbf {H}.$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ7.gif"/></alternatives></disp-formula>The challenge now is to efficiently compute such a matrix trace. Evaluating a trace is easy once the matrix elements are known—it is the sum of the diagonal entries—but the difficulty in Eq. (<xref rid="Equ7" ref-type="disp-formula">7</xref>) is the computation of <inline-formula id="IEq41"><alternatives><mml:math id="IEq41_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi></mml:mrow></mml:math><tex-math id="IEq41_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-1}\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq41.gif"/></alternatives></inline-formula>. Recall that the <inline-formula id="IEq42"><alternatives><mml:math id="IEq42_Math"><mml:mrow><mml:mi>N</mml:mi><mml:mo>×</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:math><tex-math id="IEq42_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N \times N$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq42.gif"/></alternatives></inline-formula> matrix <inline-formula id="IEq43"><alternatives><mml:math id="IEq43_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq43_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq43.gif"/></alternatives></inline-formula> is a discretized Maxwell operator where <italic>N</italic> is the number of grid points (or basis functions), a huge matrix (especially in 3D). There are fast methods to solve for <inline-formula id="IEq44"><alternatives><mml:math id="IEq44_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">D</mml:mi><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><tex-math id="IEq44_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-1} (\mathbf {D} \mathbf {v})$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq44.gif"/></alternatives></inline-formula> for any <italic>single</italic> right-hand side <inline-formula id="IEq45"><alternatives><mml:math id="IEq45_Math"><mml:mi mathvariant="bold">v</mml:mi></mml:math><tex-math id="IEq45_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {v}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq45.gif"/></alternatives></inline-formula>, typically because the matrix <inline-formula id="IEq46"><alternatives><mml:math id="IEq46_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq46_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq46.gif"/></alternatives></inline-formula> is <italic>sparse</italic> (mostly zero) as in finite-element methods (Jin <xref ref-type="bibr" rid="CR34">2014</xref>), but computing the <italic>whole</italic> matrix <inline-formula id="IEq47"><alternatives><mml:math id="IEq47_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi></mml:mrow></mml:math><tex-math id="IEq47_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-1}\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq47.gif"/></alternatives></inline-formula> corresponds to solving <italic>N</italic> right-hand sides. Equivalently, computing explicit (dense) matrix inverses <inline-formula id="IEq48"><alternatives><mml:math id="IEq48_Math"><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math><tex-math id="IEq48_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq48.gif"/></alternatives></inline-formula> is typically prohibitively expensive (in both time and storage) for matrices arising in large physical systems (Davis <xref ref-type="bibr" rid="CR17">2006</xref>). Fortunately, a large number of “iterative” algorithms have been proposed for <italic>estimating</italic> matrix traces to any desired accuracy using relatively <italic>few</italic> matrix–vector products (Hutchinson <xref ref-type="bibr" rid="CR29">1989</xref>; Ubaru et al. <xref ref-type="bibr" rid="CR86">2017</xref>), and what remains is to find a method well-suited to inverse design.</p></sec><sec id="Sec5"><title>Trace computation: few output channels</title><p id="Par13">In the important special cases where the desired output is the power in a small number (<italic>K</italic>) of discrete directions/channels/ports, or perhaps the intensity at a few points in space, we show in this section that the trace computation equation (<xref rid="Equ7" ref-type="disp-formula">7</xref>) simplifies to only <italic>K</italic> scattering problems. This fact is a generalization of earlier results commonly derived from electromagnetic reciprocity (Chew <xref ref-type="bibr" rid="CR13">2008</xref>), such as the well-known Kirchhoff’s law of thermal radiation (reciprocity of emission and absorption) (Reif <xref ref-type="bibr" rid="CR74">1965</xref>) or analogous results for scintillation (Roques-Carmes et al. <xref ref-type="bibr" rid="CR79">2021</xref>). More generally, this simplification arises whenever the matrix <inline-formula id="IEq49"><alternatives><mml:math id="IEq49_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq49_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq49.gif"/></alternatives></inline-formula> in Eq. (<xref rid="Equ3" ref-type="disp-formula">3</xref>) is <italic>low rank</italic>.</p><p id="Par14">For example, suppose that the objective function is the electric-field intensity <inline-formula id="IEq50"><alternatives><mml:math id="IEq50_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">‖</mml:mo><mml:mi mathvariant="bold">E</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi mathvariant="bold">x</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:msup><mml:mrow><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:math><tex-math id="IEq50_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\Vert \mathbf {E}(\mathbf {x}_{1})\Vert ^{2}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq50.gif"/></alternatives></inline-formula> at a single point <inline-formula id="IEq51"><alternatives><mml:math id="IEq51_Math"><mml:msub><mml:mi mathvariant="bold">x</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math><tex-math id="IEq51_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {x}_{1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq51.gif"/></alternatives></inline-formula> in space, which is the case for “metalens” optimization problems in which one is maximizing intensity at a focal spot (Bayati et al. <xref ref-type="bibr" rid="CR7">2021</xref>). In matrix notation for a discretized problem, this quantity corresponds to<disp-formula id="Equ8"><label>8</label><alternatives><mml:math display="block" id="Equ8_Math"><mml:mrow><mml:mrow><mml:mi>P</mml:mi><mml:mo>=</mml:mo><mml:mo stretchy="false">‖</mml:mo><mml:mi mathvariant="bold">E</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi mathvariant="bold">x</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:msup><mml:mrow><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">‖</mml:mo><mml:msubsup><mml:mi mathvariant="bold">e</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:mi mathvariant="bold">u</mml:mi><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:munder><mml:munder accentunder="true"><mml:mrow><mml:msub><mml:mi mathvariant="bold">e</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msubsup><mml:mi mathvariant="bold">e</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mo>†</mml:mo></mml:msubsup></mml:mrow><mml:mo>⏟</mml:mo></mml:munder><mml:mi mathvariant="bold">O</mml:mi></mml:munder><mml:mi mathvariant="bold">u</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ8_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P = \Vert \mathbf {E}(\mathbf {x}_{1})\Vert ^{2} = \Vert \mathbf {e}_{1}^{\dagger} \mathbf {u}\Vert ^{2} = \mathbf {u}^{\dagger} \underbrace{\mathbf {e}_{1}\mathbf {e}_{1}^{\dagger} }_\mathbf {O} \mathbf {u} ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ8.gif"/></alternatives></disp-formula>where <inline-formula id="IEq52"><alternatives><mml:math id="IEq52_Math"><mml:msub><mml:mi mathvariant="bold">e</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math><tex-math id="IEq52_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {e}_{1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq52.gif"/></alternatives></inline-formula> is the unit vector with a nonzero entry at the location (“grid point”) corresponding to <inline-formula id="IEq53"><alternatives><mml:math id="IEq53_Math"><mml:msub><mml:mi mathvariant="bold">x</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math><tex-math id="IEq53_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {x}_{1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq53.gif"/></alternatives></inline-formula>. We then have a rank-1 (Lax <xref ref-type="bibr" rid="CR49">2013</xref>) matrix <inline-formula id="IEq54"><alternatives><mml:math id="IEq54_Math"><mml:mrow><mml:mi mathvariant="bold">O</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi mathvariant="bold">e</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msubsup><mml:mi mathvariant="bold">e</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mo>†</mml:mo></mml:msubsup></mml:mrow></mml:math><tex-math id="IEq54_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O} = \mathbf {e}_{1}\mathbf {e}_{1}^{\dagger}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq54.gif"/></alternatives></inline-formula>, and the trace equation (<xref rid="Equ7" ref-type="disp-formula">7</xref>) simplifies to <inline-formula id="IEq55"><alternatives><mml:math id="IEq55_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msubsup><mml:mi mathvariant="bold">v</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:msub><mml:mi mathvariant="bold">v</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">‖</mml:mo><mml:msub><mml:mi mathvariant="bold">v</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="IEq55_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle P \rangle = \mathbf {v}_{1}^{*} \mathbf {v}_{1} = \Vert \mathbf {v}_{1} \Vert ^{2},$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq55.gif"/></alternatives></inline-formula> where<disp-formula id="Equ9"><label>9</label><alternatives><mml:math display="block" id="Equ9_Math"><mml:mrow><mml:msub><mml:mi mathvariant="bold">v</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:msub><mml:mi mathvariant="bold">e</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math><tex-math id="Equ9_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {v}_{1} = \mathbf {D}^{\dagger} \mathbf {A}^{-\dagger } \mathbf {e}_{1}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ9.gif"/></alternatives></disp-formula>and <inline-formula id="IEq56"><alternatives><mml:math id="IEq56_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:msub><mml:mi mathvariant="bold">e</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math><tex-math id="IEq56_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-\dagger } \mathbf {e}_{1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq56.gif"/></alternatives></inline-formula> corresponds to solving a (conjugate-) <italic>transposed</italic> Maxwell problem with a “source” <inline-formula id="IEq57"><alternatives><mml:math id="IEq57_Math"><mml:msub><mml:mi mathvariant="bold">e</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math><tex-math id="IEq57_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {e}_{1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq57.gif"/></alternatives></inline-formula> at the <italic>output</italic> location, which is closely related to electromagnetic reciprocity (Chew <xref ref-type="bibr" rid="CR13">2008</xref>).</p><p id="Par15">Another important example where <inline-formula id="IEq58"><alternatives><mml:math id="IEq58_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq58_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq58.gif"/></alternatives></inline-formula> is low rank arises when the output <italic>P</italic> is the power in one (or more) orthogonal “wave channels” (Snyder and Love <xref ref-type="bibr" rid="CR81">1983</xref>), such as waveguide modes, planewave directions (e.g., diffraction orders), or spherical waves. In such cases, the power in a given channel can be computed by squaring a <italic>mode-overlap integral</italic> (e.g., a Fourier component for planewaves) of the form <inline-formula id="IEq59"><alternatives><mml:math id="IEq59_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:msubsup><mml:mi mathvariant="bold">o</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:msup><mml:mrow><mml:mi mathvariant="bold">u</mml:mi><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:math><tex-math id="IEq59_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\Vert \mathbf {o}_{1}^{\dagger} \mathbf {u} \Vert ^{2}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq59.gif"/></alternatives></inline-formula> (Snyder and Love <xref ref-type="bibr" rid="CR81">1983</xref>). Exactly as in the single-point case above, this corresponds to a rank-1 matrix <inline-formula id="IEq60"><alternatives><mml:math id="IEq60_Math"><mml:mrow><mml:mi>O</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msubsup><mml:mi mathvariant="bold">o</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mo>†</mml:mo></mml:msubsup></mml:mrow></mml:math><tex-math id="IEq60_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$O = \mathbf {o}_{1}\mathbf {o}_{1}^{\dagger}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq60.gif"/></alternatives></inline-formula> and one must solve only a single “reciprocal” scattering problem to obtain the trace, where the “source” term is the (conjugated) <italic>output</italic> mode <inline-formula id="IEq61"><alternatives><mml:math id="IEq61_Math"><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math><tex-math id="IEq61_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {o}_{1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq61.gif"/></alternatives></inline-formula>. This is precisely the situation in Kirchhoff’s law, where in order to compute the average thermal radiation (emissivity) in a given direction, one solves a reciprocal problem for the absorption of an incident planewave in the opposite direction (the absorptivity) (Reif <xref ref-type="bibr" rid="CR74">1965</xref>; Greffet et al. <xref ref-type="bibr" rid="CR25">2018</xref>; Janssen et al. <xref ref-type="bibr" rid="CR32">2010</xref>). A similar technique was recently applied to optimize the average power emitted in the normal direction from a scintillation device (Roques-Carmes et al. <xref ref-type="bibr" rid="CR79">2021</xref>).</p><p id="Par16">More generally, such cases correspond to an output quadratic form <inline-formula id="IEq62"><alternatives><mml:math id="IEq62_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq62_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq62.gif"/></alternatives></inline-formula> that takes a low-rank (Lax <xref ref-type="bibr" rid="CR49">2013</xref>) form:<disp-formula id="Equ10"><label>10</label><alternatives><mml:math display="block" id="Equ10_Math"><mml:mrow><mml:mi mathvariant="bold">O</mml:mi><mml:mo>=</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msubsup><mml:mi mathvariant="bold">o</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ10_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O} = \sum _{i=1}^{K} \mathbf {o}_{i}\mathbf {o}_{i}^{\dagger} ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ10.gif"/></alternatives></disp-formula>where <italic>K</italic> is the number of rank-1 terms <inline-formula id="IEq63"><alternatives><mml:math id="IEq63_Math"><mml:mrow><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msubsup><mml:mi mathvariant="bold">o</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup></mml:mrow></mml:math><tex-math id="IEq63_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {o}_{i}\mathbf {o}_{i}^{\dagger}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq63.gif"/></alternatives></inline-formula> (e.g., output channels/ports, output points, or other “overlap integrals”). Substituting Eq. (<xref rid="Equ10" ref-type="disp-formula">10</xref>) into Eq. (<xref rid="Equ7" ref-type="disp-formula">7</xref>) and applying the cyclic-trace identity, we obtain<disp-formula id="Equ11"><label>11</label><alternatives><mml:math display="block" id="Equ11_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msubsup><mml:mi mathvariant="bold">o</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi></mml:mfenced></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msubsup><mml:mi mathvariant="bold">o</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msubsup><mml:mi mathvariant="bold">v</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:msub><mml:mi mathvariant="bold">v</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msup><mml:mrow><mml:mo stretchy="false">‖</mml:mo><mml:msub><mml:mi mathvariant="bold">v</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ11_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \langle P \rangle= &amp; {} \sum _{i=1}^{K}{\text {tr}}\left[ (\mathbf {A}^{-1}\mathbf {D})^{\dagger} \mathbf {o}_{i}\mathbf {o}_{i}^{\dagger} \mathbf {A}^{-1}\mathbf {D}\right] \\= &amp; {} \sum _{i=1}^{K}\mathbf {o}_{i}^{\dagger} \mathbf {A}^{-1}\mathbf {D}(\mathbf {A}^{-1}\mathbf {D})^{\dagger} \mathbf {o}_{i} \\= &amp; {} \sum _{i=1}^{K} \mathbf {v}_{i}^{\dagger} \mathbf {v}_{i} = \sum _{i=1}^{K} \Vert \mathbf {v}_{i} \Vert ^{2}, \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ11.gif"/></alternatives></disp-formula>where<disp-formula id="Equ12"><label>12</label><alternatives><mml:math display="block" id="Equ12_Math"><mml:mrow><mml:msub><mml:mi mathvariant="bold">v</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math><tex-math id="Equ12_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {v}_{i}=\mathbf {D}^{\dagger} \mathbf {A}^{-\dagger }\mathbf {o}_{i}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ12.gif"/></alternatives></disp-formula>corresponds to a single “reciprocal” Maxwell solve <inline-formula id="IEq64"><alternatives><mml:math id="IEq64_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>A</mml:mi><mml:mrow><mml:mo>-</mml:mo><mml:mi>T</mml:mi></mml:mrow></mml:msup><mml:msubsup><mml:mi mathvariant="bold">o</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:math><tex-math id="IEq64_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-\dagger }\mathbf {o}_{i} = (A^{-T} \mathbf {o}_{i}^{*})^{*}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq64.gif"/></alternatives></inline-formula> (a single scattering problem) for each <italic>i</italic>. (Electromagnetic reciprocity simply corresponds to the fact that <inline-formula id="IEq65"><alternatives><mml:math id="IEq65_Math"><mml:mrow><mml:msup><mml:mi>A</mml:mi><mml:mi>T</mml:mi></mml:msup><mml:mo>=</mml:mo><mml:mi>A</mml:mi></mml:mrow></mml:math><tex-math id="IEq65_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$A^{T} = A$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq65.gif"/></alternatives></inline-formula> for reciprocal materials Chew <xref ref-type="bibr" rid="CR13">2008</xref>.) Hence, the full trace—the average emission into <italic>K</italic> channels—can be computed with only <italic>K</italic> solves, and in many such cases <inline-formula id="IEq66"><alternatives><mml:math id="IEq66_Math"><mml:mrow><mml:mi>K</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><tex-math id="IEq66_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$K=1$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq66.gif"/></alternatives></inline-formula>.</p></sec><sec id="Sec6"><title>Trace computation: few input channels</title><p id="Par17">One trivial special case in which the trace computation drastically simplifies is that of only a few sources or a few input channels, most famously in the case of the local density of states (LDOS): emission by a molecule at a <italic>single</italic> location in space but with a random polarization (Milonni <xref ref-type="bibr" rid="CR58">1976</xref>; Oskooi and Johnson <xref ref-type="bibr" rid="CR65">2013</xref>). In the case of LDOS, this reduces the trace computation to three Maxwell solves, one per principal polarization direction, making the problem directly tractable for topology optimization (Liang and Johnson <xref ref-type="bibr" rid="CR52">2013</xref>; Wang et al. <xref ref-type="bibr" rid="CR88">2018</xref>; Yao et al. <xref ref-type="bibr" rid="CR91">2020</xref>). More generally, this situation corresponds to the correlation matrix <inline-formula id="IEq67"><alternatives><mml:math id="IEq67_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq67_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq67.gif"/></alternatives></inline-formula> being low-rank: if <inline-formula id="IEq68"><alternatives><mml:math id="IEq68_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq68_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq68.gif"/></alternatives></inline-formula> is rank <italic>K</italic>, we can compute the trace in <italic>K</italic> solves.</p><p id="Par18">In particular, suppose that the currents <inline-formula id="IEq69"><alternatives><mml:math id="IEq69_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq69_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq69.gif"/></alternatives></inline-formula> are of the form <inline-formula id="IEq70"><alternatives><mml:math id="IEq70_Math"><mml:mrow><mml:mi mathvariant="bold">b</mml:mi><mml:mo>=</mml:mo><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>β</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi mathvariant="bold">b</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math><tex-math id="IEq70_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b} = \sum _{i=1}^{K} \beta _{i} \mathbf {b}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq70.gif"/></alternatives></inline-formula> where the <inline-formula id="IEq71"><alternatives><mml:math id="IEq71_Math"><mml:msub><mml:mi mathvariant="bold">b</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><tex-math id="IEq71_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq71.gif"/></alternatives></inline-formula> are “input channel” basis functions (e.g., a point source with a particular orientation, or an equivalent-current source for a waveguide mode Oskooi and Johnson <xref ref-type="bibr" rid="CR65">2013</xref>) and <inline-formula id="IEq72"><alternatives><mml:math id="IEq72_Math"><mml:msub><mml:mi>β</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><tex-math id="IEq72_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta _{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq72.gif"/></alternatives></inline-formula> are uncorrelated random numbers with zero mean and unit mean-square. Then the correlation matrix <inline-formula id="IEq73"><alternatives><mml:math id="IEq73_Math"><mml:mrow><mml:mi mathvariant="bold">B</mml:mi><mml:mo>=</mml:mo><mml:mo stretchy="false">⟨</mml:mo><mml:mi mathvariant="bold">b</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mo stretchy="false">⟩</mml:mo></mml:mrow></mml:math><tex-math id="IEq73_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B} = \langle \mathbf {b} \mathbf {b}^{\dagger} \rangle$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq73.gif"/></alternatives></inline-formula> is simply the rank-<italic>K</italic> matrix <inline-formula id="IEq74"><alternatives><mml:math id="IEq74_Math"><mml:mrow><mml:mi mathvariant="bold">B</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mo>∑</mml:mo><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi mathvariant="bold">b</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msubsup><mml:mi mathvariant="bold">b</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup></mml:mrow></mml:math><tex-math id="IEq74_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B} = \sum _{i} \mathbf {b}_{i} \mathbf {b}_{i}^{\dagger}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq74.gif"/></alternatives></inline-formula>. In this case, the trace simplifies to<disp-formula id="Equ13"><label>13</label><alternatives><mml:math display="block" id="Equ13_Math"><mml:mrow><mml:mtext>tr</mml:mtext><mml:mi mathvariant="bold">H</mml:mi><mml:mo>=</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msubsup><mml:mi mathvariant="bold">u</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:mi mathvariant="bold">O</mml:mi><mml:msub><mml:mi mathvariant="bold">u</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ13_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\text {tr}}\mathbf {H}= \sum _{i=1}^{K} \mathbf {u}_{i}^{\dagger} \mathbf {O}\mathbf {u}_{i} ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ13.gif"/></alternatives></disp-formula>where computing <inline-formula id="IEq75"><alternatives><mml:math id="IEq75_Math"><mml:mrow><mml:msub><mml:mi mathvariant="bold">u</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msub><mml:mi mathvariant="bold">b</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math><tex-math id="IEq75_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {u}_{i}=\mathbf {A}^{-1}\mathbf {b}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq75.gif"/></alternatives></inline-formula> again requires only <italic>K</italic> solves, one per source <inline-formula id="IEq76"><alternatives><mml:math id="IEq76_Math"><mml:msub><mml:mi mathvariant="bold">b</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><tex-math id="IEq76_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq76.gif"/></alternatives></inline-formula>.</p></sec><sec id="Sec7"><title>Trace computation: many output channels</title><p id="Par19">In general, neither the matrix <inline-formula id="IEq77"><alternatives><mml:math id="IEq77_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq77_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq77.gif"/></alternatives></inline-formula> nor the matrix <inline-formula id="IEq78"><alternatives><mml:math id="IEq78_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq78_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq78.gif"/></alternatives></inline-formula> are low rank—for example, one may be interested in the total power radiated into a <italic>continuum</italic> of angles above a surface, or some other infinite set of possible far-field distributions, from sources distributed over a continuous spatial region. Fortunately, it turns out that there is another structure we can exploit: the Hermitian matrix <inline-formula id="IEq79"><alternatives><mml:math id="IEq79_Math"><mml:mrow><mml:mi mathvariant="bold">H</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><tex-math id="IEq79_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H} = (\mathbf {A}^{-1} \mathbf {D})^{\dagger} \mathbf {O} (\mathbf {A}^{-1} \mathbf {D})$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq79.gif"/></alternatives></inline-formula> from Eq. (<xref rid="Equ7" ref-type="disp-formula">7</xref>) is itself typically <italic>approximately low rank</italic> (“numerically low rank” Markovsky <xref ref-type="bibr" rid="CR55">2012</xref>) even if <inline-formula id="IEq80"><alternatives><mml:math id="IEq80_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq80_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq80.gif"/></alternatives></inline-formula> is not: the trace, which is equal to the sum of the eigenvalues of <inline-formula id="IEq81"><alternatives><mml:math id="IEq81_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq81_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq81.gif"/></alternatives></inline-formula> (Lax <xref ref-type="bibr" rid="CR49">2013</xref>), is <italic>dominated by a few of</italic><inline-formula id="IEq82"><alternatives><mml:math id="IEq82_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq82_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq82.gif"/></alternatives></inline-formula>’s <italic>largest eigenvalues</italic>. In this section, we first explain why that is the case, and then show how it can be exploited to efficiently estimate the trace during optimization.</p><p id="Par20">There are two reasons to expect approximate low-rank structure of <inline-formula id="IEq83"><alternatives><mml:math id="IEq83_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq83_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq83.gif"/></alternatives></inline-formula> (which we illustrate with numerical examples in Sect. <xref rid="Sec9" ref-type="sec">4</xref>). First, on physical grounds, emission enhancement arises due to resonances (via the Purcell effect) (Agio and Cano <xref ref-type="bibr" rid="CR2">2013</xref>), but in any finite volume there is some limit to the number of resonances that can interact strongly with emitters in a given bandwidth, related to an average density of states (Yu et al. <xref ref-type="bibr" rid="CR92">2010</xref>). The traditional definition of resonant modes corresponds to poles of <inline-formula id="IEq84"><alternatives><mml:math id="IEq84_Math"><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math><tex-math id="IEq84_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq84.gif"/></alternatives></inline-formula> at complex resonant frequencies, which are (linear or nonlinear) eigenvalues <inline-formula id="IEq85"><alternatives><mml:math id="IEq85_Math"><mml:mi>ω</mml:mi></mml:math><tex-math id="IEq85_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\omega$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq85.gif"/></alternatives></inline-formula> satisfying <inline-formula id="IEq86"><alternatives><mml:math id="IEq86_Math"><mml:mrow><mml:mo movablelimits="true">det</mml:mo><mml:mi>A</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ω</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math><tex-math id="IEq86_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\det A(\omega )=0$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq86.gif"/></alternatives></inline-formula> (Nussenzveig <xref ref-type="bibr" rid="CR63">1972</xref>); analogously, Eq. (<xref rid="Equ7" ref-type="disp-formula">7</xref>) decomposes the total power into a sum of eigenvalues corresponding to “resonant current” sources which diagonalize <inline-formula id="IEq87"><alternatives><mml:math id="IEq87_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq87_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq87.gif"/></alternatives></inline-formula> at a given frequency. More explicitly, if <inline-formula id="IEq88"><alternatives><mml:math id="IEq88_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi></mml:mrow></mml:math><tex-math id="IEq88_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-1}\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq88.gif"/></alternatives></inline-formula> can be accurately approximated by the action of <italic>K</italic> resonances of <inline-formula id="IEq89"><alternatives><mml:math id="IEq89_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq89_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq89.gif"/></alternatives></inline-formula> (a quasinormal mode expansion Lalanne et al. <xref ref-type="bibr" rid="CR46">2018</xref>; Ge et al. <xref ref-type="bibr" rid="CR21">2014</xref>), so that <inline-formula id="IEq90"><alternatives><mml:math id="IEq90_Math"><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math><tex-math id="IEq90_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq90.gif"/></alternatives></inline-formula> can be replaced by a rank-<italic>K</italic> matrix, it follows that <inline-formula id="IEq91"><alternatives><mml:math id="IEq91_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq91_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq91.gif"/></alternatives></inline-formula> is also approximately rank <inline-formula id="IEq92"><alternatives><mml:math id="IEq92_Math"><mml:mrow><mml:mo>≤</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:math><tex-math id="IEq92_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\le K$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq92.gif"/></alternatives></inline-formula> (since it is a product of rank-deficient matrices Lax <xref ref-type="bibr" rid="CR49">2013</xref>). Moreover, geometric optimization to maximize the emitted power modifies the structure to further enhance one or more resonances (Liang and Johnson <xref ref-type="bibr" rid="CR52">2013</xref>), and we observe that this sometimes increases the concentration of the trace into a few eigenvalues of <inline-formula id="IEq93"><alternatives><mml:math id="IEq93_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq93_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq93.gif"/></alternatives></inline-formula>; that is, optimized structures tend to be even lower rank. Second, in a more general mathematical sense, the matrix <inline-formula id="IEq94"><alternatives><mml:math id="IEq94_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq94_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq94.gif"/></alternatives></inline-formula> is built from <italic>off-diagonal blocks</italic> of the Green’s function matrix <inline-formula id="IEq95"><alternatives><mml:math id="IEq95_Math"><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math><tex-math id="IEq95_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq95.gif"/></alternatives></inline-formula>, connecting sources (at the the support of <inline-formula id="IEq96"><alternatives><mml:math id="IEq96_Math"><mml:mi mathvariant="bold">D</mml:mi></mml:math><tex-math id="IEq96_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq96.gif"/></alternatives></inline-formula>) to emitted power at some other location (the support of <inline-formula id="IEq97"><alternatives><mml:math id="IEq97_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq97_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq97.gif"/></alternatives></inline-formula>, e.g., where the Poynting flux is computed), and off-diagonal blocks of Green’s functions are known to be approximately low-rank (Hackbusch <xref ref-type="bibr" rid="CR26">2015</xref>). This is closely related to fast methods for integral equations, such as the fast-multipole method and others (Gibson <xref ref-type="bibr" rid="CR23">2021</xref>); essentially, far fields mostly depend on low-order spatial moments of the near fields/currents.</p><p id="Par21">If <inline-formula id="IEq98"><alternatives><mml:math id="IEq98_Math"><mml:mrow><mml:mtext>tr</mml:mtext><mml:mi mathvariant="bold">H</mml:mi></mml:mrow></mml:math><tex-math id="IEq98_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\text {tr}}\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq98.gif"/></alternatives></inline-formula> is dominated by <inline-formula id="IEq99"><alternatives><mml:math id="IEq99_Math"><mml:mrow><mml:mi>K</mml:mi><mml:mo>≪</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:math><tex-math id="IEq99_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$K \ll N$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq99.gif"/></alternatives></inline-formula> the largest eigenvalues of the <inline-formula id="IEq100"><alternatives><mml:math id="IEq100_Math"><mml:mrow><mml:mi>N</mml:mi><mml:mo>×</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:math><tex-math id="IEq100_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N \times N$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq100.gif"/></alternatives></inline-formula> matrix <inline-formula id="IEq101"><alternatives><mml:math id="IEq101_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq101_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq101.gif"/></alternatives></inline-formula>, then one merely needs a numerical algorithm to compute the <italic>K</italic><italic>extremal</italic> (largest magnitude) eigenvalues using only a sequence matrix–vector products <inline-formula id="IEq102"><alternatives><mml:math id="IEq102_Math"><mml:mrow><mml:mi mathvariant="bold">H</mml:mi><mml:mi mathvariant="bold">v</mml:mi></mml:mrow></mml:math><tex-math id="IEq102_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}\mathbf {v}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq102.gif"/></alternatives></inline-formula> (corresponding to individual scattering problems). Fortunately, there are many such algorithms, especially for Hermitian <inline-formula id="IEq103"><alternatives><mml:math id="IEq103_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq103_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq103.gif"/></alternatives></inline-formula> (Lanczos <xref ref-type="bibr" rid="CR47">1950</xref>; Knyazev <xref ref-type="bibr" rid="CR42">2001</xref>), and one can simply increase <italic>K</italic> until the trace converges to any desired tolerance. We argue here that methods based on Rayleigh-quotient maximization are particularly attractive for inverse design because they can be <italic>combined</italic> with geometric/topology optimization. The key fact is that one can express the sum of the largest <italic>K</italic> eigenvalues as the maximum of a block Rayleigh quotient (Li <xref ref-type="bibr" rid="CR51">2015</xref>; Johnson and Joannopoulos <xref ref-type="bibr" rid="CR37">2001</xref>; Knyazev <xref ref-type="bibr" rid="CR42">2001</xref>; Kokiopoulou et al. <xref ref-type="bibr" rid="CR43">2011</xref>), and for positive semidefinite <inline-formula id="IEq104"><alternatives><mml:math id="IEq104_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq104_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq104.gif"/></alternatives></inline-formula> (<inline-formula id="IEq105"><alternatives><mml:math id="IEq105_Math"><mml:mo>=</mml:mo></mml:math><tex-math id="IEq105_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$=$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq105.gif"/></alternatives></inline-formula> positive semidefinite <inline-formula id="IEq106"><alternatives><mml:math id="IEq106_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq106_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq106.gif"/></alternatives></inline-formula>) this sum is a lower bound on the trace (Kokiopoulou et al. <xref ref-type="bibr" rid="CR43">2011</xref>):<disp-formula id="Equ14"><label>14</label><alternatives><mml:math display="block" id="Equ14_Math"><mml:mrow><mml:mtext>tr</mml:mtext><mml:mi mathvariant="bold">H</mml:mi><mml:mo>≥</mml:mo><mml:munder><mml:mo movablelimits="true">max</mml:mo><mml:mrow><mml:mi mathvariant="bold">V</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">C</mml:mi></mml:mrow><mml:mrow><mml:mi>N</mml:mi><mml:mo>×</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:munder><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mi mathvariant="bold">V</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mi mathvariant="bold">V</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">V</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">V</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ14_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\text {tr}}\mathbf {H}\ge \max _{\mathbf {V}\in {\mathbb {C}}^{N\times K}}{\text {tr}}\left[ (\mathbf {A}^{-1}\mathbf {D}\mathbf {V})^{\dagger} \mathbf {O}(\mathbf {A}^{-1}\mathbf {D}\mathbf {V})(\mathbf {V}^{\dagger} \mathbf {V})^{-1}\right] ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ14.gif"/></alternatives></disp-formula>where <inline-formula id="IEq107"><alternatives><mml:math id="IEq107_Math"><mml:mi mathvariant="bold">V</mml:mi></mml:math><tex-math id="IEq107_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq107.gif"/></alternatives></inline-formula> represents any <italic>K</italic>-dimensional subspace basis, so that one is maximizing the trace over all possible subspaces. This <inline-formula id="IEq108"><alternatives><mml:math id="IEq108_Math"><mml:mo>≥</mml:mo></mml:math><tex-math id="IEq108_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\ge$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq108.gif"/></alternatives></inline-formula> becomes equality for <inline-formula id="IEq109"><alternatives><mml:math id="IEq109_Math"><mml:mrow><mml:mi>N</mml:mi><mml:mo>=</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:math><tex-math id="IEq109_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N=K$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq109.gif"/></alternatives></inline-formula>, but in many problems (below), we find that <inline-formula id="IEq110"><alternatives><mml:math id="IEq110_Math"><mml:mrow><mml:mi>K</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>10</mml:mn></mml:mrow></mml:math><tex-math id="IEq110_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$K &lt; 10$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq110.gif"/></alternatives></inline-formula> suffices for <inline-formula id="IEq111"><alternatives><mml:math id="IEq111_Math"><mml:mrow><mml:mo>&lt;</mml:mo><mml:mn>1</mml:mn><mml:mo>%</mml:mo></mml:mrow></mml:math><tex-math id="IEq111_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$&lt; 1\%$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq111.gif"/></alternatives></inline-formula> error in the trace (and, as expected from the arguments above, we find in Sect. <xref rid="Sec10" ref-type="sec">4.1</xref> that the required <italic>K</italic> increases with the diameter of the emission region).</p><p id="Par22">Computationally, one can maximize the right-hand side of Eq. (<xref rid="Equ14" ref-type="disp-formula">14</xref>) by some form of gradient ascent (Li <xref ref-type="bibr" rid="CR51">2015</xref>; Knyazev <xref ref-type="bibr" rid="CR42">2001</xref>), each step of which only requires the evaluation of <inline-formula id="IEq112"><alternatives><mml:math id="IEq112_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mi mathvariant="bold">V</mml:mi></mml:mrow></mml:math><tex-math id="IEq112_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{-1}\mathbf {D}\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq112.gif"/></alternatives></inline-formula> for a <inline-formula id="IEq113"><alternatives><mml:math id="IEq113_Math"><mml:mrow><mml:mi>N</mml:mi><mml:mo>×</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:math><tex-math id="IEq113_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N \times K$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq113.gif"/></alternatives></inline-formula> matrix <inline-formula id="IEq114"><alternatives><mml:math id="IEq114_Math"><mml:mi mathvariant="bold">V</mml:mi></mml:math><tex-math id="IEq114_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq114.gif"/></alternatives></inline-formula>. That is to say, one only needs <italic>K</italic> Maxwell solves at each step (instead of <italic>N</italic> for the full matrix <inline-formula id="IEq115"><alternatives><mml:math id="IEq115_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq115_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq115.gif"/></alternatives></inline-formula>), which vastly reduces the computational cost.</p><p id="Par23">Moreover, this Rayleigh-quotient maximization formula is especially attractive in the context of inverse design, because it can be <italic>combined with the geometric optimization</italic> itself. That is, instead of “nesting” the trace computation inside a larger geometric optimization procedure, we can simply add <inline-formula id="IEq116"><alternatives><mml:math id="IEq116_Math"><mml:mi mathvariant="bold">V</mml:mi></mml:math><tex-math id="IEq116_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq116.gif"/></alternatives></inline-formula> to the geometry degrees of freedom and optimize over both <inline-formula id="IEq117"><alternatives><mml:math id="IEq117_Math"><mml:mi mathvariant="bold">V</mml:mi></mml:math><tex-math id="IEq117_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq117.gif"/></alternatives></inline-formula> and the geometry <italic>simultaneously</italic>. The full inverse-design problem with incoherent emission can now be bounded by a <italic>single</italic> optimization problem:<disp-formula id="Equ15"><label>15</label><alternatives><mml:math display="block" id="Equ15_Math"><mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mtext>optimum</mml:mtext></mml:msub><mml:mo>≥</mml:mo><mml:munder><mml:mo movablelimits="true">max</mml:mo><mml:mrow><mml:mtext>geometry</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="bold">V</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">C</mml:mi></mml:mrow><mml:mrow><mml:mi>N</mml:mi><mml:mo>×</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:munder><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mi mathvariant="bold">V</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">D</mml:mi><mml:mi mathvariant="bold">V</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">V</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">V</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ15_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle P \rangle _{\text{optimum}}\ge \max _{{\text{geometry}},\mathbf {V}\in {\mathbb {C}}^{N\times K}}{\text {tr}}\left[ (\mathbf {A}^{-1}\mathbf {D}\mathbf {V})^{\dagger} \mathbf {O}(\mathbf {A}^{-1}\mathbf {D}\mathbf {V})(\mathbf {V}^{\dagger} \mathbf {V})^{-1}\right] ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ15.gif"/></alternatives></disp-formula>where the geometric parameters (e.g., material densities Jensen and Sigmund <xref ref-type="bibr" rid="CR33">2011</xref> or level sets van Dijk et al. <xref ref-type="bibr" rid="CR19">2013</xref>) only affect <inline-formula id="IEq118"><alternatives><mml:math id="IEq118_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq118_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq118.gif"/></alternatives></inline-formula> and (perhaps) <inline-formula id="IEq119"><alternatives><mml:math id="IEq119_Math"><mml:mi mathvariant="bold">D</mml:mi></mml:math><tex-math id="IEq119_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq119.gif"/></alternatives></inline-formula>, and may be subject to some geometric and/or material constraints. The gradient of the right-hand side with respect to the geometry can be computed efficiently with adjoint methods (Molesky et al. <xref ref-type="bibr" rid="CR59">2018</xref>; Tortorelli and Michaleris <xref ref-type="bibr" rid="CR83">1994</xref>), whereas the gradient with respect to <inline-formula id="IEq120"><alternatives><mml:math id="IEq120_Math"><mml:mi mathvariant="bold">V</mml:mi></mml:math><tex-math id="IEq120_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq120.gif"/></alternatives></inline-formula> has a simple analytical formula (Johnson and Joannopoulos <xref ref-type="bibr" rid="CR37">2001</xref>) (“<xref rid="Sec16" ref-type="sec">Appendix 3</xref>”), so a variety of gradient-based optimization algorithms (Chong and Zak <xref ref-type="bibr" rid="CR14">2001</xref>) can be applied to simultaneously evolve both <inline-formula id="IEq121"><alternatives><mml:math id="IEq121_Math"><mml:mi mathvariant="bold">V</mml:mi></mml:math><tex-math id="IEq121_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq121.gif"/></alternatives></inline-formula> and the geometry. Furthermore, the Rayleigh quotient has the nice property that, since we are maximizing a lower bound on the full trace, the actual performance <inline-formula id="IEq122"><alternatives><mml:math id="IEq122_Math"><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow></mml:math><tex-math id="IEq122_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle P \rangle$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq122.gif"/></alternatives></inline-formula> is guaranteed to be at least as good as the estimated performance at every optimization step.</p></sec></sec><sec id="Sec8"><title>Topology-optimization formulation</title><p id="Par24">In this section, we briefly review the density-based TopOpt formulation (Jensen and Sigmund <xref ref-type="bibr" rid="CR33">2011</xref>) that we employ for our example applications in Sect. <xref rid="Sec9" ref-type="sec">4</xref>. The key idea of TopOpt is that an “artificial density” field, <inline-formula id="IEq123"><alternatives><mml:math id="IEq123_Math"><mml:mrow><mml:mi>ρ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>∈</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:math><tex-math id="IEq123_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho (\mathbf {x}) \in [0,1]$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq123.gif"/></alternatives></inline-formula>, is defined on a spatial “design” domain. This field is then filtered (to impose a non-strict minimum length scale) and thresholded (to mostly “binarize” the geometry, resulting in a physically admissible geometry). The resulting smoothed and thresholded field is then used to control the spatial material distribution, constituting the structure under design. The design field, <inline-formula id="IEq124"><alternatives><mml:math id="IEq124_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq124_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq124.gif"/></alternatives></inline-formula>, is discretized into a finite number of design degrees of freedom, which constitutes the design variables in the inverse-design problem to be solved, e.g., Eq. (<xref rid="Equ15" ref-type="disp-formula">15</xref>), using a finite-element method (FEM) on a triangular mesh (Badia and Verdugo <xref ref-type="bibr" rid="CR4">2020</xref>; Jin <xref ref-type="bibr" rid="CR34">2014</xref>), and the geometry is optimized using a well-known gradient-based algorithm that scales to high-dimensional problems with thousands or millions of degrees of freedom (Svanberg <xref ref-type="bibr" rid="CR82">2002</xref>).</p><p id="Par25">Given a density <inline-formula id="IEq125"><alternatives><mml:math id="IEq125_Math"><mml:mrow><mml:mi>ρ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>∈</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:math><tex-math id="IEq125_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho (\mathbf {x}) \in [0,1]$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq125.gif"/></alternatives></inline-formula>, one should first regularize the optimization problem by setting a non-strict minimum length scale <inline-formula id="IEq126"><alternatives><mml:math id="IEq126_Math"><mml:msub><mml:mi>r</mml:mi><mml:mtext>f</mml:mtext></mml:msub></mml:math><tex-math id="IEq126_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$r_{\text {f}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq126.gif"/></alternatives></inline-formula>, as otherwise one may obtain arbitrarily fine features as the spatial resolution is increased. This is achieved by convolving <inline-formula id="IEq127"><alternatives><mml:math id="IEq127_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq127_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq127.gif"/></alternatives></inline-formula> with a low-pass filter to obtain a smoothed density <inline-formula id="IEq128"><alternatives><mml:math id="IEq128_Math"><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:math><tex-math id="IEq128_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\tilde{\rho }$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq128.gif"/></alternatives></inline-formula> (Jensen and Sigmund <xref ref-type="bibr" rid="CR33">2011</xref>). There are many possible filtering algorithms, but in an FEM setting (with complicated nonuniform meshes), it is convenient to perform the smoothing by solving a simple “damped diffusion” PDE, also called a Helmholtz filter (Lazarov and Sigmund <xref ref-type="bibr" rid="CR50">2011</xref>):<disp-formula id="Equ16"><label>16</label><alternatives><mml:math display="block" id="Equ16_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mo>-</mml:mo><mml:msubsup><mml:mi>r</mml:mi><mml:mrow><mml:mtext>f</mml:mtext></mml:mrow><mml:mn>2</mml:mn></mml:msubsup><mml:msup><mml:mi mathvariant="normal">∇</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mo>+</mml:mo><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>=</mml:mo><mml:mi>ρ</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:msub><mml:mfenced close="|"><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi mathvariant="bold">n</mml:mi></mml:mrow></mml:mfrac></mml:mfenced><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>Ω</mml:mi><mml:mtext>D</mml:mtext></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ16_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} -r_{\text {f}}^{2}\nabla ^{2}\tilde{\rho }+\tilde{\rho }&amp;=\rho , \\ \left. \frac{\partial \tilde{\rho }}{\partial \mathbf {n}} \right| _{\partial \varOmega _{\text {D}}}&amp;=0 , \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ16.gif"/></alternatives></disp-formula>where <inline-formula id="IEq129"><alternatives><mml:math id="IEq129_Math"><mml:msub><mml:mi>r</mml:mi><mml:mtext>f</mml:mtext></mml:msub></mml:math><tex-math id="IEq129_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$r_{\text {f}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq129.gif"/></alternatives></inline-formula> is the length scale design parameter and <inline-formula id="IEq130"><alternatives><mml:math id="IEq130_Math"><mml:mi mathvariant="bold">n</mml:mi></mml:math><tex-math id="IEq130_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {n}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq130.gif"/></alternatives></inline-formula> is the normal vector at the boundary <inline-formula id="IEq131"><alternatives><mml:math id="IEq131_Math"><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>Ω</mml:mi><mml:mtext>D</mml:mtext></mml:msub></mml:mrow></mml:math><tex-math id="IEq131_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\partial \varOmega _{\text {D}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq131.gif"/></alternatives></inline-formula> of the design domain <inline-formula id="IEq132"><alternatives><mml:math id="IEq132_Math"><mml:msub><mml:mi>Ω</mml:mi><mml:mtext>D</mml:mtext></mml:msub></mml:math><tex-math id="IEq132_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varOmega _{\text {D}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq132.gif"/></alternatives></inline-formula>. This damped-diffusion filter essentially makes <inline-formula id="IEq133"><alternatives><mml:math id="IEq133_Math"><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:math><tex-math id="IEq133_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\tilde{\rho }$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq133.gif"/></alternatives></inline-formula> a weighted average of <inline-formula id="IEq134"><alternatives><mml:math id="IEq134_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq134_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq134.gif"/></alternatives></inline-formula> over a radius of roughly <inline-formula id="IEq135"><alternatives><mml:math id="IEq135_Math"><mml:msub><mml:mi>r</mml:mi><mml:mtext>f</mml:mtext></mml:msub></mml:math><tex-math id="IEq135_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$r_{\text {f}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq135.gif"/></alternatives></inline-formula> (Lazarov and Sigmund <xref ref-type="bibr" rid="CR50">2011</xref>). (In addition to this filtering, it is possible to impose additional fabrication/length scale constraints, for example to comply with semiconductor-foundry design rules Hammond et al. <xref ref-type="bibr" rid="CR27">2021</xref>.)</p><p id="Par26">Next, one employs a smooth threshold projection on the intermediate variable <inline-formula id="IEq136"><alternatives><mml:math id="IEq136_Math"><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:math><tex-math id="IEq136_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\tilde{\rho }$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq136.gif"/></alternatives></inline-formula> to obtain a “binarized” density parameter <inline-formula id="IEq137"><alternatives><mml:math id="IEq137_Math"><mml:mover accent="true"><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:math><tex-math id="IEq137_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\tilde{\tilde{\rho }}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq137.gif"/></alternatives></inline-formula> that tends towards values of 0 or 1 almost everywhere (Wang et al. <xref ref-type="bibr" rid="CR87">2010</xref>):<disp-formula id="Equ17"><label>17</label><alternatives><mml:math display="block" id="Equ17_Math"><mml:mrow><mml:mover accent="true"><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>tanh</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>β</mml:mi><mml:mi>η</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mo>tanh</mml:mo><mml:mfenced close=")" open="("><mml:mi>β</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mo>-</mml:mo><mml:mi>η</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mfenced></mml:mrow><mml:mrow><mml:mo>tanh</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>β</mml:mi><mml:mi>η</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mo>tanh</mml:mo><mml:mfenced close=")" open="("><mml:mi>β</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:mi>η</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mfenced></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ17_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\tilde{\tilde{\rho }} = \frac{\tanh (\beta \eta )+\tanh \left( \beta (\tilde{\rho }-\eta )\right) }{\tanh (\beta \eta )+\tanh \left( \beta (1-\eta )\right) },$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ17.gif"/></alternatives></disp-formula>where <inline-formula id="IEq138"><alternatives><mml:math id="IEq138_Math"><mml:mi>β</mml:mi></mml:math><tex-math id="IEq138_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq138.gif"/></alternatives></inline-formula> is a steepness parameter and <inline-formula id="IEq139"><alternatives><mml:math id="IEq139_Math"><mml:mrow><mml:mi>η</mml:mi><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn></mml:mrow></mml:math><tex-math id="IEq139_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\eta = 0.5$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq139.gif"/></alternatives></inline-formula> is the threshold. During optimization, one begins with a small value of <inline-formula id="IEq140"><alternatives><mml:math id="IEq140_Math"><mml:mi>β</mml:mi></mml:math><tex-math id="IEq140_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq140.gif"/></alternatives></inline-formula> (allowing smoothly varying structures) and then gradually increases <inline-formula id="IEq141"><alternatives><mml:math id="IEq141_Math"><mml:mi>β</mml:mi></mml:math><tex-math id="IEq141_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq141.gif"/></alternatives></inline-formula> to progressively binarize the structure (Christiansen and Sigmund <xref ref-type="bibr" rid="CR15">2021</xref>); here, we used <inline-formula id="IEq142"><alternatives><mml:math id="IEq142_Math"><mml:mrow><mml:mi>β</mml:mi><mml:mo>=</mml:mo><mml:mn>5</mml:mn><mml:mo>,</mml:mo><mml:mn>10</mml:mn><mml:mo>,</mml:mo><mml:mn>20</mml:mn><mml:mo>,</mml:mo><mml:mn>40</mml:mn><mml:mo>,</mml:mo><mml:mn>80</mml:mn></mml:mrow></mml:math><tex-math id="IEq142_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta =5,10,20,40,80$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq142.gif"/></alternatives></inline-formula>, similar to previous authors (Christiansen et al. <xref ref-type="bibr" rid="CR16">2020</xref>).</p><p id="Par27">Finally, one obtains a material, described by an electric relative permittivity (dielectric constant) <inline-formula id="IEq143"><alternatives><mml:math id="IEq143_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq143_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon (\mathbf {r})$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq143.gif"/></alternatives></inline-formula> in Eq. (<xref rid="Equ1" ref-type="disp-formula">1</xref>), given by<disp-formula id="Equ18"><label>18</label><alternatives><mml:math display="block" id="Equ18_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfenced close="]" open="["><mml:msub><mml:mi>ε</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>ε</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mi>ε</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mover accent="true"><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfenced><mml:mfenced close=")" open="("><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mfrac><mml:mtext>i</mml:mtext><mml:mrow><mml:mn>2</mml:mn><mml:mi>Q</mml:mi></mml:mrow></mml:mfrac></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ18_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon (\mathbf {r}) = \left[ \varepsilon _{1} +(\varepsilon _{2}-\varepsilon _{1})\tilde{\tilde{\rho }}(\mathbf {r})\right] \left( 1+\frac{{\text{i}}}{2Q}\right) ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ18.gif"/></alternatives></disp-formula>where <inline-formula id="IEq144"><alternatives><mml:math id="IEq144_Math"><mml:msub><mml:mi>ε</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math><tex-math id="IEq144_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon _{1}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq144.gif"/></alternatives></inline-formula> is the background material (usually air, <inline-formula id="IEq145"><alternatives><mml:math id="IEq145_Math"><mml:mrow><mml:msub><mml:mi>ε</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><tex-math id="IEq145_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon _{1}=1$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq145.gif"/></alternatives></inline-formula>) and <inline-formula id="IEq146"><alternatives><mml:math id="IEq146_Math"><mml:msub><mml:mi>ε</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:math><tex-math id="IEq146_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon _{2}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq146.gif"/></alternatives></inline-formula> is the design material (we use dielectric of <inline-formula id="IEq147"><alternatives><mml:math id="IEq147_Math"><mml:mrow><mml:msub><mml:mi>ε</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq147_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon _{2}=12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq147.gif"/></alternatives></inline-formula> throughout this work).</p><p id="Par28">Equation (<xref rid="Equ18" ref-type="disp-formula">18</xref>) includes an optional “artificial loss” term <inline-formula id="IEq148"><alternatives><mml:math id="IEq148_Math"><mml:mrow><mml:mo>∼</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:mi>Q</mml:mi></mml:mrow></mml:math><tex-math id="IEq148_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sim 1/ Q$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq148.gif"/></alternatives></inline-formula>, which effectively smooths out resonances to have quality factors <inline-formula id="IEq149"><alternatives><mml:math id="IEq149_Math"><mml:mrow><mml:mo>≤</mml:mo><mml:mi>Q</mml:mi></mml:mrow></mml:math><tex-math id="IEq149_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\le Q$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq149.gif"/></alternatives></inline-formula> (fractional bandwidth <inline-formula id="IEq150"><alternatives><mml:math id="IEq150_Math"><mml:mrow><mml:mo>≥</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:mi>Q</mml:mi></mml:mrow></mml:math><tex-math id="IEq150_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\ge 1/ Q$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq150.gif"/></alternatives></inline-formula>) (Liang and Johnson <xref ref-type="bibr" rid="CR52">2013</xref>). Such an artificial loss is useful in single-<inline-formula id="IEq151"><alternatives><mml:math id="IEq151_Math"><mml:mi>ω</mml:mi></mml:math><tex-math id="IEq151_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\omega$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq151.gif"/></alternatives></inline-formula> emission optimization in order to set a minimum bandwidth of enhanced emission, rather than obtaining diverging enhancement over an arbitrarily narrow bandwidth as is possible with lossless dielectric materials (Liang and Johnson <xref ref-type="bibr" rid="CR52">2013</xref>). Also, optimizing low-<italic>Q</italic> resonances often leads to better-behaved optimization problems (less “stiff” problems with faster convergence), so during optimization we start with a low <inline-formula id="IEq152"><alternatives><mml:math id="IEq152_Math"><mml:mrow><mml:mi>Q</mml:mi><mml:mo>=</mml:mo><mml:mn>5</mml:mn></mml:mrow></mml:math><tex-math id="IEq152_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$Q = 5$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq152.gif"/></alternatives></inline-formula> and geometrically increase it (to <inline-formula id="IEq153"><alternatives><mml:math id="IEq153_Math"><mml:mrow><mml:mi>Q</mml:mi><mml:mo>=</mml:mo><mml:mn>1000</mml:mn></mml:mrow></mml:math><tex-math id="IEq153_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$Q = 1000$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq153.gif"/></alternatives></inline-formula>) as the optimization progresses (Liang and Johnson <xref ref-type="bibr" rid="CR52">2013</xref>).</p><p id="Par29">The details of the FEM discretization are described in “<xref rid="Sec16" ref-type="sec">Appendix 3</xref>,” but it is essentially a standard triangular mesh with first-order Lagrange elements (Jin <xref ref-type="bibr" rid="CR34">2014</xref>) and perfectly matched layers (PMLs) for absorbing boundaries (Oskooi and Johnson <xref ref-type="bibr" rid="CR64">2011</xref>). We discretized <inline-formula id="IEq154"><alternatives><mml:math id="IEq154_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq154_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq154.gif"/></alternatives></inline-formula> and <inline-formula id="IEq155"><alternatives><mml:math id="IEq155_Math"><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mover accent="true"><mml:mi>ρ</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mo stretchy="false">~</mml:mo></mml:mover><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:math><tex-math id="IEq155_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\{{\tilde{\rho }},\tilde{{\tilde{\rho }}}\}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq155.gif"/></alternatives></inline-formula> with piecewise-constant (0th-order) and first-order elements, respectively. During optimization, one must ultimately compute the sensitivity of the objective function (the trace from Sect. <xref rid="Sec2" ref-type="sec">2</xref>) with respect to the degrees of freedom <inline-formula id="IEq156"><alternatives><mml:math id="IEq156_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq156_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq156.gif"/></alternatives></inline-formula>—for each step outlined above (smoothing, threshold, PDE solve, etcetera) we formulate a vector–Jacobian product following the adjoint method for sensitivity analysis (Molesky et al. <xref ref-type="bibr" rid="CR59">2018</xref>; Tortorelli and Michaleris <xref ref-type="bibr" rid="CR83">1994</xref>) with some help from automation (Revels et al. <xref ref-type="bibr" rid="CR75">2016</xref>), and then these are automatically composed (“backpropagated”) by an automatic-differentiation (AD) system (Innes <xref ref-type="bibr" rid="CR30">2018</xref>). In this way, the gradient with respect to all of the degrees of freedom (<inline-formula id="IEq157"><alternatives><mml:math id="IEq157_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq157_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq157.gif"/></alternatives></inline-formula> at every mesh element) can be computed with about the same cost as that of evaluating the objective function once (Molesky et al. <xref ref-type="bibr" rid="CR59">2018</xref>).</p></sec><sec id="Sec9"><title>Numerical examples</title><p id="Par30">In this section, we present three example problems in 2D illustrating how our trace-optimization procedure works in practice for typical problems involving ensembles of spatially incoherent emitters. We start in Sect. <xref rid="Sec10" ref-type="sec">4.1</xref> with a general case where we are maximizing the total emitted power from many emitters distributed throughout a “fluorescent” dielectric material. Next, in Sect. <xref rid="Sec11" ref-type="sec">4.2</xref>, we study the enhanced emission from a corrugated surface, analogous to a light-emitting diode (Erchak et al. <xref ref-type="bibr" rid="CR20">2001</xref>), showing how the trace formulation can be applied to a periodic structure with aperiodic emitters. Both of these examples are based on the general algorithm from Sect. <xref rid="Sec7" ref-type="sec">2.5</xref>, which can handle emission into a continuum of possible angles. Finally, in Sect. <xref rid="Sec12" ref-type="sec">4.3</xref>, we apply the more specialized algorithm from Sect. <xref rid="Sec5" ref-type="sec">2.3</xref> to optimizing emission from a fluorescent material into a single-mode waveguide. Since Maxwell’s equations are scale invariant (Joannopoulos et al. <xref ref-type="bibr" rid="CR35">2008</xref>), the same optimal designs will be obtained for any wavelength <inline-formula id="IEq158"><alternatives><mml:math id="IEq158_Math"><mml:mi>λ</mml:mi></mml:math><tex-math id="IEq158_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq158.gif"/></alternatives></inline-formula> if the geometry (thickness and period) is scaled with <inline-formula id="IEq159"><alternatives><mml:math id="IEq159_Math"><mml:mi>λ</mml:mi></mml:math><tex-math id="IEq159_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq159.gif"/></alternatives></inline-formula> (for the same dielectric constants).</p><sec id="Sec10"><title>Fluorescent particle</title><p id="Par31">In this example, illustrated in Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, we optimize the shape/topology of a 2D fluorescent dielectric (<inline-formula id="IEq166"><alternatives><mml:math id="IEq166_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq166_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon = 12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq166.gif"/></alternatives></inline-formula>) particle constrained to have a given area lying within a circular design domain of radius <italic>r</italic>, maximizing the total power <italic>P</italic> radiated outwards in <italic>any</italic> direction at a wavelength <inline-formula id="IEq167"><alternatives><mml:math id="IEq167_Math"><mml:mi>λ</mml:mi></mml:math><tex-math id="IEq167_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq167.gif"/></alternatives></inline-formula>. The emitters are distributed uniformly within the dielectric material. Further computational details can be found in “Appendix C.1.”<fig id="Fig1"><label>Fig. 1</label><caption xml:lang="en"><p><bold>a</bold> A 2D fluorescent particle (of dielectric <inline-formula id="IEq160"><alternatives><mml:math id="IEq160_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq160_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon =12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq160.gif"/></alternatives></inline-formula>) with a circular design domain of radius <italic>r</italic>. The emitters are distributed uniformly within the dielectric material. The total power <italic>P</italic> radiated outwards in <italic>any</italic> direction (integral of Poynting flux over <inline-formula id="IEq161"><alternatives><mml:math id="IEq161_Math"><mml:msub><mml:mi>Γ</mml:mi><mml:mtext>out</mml:mtext></mml:msub></mml:math><tex-math id="IEq161_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varGamma _{\text {out}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq161.gif"/></alternatives></inline-formula>) at a wavelength <inline-formula id="IEq162"><alternatives><mml:math id="IEq162_Math"><mml:mi>λ</mml:mi></mml:math><tex-math id="IEq162_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq162.gif"/></alternatives></inline-formula> is optimized. <bold>b</bold> Typical local optima found for design radius <inline-formula id="IEq163"><alternatives><mml:math id="IEq163_Math"><mml:mrow><mml:mi>r</mml:mi><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq163_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$r=0.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq163.gif"/></alternatives></inline-formula> with filling ratio <inline-formula id="IEq164"><alternatives><mml:math id="IEq164_Math"><mml:mrow><mml:msub><mml:mi>R</mml:mi><mml:mtext>f</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn></mml:mrow></mml:math><tex-math id="IEq164_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$R_{\text {f}}=0.5$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq164.gif"/></alternatives></inline-formula> and bandwidth quality factor <inline-formula id="IEq165"><alternatives><mml:math id="IEq165_Math"><mml:mrow><mml:mi>Q</mml:mi><mml:mo>=</mml:mo><mml:mn>1000</mml:mn></mml:mrow></mml:math><tex-math id="IEq165_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$Q=1000$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq165.gif"/></alternatives></inline-formula>. The numbers above denote the optimized emitting (average) power in arbitrary unit. <bold>c</bold> Emitted power of a disk as a function of the disk radius <italic>r</italic> for different bandwidth quality factors <italic>Q</italic>. <bold>d</bold> The number of eigenvalues that contribute 99% of the trace as a function of the disk radius <italic>r</italic> for different bandwidth quality factors <italic>Q</italic></p></caption><graphic specific-use="web" mime-subtype="PNG" xlink:href="MediaObjects/158_2022_3389_Fig1_HTML.png" id="MO19"/></fig></p><p id="Par32">Because this is a non-convex optimization problem, topology optimization can converge to different local optima from different initial geometries (Molesky et al. <xref ref-type="bibr" rid="CR59">2018</xref>). Figure <xref rid="Fig1" ref-type="fig">1</xref>b shows multiple local-optima geometries for a design radius <inline-formula id="IEq168"><alternatives><mml:math id="IEq168_Math"><mml:mrow><mml:mi>r</mml:mi><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq168_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$r=0.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq168.gif"/></alternatives></inline-formula> with filling ratio <inline-formula id="IEq169"><alternatives><mml:math id="IEq169_Math"><mml:mrow><mml:msub><mml:mi>R</mml:mi><mml:mtext>f</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn></mml:mrow></mml:math><tex-math id="IEq169_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$R_{\text {f}}=0.5$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq169.gif"/></alternatives></inline-formula> and bandwidth quality factor <inline-formula id="IEq170"><alternatives><mml:math id="IEq170_Math"><mml:mrow><mml:mi>Q</mml:mi><mml:mo>=</mml:mo><mml:mn>1000</mml:mn></mml:mrow></mml:math><tex-math id="IEq170_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$Q=1000$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq170.gif"/></alternatives></inline-formula> (artificial loss, from Sect. <xref rid="Sec8" ref-type="sec">3</xref>), obtained from different initial geometries (disks of different radii and/or <inline-formula id="IEq171"><alternatives><mml:math id="IEq171_Math"><mml:mi>ε</mml:mi></mml:math><tex-math id="IEq171_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq171.gif"/></alternatives></inline-formula>). The numbers above the geometries denote the corresponding emitted (average) power <italic>P</italic> in arbitrary units. In this particular case, after examining a large number of local optima (not shown), we found that the best local optimum is simply a circular disk with a particular radius. The existence of many local optima with performance varying by factors of 2–5 is not unusual in wave problems (Yao et al. <xref ref-type="bibr" rid="CR91">2020</xref>; Diaz and Sigmund <xref ref-type="bibr" rid="CR18">2010</xref>; Bermel et al. <xref ref-type="bibr" rid="CR8">2010</xref>), and while various heuristic strategies have been proposed to avoid poor local minima (Mutapcic et al. <xref ref-type="bibr" rid="CR61">2009</xref>; Aage and Egede Johansen <xref ref-type="bibr" rid="CR1">2017</xref>; Bermel et al. <xref ref-type="bibr" rid="CR8">2010</xref>; Schneider et al. <xref ref-type="bibr" rid="CR80">2019</xref>) beyond simply probing multiple random starting points, the only way to obtain rigorous guarantees is to derive theoretical upper bounds (Miller et al. <xref ref-type="bibr" rid="CR57">2016</xref>; Yao et al. <xref ref-type="bibr" rid="CR91">2020</xref>) as discussed further in Sect. <xref rid="Sec13" ref-type="sec">5</xref> (purely numerical global search can generally provide practical guarantees only for very low-dimensional Maxwell optimization Azunre et al. <xref ref-type="bibr" rid="CR3">2019</xref>).</p><p id="Par33">Whether the best optimum is a disk changes with the design-domain radius and appears to depend on whether there is a nearby radius with a high-<italic>Q</italic> resonance at the design <inline-formula id="IEq172"><alternatives><mml:math id="IEq172_Math"><mml:mi>λ</mml:mi></mml:math><tex-math id="IEq172_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq172.gif"/></alternatives></inline-formula>. (In fact, for this particular case, the locally optimal disk has an area slightly less than our upper bound, meaning that the area constraint is not active. In consequence, this particular disk remains a <italic>local</italic> optimum even if the design domain is enlarged, and apparently remains a global optimum until the design domain is sufficiently enlarged to admit a stronger resonance. Although the area constraint is not active at this particular local optimum, it is active at intermediate points during the optimization process, and there are many <italic>other</italic> local optima that would also be found if the area constraint were not present. Physically that emitted power can increased simply by adding more fluorescent material; correspondingly, without an area constraint we often find a local optimum in which the design region is almost entirely filled with dielectric.) In Fig. <xref rid="Fig1" ref-type="fig">1</xref>c, we show how the average power radiated by a circular disk varies with radius <inline-formula id="IEq173"><alternatives><mml:math id="IEq173_Math"><mml:mrow><mml:mi>r</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq173_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$r/\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq173.gif"/></alternatives></inline-formula> and clearly exhibits a series of sharp peaks correspond to radii which support high-<italic>Q</italic> resonances at <inline-formula id="IEq174"><alternatives><mml:math id="IEq174_Math"><mml:mi>λ</mml:mi></mml:math><tex-math id="IEq174_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq174.gif"/></alternatives></inline-formula>: the familiar whispering-gallery resonant modes (Yang et al. <xref ref-type="bibr" rid="CR90">2015</xref>).</p><p id="Par34">The key assumption of our algorithm in Sect. <xref rid="Sec7" ref-type="sec">2.5</xref> was that only a small number of eigenvalues would contribute to the trace, and this assumption clearly holds here. In Fig. <xref rid="Fig1" ref-type="fig">1</xref>d, we plot the number of eigenvalues that contribute 99% of the trace as a function of the disk radius. We can see that only a small number of eigenvalues is required to obtain a good estimate of the trace; we find similar results for other shapes. Naively, one might expect that the number of contributing eigenvalues would scale with the area (or volume in 3d), corresponding to the number of resonances per unit bandwidth from the density of states (DOS) (Yu et al. <xref ref-type="bibr" rid="CR92">2010</xref>). However, we find that the scaling is nearly linear with the disk radius; the reason the simple DOS argument fails is that it does  not take into account the variable loss (radiation) rates of the modes, which causes most of the resonances to contribute weakly even if the <italic>real</italic> part of their frequency is close to the emission frequency. In fact, we have found similar linear scaling of the number of contributing eigenvalues for many other shapes, including other locally optimized shapes, and it appears to be an interesting open theoretical question to prove (or disprove) asymptotic linear scaling.</p></sec><sec id="Sec11"><title>Periodic emitting surface</title><p id="Par35">In this example, we enhance the emission from a thin “emitting layer” by optimizing a periodically patterned surface situated on top of the layer—this is inspired by a light-emitting diode (LED) with a patterned surface above an active emitting layer, where it is well known that a periodic pattern can enhance emission via guided-mode resonances (Erchak et al. <xref ref-type="bibr" rid="CR20">2001</xref>; Noda and Fujita <xref ref-type="bibr" rid="CR62">2009</xref>). As illustrated in Fig. <xref rid="Fig2" ref-type="fig">2</xref>a, the design domain consists of dielectric material (<inline-formula id="IEq181"><alternatives><mml:math id="IEq181_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq181_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon = 12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq181.gif"/></alternatives></inline-formula>) in air with a period <italic>L</italic> and thickness <inline-formula id="IEq182"><alternatives><mml:math id="IEq182_Math"><mml:mrow><mml:msub><mml:mi>H</mml:mi><mml:mtext>d</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq182_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{\text {d}}=0.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq182.gif"/></alternatives></inline-formula>, the spontaneous-emission current sources are uniformly distributed on an horizontal line (“active layer”) inside a lower-index substrate (<inline-formula id="IEq183"><alternatives><mml:math id="IEq183_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>2.25</mml:mn></mml:mrow></mml:math><tex-math id="IEq183_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon =2.25$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq183.gif"/></alternatives></inline-formula>) a distance <inline-formula id="IEq184"><alternatives><mml:math id="IEq184_Math"><mml:mrow><mml:msub><mml:mi>H</mml:mi><mml:mtext>s</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.1</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq184_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{\text {s}}=0.1\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq184.gif"/></alternatives></inline-formula> below the design domain. The objective, here, is the total power emitted upwards, integrated over <italic>all angles</italic> (i.e., the total Poynting flux) using the methods of Sect. <xref rid="Sec7" ref-type="sec">2.5</xref>. (Emission purely into the normal direction could be optimized much more efficiently using the methods of Sect. <xref rid="Sec5" ref-type="sec">2.3</xref>.) Further computational details can be found in “Appendix C.2”.<fig id="Fig2"><label>Fig. 2</label><caption xml:lang="en"><p><bold>a</bold> Unit cell of a 2D periodic emitting surface with period <italic>L</italic>. The design domain consists of dielectric material (<inline-formula id="IEq175"><alternatives><mml:math id="IEq175_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq175_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon = 12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq175.gif"/></alternatives></inline-formula>) in air with thickness <inline-formula id="IEq176"><alternatives><mml:math id="IEq176_Math"><mml:mrow><mml:msub><mml:mi>H</mml:mi><mml:mtext>d</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq176_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{\text {d}}=0.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq176.gif"/></alternatives></inline-formula>, the spontaneous-emission current sources are uniformly distributed on an horizontal line (purple line) inside a lower-index substrate (<inline-formula id="IEq177"><alternatives><mml:math id="IEq177_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>2.25</mml:mn></mml:mrow></mml:math><tex-math id="IEq177_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon =2.25$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq177.gif"/></alternatives></inline-formula>) a distance <inline-formula id="IEq178"><alternatives><mml:math id="IEq178_Math"><mml:mrow><mml:msub><mml:mi>H</mml:mi><mml:mtext>s</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.1</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq178_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{\text {s}}=0.1\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq178.gif"/></alternatives></inline-formula> below the design domain. The objective is the total power emitted upwards, integrated over <inline-formula id="IEq179"><alternatives><mml:math id="IEq179_Math"><mml:mrow><mml:msub><mml:mi>Γ</mml:mi><mml:mtext>out</mml:mtext></mml:msub><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="IEq179_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varGamma _{\text {out}}.$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq179.gif"/></alternatives></inline-formula><bold>b</bold> Optimized geometry with period <inline-formula id="IEq180"><alternatives><mml:math id="IEq180_Math"><mml:mrow><mml:mi>L</mml:mi><mml:mo>=</mml:mo><mml:mn>0.6</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq180_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$L=0.6\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq180.gif"/></alternatives></inline-formula>. <bold>c</bold> The eigenvalue distribution of the average power for the optimized geometry</p></caption><graphic specific-use="web" mime-subtype="PNG" xlink:href="MediaObjects/158_2022_3389_Fig2_HTML.png" id="MO20"/></fig></p><p id="Par36">Even though the dielectric structure is periodic (the design domain is a single unit cell of <inline-formula id="IEq185"><alternatives><mml:math id="IEq185_Math"><mml:mi>ε</mml:mi></mml:math><tex-math id="IEq185_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq185.gif"/></alternatives></inline-formula>), the emitters are <italic>not</italic> periodic—they are independent random currents at every point in the active layer. Computationally, however, we can still reduce the simulation of <italic>non-periodic</italic> sources in a periodic medium to a set of small <italic>unit-cell simulations</italic>, using the “array-scanning method” (Capolino et al. <xref ref-type="bibr" rid="CR11">2007</xref>). An arbitrary aperiodic source current can be Fourier decomposed into a superposition of Bloch-periodic sources (<inline-formula id="IEq186"><alternatives><mml:math id="IEq186_Math"><mml:mrow><mml:msub><mml:mi mathvariant="bold">J</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>+</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mtext>i</mml:mtext><mml:mi>k</mml:mi><mml:mi>L</mml:mi></mml:mrow></mml:msup><mml:msub><mml:mi mathvariant="bold">J</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><tex-math id="IEq186_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {J}_{k}(x+L)=e^{{\text {i}}kL}\mathbf {J}_{k}(x)$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq186.gif"/></alternatives></inline-formula>), each of which can be simulated with a single unit cell and Bloch-periodic boundary conditions in <italic>x</italic>. The total power is then simply obtained from an integral (<inline-formula id="IEq187"><alternatives><mml:math id="IEq187_Math"><mml:mrow><mml:msubsup><mml:mo>∫</mml:mo><mml:mrow><mml:mo>-</mml:mo><mml:mi>π</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>L</mml:mi></mml:mrow><mml:mrow><mml:mi>π</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msubsup><mml:mrow><mml:mtext>d</mml:mtext><mml:mi>k</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><tex-math id="IEq187_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\int _{-\pi /L}^{\pi /L}{\text {d}}k)$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq187.gif"/></alternatives></inline-formula>) over the Bloch wavevector <italic>k</italic> in the Brillouin zone. For incoherent aperiodic random sources, <italic>each</italic> of these Bloch-periodic unit-cell calculations is an operator trace (over random currents in the unit cell only) computed by the methods of Sect. <xref rid="Sec2" ref-type="sec">2</xref>. (Unit-cell calculations for different <italic>k</italic> values are completely independent and can be performed in parallel.) Further details of this formulation are described in “Appendix C.2.” (Moreover, the array-scanning method can be viewed as a special case of a reduction using symmetry: for any symmetry group, sources can be decomposed into a superposition of “partner functions” of the irreducible representations of the symmetry group Inui et al. <xref ref-type="bibr" rid="CR31">2012</xref>, thus, reducing the simulation domain even for asymmetrical random sources.)</p><p id="Par37">The optimized structures for the design parameter <inline-formula id="IEq188"><alternatives><mml:math id="IEq188_Math"><mml:mrow><mml:msub><mml:mi>H</mml:mi><mml:mtext>d</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq188_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{\text {d}}=0.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq188.gif"/></alternatives></inline-formula>, <inline-formula id="IEq189"><alternatives><mml:math id="IEq189_Math"><mml:mrow><mml:msub><mml:mi>H</mml:mi><mml:mtext>s</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.1</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq189_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{\text {s}}=0.1\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq189.gif"/></alternatives></inline-formula> are shown in Fig. <xref rid="Fig2" ref-type="fig">2</xref>b. Note that we have also optimized over the period <italic>L</italic> (here, simply by repeating the optimization for different values of <italic>L</italic>) to find an optimized period <inline-formula id="IEq190"><alternatives><mml:math id="IEq190_Math"><mml:mrow><mml:mi>L</mml:mi><mml:mo>=</mml:mo><mml:mn>0.6</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq190_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$L=0.6\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq190.gif"/></alternatives></inline-formula>. The eigenvalue distribution of the average power is given in Fig. <xref rid="Fig2" ref-type="fig">2</xref>c: again, we observe that only the first few eigenvalues contribute significantly to the trace, as conjectured in Sect. <xref rid="Sec7" ref-type="sec">2.5</xref>.</p></sec><sec id="Sec12"><title>Emission into a waveguide</title><p id="Par38">This example considers a fluorescent dielectric (<inline-formula id="IEq199"><alternatives><mml:math id="IEq199_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq199_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon =12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq199.gif"/></alternatives></inline-formula>) medium in air, similar to Sect. <xref rid="Sec10" ref-type="sec">4.1</xref>, but in this case, we are maximizing the power coupled into a single-mode dielectric waveguide (<inline-formula id="IEq200"><alternatives><mml:math id="IEq200_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq200_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon =12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq200.gif"/></alternatives></inline-formula>, width <inline-formula id="IEq201"><alternatives><mml:math id="IEq201_Math"><mml:mrow><mml:mi>λ</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mn>2</mml:mn><mml:msqrt><mml:mn>12</mml:mn></mml:msqrt></mml:mrow></mml:math><tex-math id="IEq201_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda /2\sqrt{12}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq201.gif"/></alternatives></inline-formula>) rather than into radiation (Fig. <xref rid="Fig3" ref-type="fig">3</xref>a). Since the output is a single channel (<italic>O</italic> is rank 1), this allows us to apply the method of Sect. <xref rid="Sec5" ref-type="sec">2.3</xref> to perform only a single “reciprocal” Maxwell solve per optimization step. Since the waveguide breaks the rotational symmetry of the problem, the optimum structure is now very different from a circular disk, and must somehow redirect light emitted <italic>anywhere</italic> in the fluorescent material into the waveguide. This task is made more difficult by the fact that we employ a design domain of which size is only <inline-formula id="IEq202"><alternatives><mml:math id="IEq202_Math"><mml:mrow><mml:mn>1.5</mml:mn><mml:mi>λ</mml:mi><mml:mo>×</mml:mo><mml:mn>0.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq202_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$1.5\lambda \times 0.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq202.gif"/></alternatives></inline-formula>, so the optimization cannot simply surround the emitters with a multi-layer Bragg mirror to confine the radiation (as occurs when optimizing LDOS in a large design domain Liang and Johnson <xref ref-type="bibr" rid="CR52">2013</xref>; Wang et al. <xref ref-type="bibr" rid="CR88">2018</xref>). Further computational details can be found in “Appendix C.3.”<fig id="Fig3"><label>Fig. 3</label><caption xml:lang="en"><p><bold>a</bold> A 2D fluorescent dielectric (<inline-formula id="IEq191"><alternatives><mml:math id="IEq191_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq191_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon =12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq191.gif"/></alternatives></inline-formula>) medium coupling to a waveguide (<inline-formula id="IEq192"><alternatives><mml:math id="IEq192_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq192_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon =12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq192.gif"/></alternatives></inline-formula>, width <inline-formula id="IEq193"><alternatives><mml:math id="IEq193_Math"><mml:mrow><mml:mi>λ</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mn>2</mml:mn><mml:msqrt><mml:mn>12</mml:mn></mml:msqrt></mml:mrow></mml:math><tex-math id="IEq193_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda /2\sqrt{12}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq193.gif"/></alternatives></inline-formula>). The design domain is of height <inline-formula id="IEq194"><alternatives><mml:math id="IEq194_Math"><mml:mrow><mml:msub><mml:mi>H</mml:mi><mml:mtext>d</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>1.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq194_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{\text {d}}=1.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq194.gif"/></alternatives></inline-formula> and width <inline-formula id="IEq195"><alternatives><mml:math id="IEq195_Math"><mml:mrow><mml:msub><mml:mi>L</mml:mi><mml:mtext>d</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq195_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$L_{\text {d}}=0.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq195.gif"/></alternatives></inline-formula>, the power coupled into a single-mode dielectric waveguide (mode overlap integral at <inline-formula id="IEq196"><alternatives><mml:math id="IEq196_Math"><mml:msub><mml:mi>Γ</mml:mi><mml:mtext>out</mml:mtext></mml:msub></mml:math><tex-math id="IEq196_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varGamma _{\text {out}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq196.gif"/></alternatives></inline-formula>) is optimized. <bold>b</bold> Optimized shape with a filling ratio <inline-formula id="IEq197"><alternatives><mml:math id="IEq197_Math"><mml:mrow><mml:msub><mml:mi>R</mml:mi><mml:mtext>f</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn></mml:mrow></mml:math><tex-math id="IEq197_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$R_{\text {f}}=0.5$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq197.gif"/></alternatives></inline-formula>. <bold>c</bold> Averaged field intensity <inline-formula id="IEq198"><alternatives><mml:math id="IEq198_Math"><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:msup><mml:mo stretchy="false">|</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo stretchy="false">⟩</mml:mo></mml:mrow></mml:math><tex-math id="IEq198_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle \vert H_{z}\vert ^{2}\rangle$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq198.gif"/></alternatives></inline-formula> distribution. About 64% of the power is coupled into the waveguide mode</p></caption><graphic specific-use="web" mime-subtype="PNG" xlink:href="MediaObjects/158_2022_3389_Fig3_HTML.png" id="MO21"/></fig></p><p id="Par39">Figure <xref rid="Fig3" ref-type="fig">3</xref>b shows the optimized geometry with a design domain of height <inline-formula id="IEq203"><alternatives><mml:math id="IEq203_Math"><mml:mrow><mml:msub><mml:mi>H</mml:mi><mml:mtext>d</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>1.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq203_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{\text {d}}=1.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq203.gif"/></alternatives></inline-formula> and width <inline-formula id="IEq204"><alternatives><mml:math id="IEq204_Math"><mml:mrow><mml:msub><mml:mi>L</mml:mi><mml:mtext>d</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn><mml:mi>λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq204_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$L_{\text {d}}=0.5\lambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq204.gif"/></alternatives></inline-formula>. The material is constrained to fill at most half of the design domain (to illustrate that we can independently constrain the design region and the design volume); unlike for the disk optimum in Sect. <xref rid="Sec10" ref-type="sec">4.1</xref>, this area constraint was active at the optimum shown here. The corresponding averaged field intensity <inline-formula id="IEq205"><alternatives><mml:math id="IEq205_Math"><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:msup><mml:mo stretchy="false">|</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo stretchy="false">⟩</mml:mo></mml:mrow></mml:math><tex-math id="IEq205_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle \vert H_{z}\vert ^{2} \rangle$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq205.gif"/></alternatives></inline-formula> is displayed in Fig. <xref rid="Fig3" ref-type="fig">3</xref>c. We found that 64% of the power is coupled into the desired waveguide mode. In comparison, only 4% of the power is coupled to the waveguide mode for a trivial rectangular design where the the whole design domain is filled with <inline-formula id="IEq206"><alternatives><mml:math id="IEq206_Math"><mml:mrow><mml:mi>ε</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:math><tex-math id="IEq206_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon =12$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq206.gif"/></alternatives></inline-formula> fluorescent material.</p></sec></sec><sec id="Sec13" sec-type="conclusions"><title>Conclusion</title><p id="Par40">We presented a trace formulation and accompanying algorithms for topology optimization of incoherent emitters, which unify and generalize earlier work, and in particular provide the first tractable optimization algorithms for the challenging case of many random emitters and many output channels. Looking forward, we believe that there are many potential applications of these ideas, as well as further algorithmic improvements and generalizations.</p><p id="Par41">We are already preparing to use these techniques to optimize Raman sensing in fluid suspensions of many Raman molecules, in contrast to previous work that only considered a single-molecule location (Christiansen et al. <xref ref-type="bibr" rid="CR16">2020</xref>; Pan et al. <xref ref-type="bibr" rid="CR66">2021</xref>)—it will help us to answer the interesting open question of the optimal spatial density of “hot spots” where light is concentrated to enhance Raman emission. Another application is enhancing cathodoluminescence or other forms of scintillation detectors, which were previously optimized only for normal emission (Roques-Carmes et al. <xref ref-type="bibr" rid="CR79">2021</xref>). In contrast to spontaneous emission, where the light is emitted by spatially uncorrelated <italic>point</italic> sources, one can instead consider incoherent beams of light consisting of uncorrelated random <italic>planewave</italic> amplitudes—this corresponds to spatially <italic>correlated</italic> random currents (Wolf <xref ref-type="bibr" rid="CR89">2007</xref>), and we are investigating the resulting trace formulation to design metalenses for incoherent focusing. Other applications include the study of radiation loss due to surface roughness, which can be modeled via random sources with a prescribed correlation function related to the manufacturing disorder and may naively require a large number of Maxwell solves (Johnson et al. <xref ref-type="bibr" rid="CR39">2005</xref>; Kita et al. <xref ref-type="bibr" rid="CR41">2018</xref>; Payne and Lacey <xref ref-type="bibr" rid="CR68">1994</xref>). Nor is our approach limited to Maxwell’s equations—it is applicable to any linear system where one wishes to optimize quadratic functions of random source terms.</p><p id="Par42">Algorithmically, we are investigating ways to apply more sophisticated algorithms to the joint structure/trace-optimization problem equation (<xref rid="Equ15" ref-type="disp-formula">15</xref>). When solving the eigenproblem alone (maximizing over <inline-formula id="IEq207"><alternatives><mml:math id="IEq207_Math"><mml:mi mathvariant="bold">V</mml:mi></mml:math><tex-math id="IEq207_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq207.gif"/></alternatives></inline-formula> to obtain extremal eigenvalues), it is well known that one can greatly improve upon straightforward gradient ascent by Krylov algorithms such as Arnoldi (Trefethen and Bau <xref ref-type="bibr" rid="CR84">1997</xref>) or LOBPCG (Knyazev <xref ref-type="bibr" rid="CR42">2001</xref>), and we would like to incorporate Krylov acceleration into to joint problem as well. Recent techniques to accelerate frequency domain solves for multiple sparse inputs and outputs (Lin et al. <xref ref-type="bibr" rid="CR53">2022</xref>) may also be applicable to accelerate our trace optimization (since we have multiple sources in a sparse subset of the domain, and objective functions like the power only involve sparse outputs). Similar to the stochastic Lanczos algorithm (Ubaru et al. <xref ref-type="bibr" rid="CR86">2017</xref>), one could further exploit the fact that we are computing the trace of a function <inline-formula id="IEq208"><alternatives><mml:math id="IEq208_Math"><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">A</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq208_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f(\mathbf {A})$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq208.gif"/></alternatives></inline-formula> of the Maxwell operator <inline-formula id="IEq209"><alternatives><mml:math id="IEq209_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq209_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq209.gif"/></alternatives></inline-formula> in order to relate the trace more efficiently to Krylov subspaces of <inline-formula id="IEq210"><alternatives><mml:math id="IEq210_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq210_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq210.gif"/></alternatives></inline-formula>. More generally, there are other applications where one is maximizing <inline-formula id="IEq211"><alternatives><mml:math id="IEq211_Math"><mml:mrow><mml:mtext>tr</mml:mtext><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">A</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>p</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo><mml:mi>p</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq211_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\text {tr}}f(\mathbf {A}(p),p)$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq211.gif"/></alternatives></inline-formula> for some <italic>f</italic> and some parameters <italic>p</italic>, and it seems similarly beneficial to combine the trace estimation with the parameter optimization in such problems.</p><p id="Par43">Theoretically, it is desirable to complement improved numerical optimizations with new rigorous upper bounds on incoherent emission. Significant progress has already been made on bounding thermal-emission processes (Miller et al. <xref ref-type="bibr" rid="CR56">2015</xref>; Molesky et al. <xref ref-type="bibr" rid="CR60">2020</xref>) as well as to absorption (Kuang and Miller <xref ref-type="bibr" rid="CR45">2020</xref>; Miller et al. <xref ref-type="bibr" rid="CR57">2016</xref>) (related to emission via reciprocity), and many of these techniques should be adaptable to other forms of random emission.</p></sec></body><back><sec><title>Funding</title><p>Open Access funding provided by the MIT Libraries. This work was supported in part by the U.S. Army Research Office through the Institute for Soldier Nanotechnologies under Award W911NF-13-D-0001, and by the PAPPA Program of DARPA MTO under Award HR0011-20-90016. F. Verdugo acknowledges support from the Program Severo Ochoa Centre of Excellence (2019-2023) under the Grant CEX2018-000797-S funded by MCIN/AEI/10.13039/501100011033. R. E. Christiansen acknowledges support from the Danish National Research Foundation (Grant No. DNRF147 - NanoPhoton).</p></sec><sec sec-type="ethics-statement"><title>Declarations</title><sec id="FPar1" sec-type="COI-statement"><title>Conflict of interest</title><p id="Par44">On behalf of all authors, the corresponding author states that there is no conflict of interest.</p></sec><sec id="FPar2"><title>Replication of results</title><p id="Par45">The code for Sect. <xref rid="Sec9" ref-type="sec">4</xref> can be found at <ext-link xlink:href="https://github.com/WenjieYao/TraceFormula" ext-link-type="uri">https://github.com/WenjieYao/TraceFormula</ext-link>.</p></sec></sec><ref-list id="Bib1"><title>References</title><ref-list><ref id="CR1"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Aage</surname><given-names>N</given-names></name><name><surname>Egede Johansen</surname><given-names>V</given-names></name></person-group><article-title xml:lang="en">Topology optimization of microwave waveguide filters</article-title><source>Int J Numer Methods Eng</source><year>2017</year><volume>112</volume><issue>3</issue><fpage>283</fpage><lpage>300</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">3708479</pub-id><pub-id pub-id-type="doi">10.1002/nme.5551</pub-id></mixed-citation></ref><ref id="CR2"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Agio</surname><given-names>M</given-names></name><name><surname>Cano</surname><given-names>DM</given-names></name></person-group><article-title xml:lang="en">The Purcell factor of nanoresonators</article-title><source>Nat Photonics</source><year>2013</year><volume>7</volume><fpage>674</fpage><lpage>675</lpage><pub-id pub-id-type="doi">10.1038/nphoton.2013.219</pub-id></mixed-citation></ref><ref id="CR3"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Azunre</surname><given-names>P</given-names></name><name><surname>Jean</surname><given-names>J</given-names></name><name><surname>Rotschild</surname><given-names>C</given-names></name><name><surname>Bulovic</surname><given-names>V</given-names></name><name><surname>Johnson</surname><given-names>S</given-names></name><name><surname>Baldo</surname><given-names>M</given-names></name></person-group><article-title xml:lang="en">Guaranteed global optimization of thin-film optical systems</article-title><source>N J Phys</source><year>2019</year><volume>21</volume><fpage>073050</fpage><pub-id pub-id-type="doi">10.1088/1367-2630/ab2e19</pub-id></mixed-citation></ref><ref id="CR4"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Badia</surname><given-names>S</given-names></name><name><surname>Verdugo</surname><given-names>F</given-names></name></person-group><article-title xml:lang="en">Gridap: an extensible finite element toolbox in Julia</article-title><source>J Open Source Softw</source><year>2020</year><volume>5</volume><issue>52</issue><fpage>2520</fpage><pub-id pub-id-type="doi">10.21105/joss.02520</pub-id></mixed-citation></ref><ref id="CR5"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bao</surname><given-names>G</given-names></name><name><surname>Cao</surname><given-names>Y</given-names></name><name><surname>Lin</surname><given-names>J</given-names></name><etal/></person-group><article-title xml:lang="en">Computational optimal design of random rough surfaces in thin-film solar cells</article-title><source>Commun Comput Phys</source><year>2019</year><volume>25</volume><fpage>1591</fpage><lpage>1612</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">3899447</pub-id><pub-id pub-id-type="doi">10.4208/cicp.OA-2018-0013</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1479.35248</pub-id></mixed-citation></ref><ref id="CR6"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Basu</surname><given-names>S</given-names></name><name><surname>Zhang</surname><given-names>ZM</given-names></name><name><surname>Fu</surname><given-names>CJ</given-names></name></person-group><article-title xml:lang="en">Review of near-field thermal radiation and its application to energy conversion</article-title><source>Int J Energy Res</source><year>2009</year><volume>33</volume><issue>13</issue><fpage>1203</fpage><lpage>1232</lpage><pub-id pub-id-type="doi">10.1002/er.1607</pub-id></mixed-citation></ref><ref id="CR7"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bayati</surname><given-names>E</given-names></name><name><surname>Pestourie</surname><given-names>R</given-names></name><name><surname>Colburn</surname><given-names>S</given-names></name><etal/></person-group><article-title xml:lang="en">Inverse designed extended depth of focus meta-optics for broadband imaging in the visible</article-title><source>Nanophotonics</source><year>2021</year><pub-id pub-id-type="doi">10.1515/nanoph-2021-0431</pub-id></mixed-citation></ref><ref id="CR8"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bermel</surname><given-names>P</given-names></name><name><surname>Ghebrebrhan</surname><given-names>M</given-names></name><name><surname>Chan</surname><given-names>W</given-names></name><etal/></person-group><article-title xml:lang="en">Design and global optimization of high-efficiency thermophotovoltaic systems</article-title><source>Opt Express</source><year>2010</year><volume>18</volume><fpage>A314</fpage><lpage>A334</lpage><pub-id pub-id-type="doi">10.1364/OE.18.00A314</pub-id></mixed-citation></ref><ref id="CR9"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bezanson</surname><given-names>J</given-names></name><name><surname>Edelman</surname><given-names>A</given-names></name><name><surname>Karpinski</surname><given-names>S</given-names></name><etal/></person-group><article-title xml:lang="en">Julia: a fresh approach to numerical computing</article-title><source>SIAM Rev</source><year>2017</year><volume>59</volume><issue>1</issue><fpage>65</fpage><lpage>98</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">3605826</pub-id><pub-id pub-id-type="doi">10.1137/141000671</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1356.68030</pub-id></mixed-citation></ref><ref id="CR10"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Brenny</surname><given-names>BJM</given-names></name><name><surname>Coenen</surname><given-names>T</given-names></name><name><surname>Polman</surname><given-names>A</given-names></name></person-group><article-title xml:lang="en">Quantifying coherent and incoherent cathodoluminescence in semiconductors and metals</article-title><source>J Appl Phys</source><year>2014</year><volume>115</volume><issue>24</issue><fpage>244307</fpage><pub-id pub-id-type="doi">10.1063/1.4885426</pub-id></mixed-citation></ref><ref id="CR11"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Capolino</surname><given-names>F</given-names></name><name><surname>Jackson</surname><given-names>DR</given-names></name><name><surname>Wilton</surname><given-names>DR</given-names></name><etal/></person-group><article-title xml:lang="en">Comparison of methods for calculating the field excited by a dipole near a 2-D periodic material</article-title><source>IEEE Trans Antennas Propag</source><year>2007</year><volume>55</volume><issue>6</issue><fpage>1644</fpage><lpage>1655</lpage><pub-id pub-id-type="doi">10.1109/TAP.2007.897348</pub-id></mixed-citation></ref><ref id="CR12"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Carey</surname><given-names>VP</given-names></name><name><surname>Chen</surname><given-names>G</given-names></name><name><surname>Grigoropoulos</surname><given-names>C</given-names></name><etal/></person-group><article-title xml:lang="en">A review of heat transfer physics</article-title><source>Nanoscale Microscale Thermophys Eng</source><year>2008</year><volume>12</volume><issue>1</issue><fpage>1</fpage><lpage>60</lpage><pub-id pub-id-type="doi">10.1080/15567260801917520</pub-id></mixed-citation></ref><ref id="CR13"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chew</surname><given-names>WC</given-names></name></person-group><article-title xml:lang="en">A new kook at reciprocity and energy conservation theorems in electromagnetics</article-title><source>IEEE Trans Antennas Propag</source><year>2008</year><volume>56</volume><issue>4</issue><fpage>970</fpage><lpage>975</lpage><pub-id pub-id-type="doi">10.1109/TAP.2008.919189</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1369.78004</pub-id></mixed-citation></ref><ref id="CR14"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Chong</surname><given-names>EKP</given-names></name><name><surname>Zak</surname><given-names>SH</given-names></name></person-group><source>An introduction to optimization</source><year>2001</year><edition>2</edition><publisher-loc>New York</publisher-loc><publisher-name>Wiley-Interscience Publication</publisher-name><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1056.90129</pub-id></mixed-citation></ref><ref id="CR15"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Christiansen</surname><given-names>RE</given-names></name><name><surname>Sigmund</surname><given-names>O</given-names></name></person-group><article-title xml:lang="en">Inverse design in photonics by topology optimization: tutorial</article-title><source>J Opt Soc Am B</source><year>2021</year><volume>38</volume><issue>2</issue><fpage>496</fpage><lpage>509</lpage><pub-id pub-id-type="doi">10.1364/JOSAB.406048</pub-id></mixed-citation></ref><ref id="CR16"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Christiansen</surname><given-names>RE</given-names></name><name><surname>Michon</surname><given-names>J</given-names></name><name><surname>Benzaouia</surname><given-names>M</given-names></name><etal/></person-group><article-title xml:lang="en">Inverse design of nanoparticles for enhanced Raman scattering</article-title><source>Opt Express</source><year>2020</year><volume>28</volume><issue>4</issue><fpage>4444</fpage><lpage>4462</lpage><pub-id pub-id-type="doi">10.1364/OE.28.004444</pub-id></mixed-citation></ref><ref id="CR17"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Davis</surname><given-names>T</given-names></name></person-group><source>Direct methods for sparse linear systems</source><year>2006</year><publisher-loc>Philadelphia</publisher-loc><publisher-name>SIAM</publisher-name><pub-id pub-id-type="doi">10.1137/1.9780898718881</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1119.65021</pub-id></mixed-citation></ref><ref id="CR18"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Diaz</surname><given-names>AR</given-names></name><name><surname>Sigmund</surname><given-names>O</given-names></name></person-group><article-title xml:lang="en">A topology optimization method for design of negative permeability metamaterials</article-title><source>Struct Multidisc Optim</source><year>2010</year><volume>41</volume><fpage>163</fpage><lpage>177</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">2585857</pub-id><pub-id pub-id-type="doi">10.1007/s00158-009-0416-y</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1274.74262</pub-id></mixed-citation></ref><ref id="CR20"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Erchak</surname><given-names>AA</given-names></name><name><surname>Ripin</surname><given-names>DJ</given-names></name><name><surname>Fan</surname><given-names>S</given-names></name><etal/></person-group><article-title xml:lang="en">Enhanced coupling to vertical radiation using a two-dimensional photonic crystal in a semiconductor light-emitting diode</article-title><source>Appl Phys Lett</source><year>2001</year><volume>78</volume><issue>5</issue><fpage>563</fpage><lpage>565</lpage><pub-id pub-id-type="doi">10.1063/1.1342048</pub-id></mixed-citation></ref><ref id="CR21"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ge</surname><given-names>RC</given-names></name><name><surname>Kristensen</surname><given-names>PT</given-names></name><name><surname>Young</surname><given-names>JF</given-names></name><etal/></person-group><article-title xml:lang="en">Quasinormal mode approach to modelling light-emission and propagation in nanoplasmonics</article-title><source>N J Phys</source><year>2014</year><volume>16</volume><issue>11</issue><fpage>113048</fpage><pub-id pub-id-type="doi">10.1088/1367-2630/16/11/113048</pub-id></mixed-citation></ref><ref id="CR22"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Geuzaine</surname><given-names>C</given-names></name><name><surname>Remacle</surname><given-names>JF</given-names></name></person-group><article-title xml:lang="en">Gmsh: a 3-D finite element mesh generator with built-in pre- and post-processing facilities</article-title><source>Int J Numer Methods Eng</source><year>2009</year><volume>79</volume><issue>11</issue><fpage>1309</fpage><lpage>1331</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">2566786</pub-id><pub-id pub-id-type="doi">10.1002/nme.2579</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1176.74181</pub-id></mixed-citation></ref><ref id="CR23"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Gibson</surname><given-names>WC</given-names></name></person-group><source>The method of moments in electromagnetics</source><year>2021</year><edition>3</edition><publisher-loc>Boca Raton</publisher-loc><publisher-name>CRC Press</publisher-name><pub-id pub-id-type="doi">10.1201/9780429355509</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1471.78001</pub-id></mixed-citation></ref><ref id="CR24"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gong</surname><given-names>T</given-names></name><name><surname>Corrado</surname><given-names>MR</given-names></name><name><surname>Mahbub</surname><given-names>AR</given-names></name><etal/></person-group><article-title xml:lang="en">Recent progress in engineering the Casimir effect—applications to nanophotonics, nanomechanics, and chemistry</article-title><source>Nanophotonics</source><year>2021</year><volume>10</volume><issue>1</issue><fpage>523</fpage><lpage>536</lpage><pub-id pub-id-type="doi">10.1515/nanoph-2020-0425</pub-id></mixed-citation></ref><ref id="CR25"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Greffet</surname><given-names>JJ</given-names></name><name><surname>Bouchon</surname><given-names>P</given-names></name><name><surname>Brucoli</surname><given-names>G</given-names></name><etal/></person-group><article-title xml:lang="en">Light emission by nonequilibrium bodies: local Kirchhoff law</article-title><source>Phys Rev X</source><year>2018</year><volume>8</volume><issue>021</issue><fpage>008</fpage></mixed-citation></ref><ref id="CR26"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Hackbusch</surname><given-names>W</given-names></name></person-group><source>Hierarchical matrices: algorithms and analysis</source><year>2015</year><publisher-loc>Berlin</publisher-loc><publisher-name>Springer</publisher-name><pub-id pub-id-type="doi">10.1007/978-3-662-47324-5</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1336.65041</pub-id></mixed-citation></ref><ref id="CR27"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hammond</surname><given-names>AM</given-names></name><name><surname>Oskooi</surname><given-names>A</given-names></name><name><surname>Johnson</surname><given-names>SG</given-names></name><etal/></person-group><article-title xml:lang="en">Photonic topology optimization with semiconductor-foundry design-rule constraints</article-title><source>Opt Express</source><year>2021</year><volume>29</volume><fpage>23916</fpage><lpage>23938</lpage><pub-id pub-id-type="doi">10.1364/OE.431188</pub-id></mixed-citation></ref><ref id="CR28"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Harrington</surname><given-names>RF</given-names></name></person-group><source>Time-harmonic electromagnetic fields</source><year>2001</year><edition>2</edition><publisher-loc>New York</publisher-loc><publisher-name>Wiley</publisher-name><pub-id pub-id-type="doi">10.1109/9780470546710</pub-id></mixed-citation></ref><ref id="CR29"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hutchinson</surname><given-names>M</given-names></name></person-group><article-title xml:lang="en">A stochastic estimator of the trace of the influence matrix for Laplacian smoothing splines</article-title><source>Commun Stat B</source><year>1989</year><volume>18</volume><issue>3</issue><fpage>1059</fpage><lpage>1076</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">1031840</pub-id><pub-id pub-id-type="doi">10.1080/03610918908812806</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">0695.62113</pub-id></mixed-citation></ref><ref id="CR30"><mixed-citation publication-type="other">Innes M (2018) Don’t unroll adjoint: differentiating SSA-form programs (Preprint). <ext-link xlink:href="https://arxiv.org/abs/1810.07951" ext-link-type="uri">https://arxiv.org/abs/1810.07951</ext-link></mixed-citation></ref><ref id="CR31"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Inui</surname><given-names>T</given-names></name><name><surname>Tanabe</surname><given-names>Y</given-names></name><name><surname>Onodera</surname><given-names>Y</given-names></name></person-group><source>Group theory and its applications in physics</source><year>2012</year><publisher-loc>Berlin</publisher-loc><publisher-name>Springer</publisher-name><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">0849.20001</pub-id></mixed-citation></ref><ref id="CR32"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Janssen</surname><given-names>OTA</given-names></name><name><surname>Wachters</surname><given-names>AJH</given-names></name><name><surname>Urbach</surname><given-names>HP</given-names></name></person-group><article-title xml:lang="en">Efficient optimization method for the light extraction from periodically modulated LEDs using reciprocity</article-title><source>Opt Express</source><year>2010</year><volume>18</volume><issue>24</issue><fpage>24522</fpage><lpage>24535</lpage><pub-id pub-id-type="doi">10.1364/OE.18.024522</pub-id></mixed-citation></ref><ref id="CR33"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jensen</surname><given-names>J</given-names></name><name><surname>Sigmund</surname><given-names>O</given-names></name></person-group><article-title xml:lang="en">Topology optimization for nano-photonics</article-title><source>Laser Photonics Rev</source><year>2011</year><volume>5</volume><issue>2</issue><fpage>308</fpage><lpage>321</lpage><pub-id pub-id-type="doi">10.1002/lpor.201000014</pub-id></mixed-citation></ref><ref id="CR34"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Jin</surname><given-names>J</given-names></name></person-group><source>The finite element method in electromagnetics</source><year>2014</year><edition>3</edition><publisher-loc>New York</publisher-loc><publisher-name>Wiley-IEEE Press</publisher-name><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1419.78001</pub-id></mixed-citation></ref><ref id="CR35"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Joannopoulos</surname><given-names>J</given-names></name><name><surname>Johnson</surname><given-names>S</given-names></name><name><surname>Winn</surname><given-names>J</given-names></name><etal/></person-group><source>Photonic crystals: modeling the flow of light</source><year>2008</year><edition>2</edition><publisher-loc>Princeton</publisher-loc><publisher-name>Princeton University Press</publisher-name><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1144.78303</pub-id></mixed-citation></ref><ref id="CR38"><mixed-citation publication-type="other">Johnson SG (2021) The NLopt nonlinear-optimization package. <ext-link xlink:href="http://github.com/stevengj/nlopt" ext-link-type="uri">http://github.com/stevengj/nlopt</ext-link></mixed-citation></ref><ref id="CR37"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Johnson</surname><given-names>S</given-names></name><name><surname>Joannopoulos</surname><given-names>J</given-names></name></person-group><article-title xml:lang="en">Block-iterative frequency-domain methods for Maxwell’s equations in a planewave basis</article-title><source>Opt Express</source><year>2001</year><volume>8</volume><issue>3</issue><fpage>173</fpage><lpage>190</lpage><pub-id pub-id-type="doi">10.1364/OE.8.000173</pub-id></mixed-citation></ref><ref id="CR36"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Johnson</surname><given-names>RA</given-names></name><name><surname>Wichern</surname><given-names>DW</given-names></name></person-group><source>Applied multivariate statistics</source><year>2018</year><edition>6</edition><publisher-loc>Englewood Cliffs</publisher-loc><publisher-name>Pearson</publisher-name></mixed-citation></ref><ref id="CR39"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Johnson</surname><given-names>SG</given-names></name><name><surname>Povinelli</surname><given-names>ML</given-names></name><name><surname>Soljačić</surname><given-names>M</given-names></name><etal/></person-group><article-title xml:lang="en">Roughness losses and volume-current methods in photonic-crystal waveguides</article-title><source>Appl Phys B</source><year>2005</year><volume>81</volume><issue>2–3</issue><fpage>283</fpage><lpage>293</lpage><pub-id pub-id-type="doi">10.1007/s00340-005-1823-4</pub-id></mixed-citation></ref><ref id="CR40"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kim</surname><given-names>KJ</given-names></name></person-group><article-title xml:lang="en">An analysis of self-amplified spontaneous emission</article-title><source>Nucl Instrum</source><year>1986</year><volume>250</volume><issue>1</issue><fpage>396</fpage><lpage>403</lpage><pub-id pub-id-type="doi">10.1016/0168-9002(86)90916-2</pub-id></mixed-citation></ref><ref id="CR41"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kita</surname><given-names>DM</given-names></name><name><surname>Michon</surname><given-names>J</given-names></name><name><surname>Johnson</surname><given-names>SG</given-names></name><etal/></person-group><article-title xml:lang="en">Are slot and sub-wavelength grating waveguides better than strip waveguides for sensing?</article-title><source>Optica</source><year>2018</year><volume>5</volume><fpage>1046</fpage><lpage>1054</lpage><pub-id pub-id-type="doi">10.1364/OPTICA.5.001046</pub-id></mixed-citation></ref><ref id="CR42"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Knyazev</surname><given-names>AV</given-names></name></person-group><article-title xml:lang="en">Toward the optimal preconditioned eigensolver: locally optimal block preconditioned conjugate gradient method</article-title><source>SIAM J Sci Comput</source><year>2001</year><volume>23</volume><issue>2</issue><fpage>517</fpage><lpage>541</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">1861263</pub-id><pub-id pub-id-type="doi">10.1137/S1064827500366124</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">0992.65028</pub-id></mixed-citation></ref><ref id="CR43"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kokiopoulou</surname><given-names>E</given-names></name><name><surname>Chen</surname><given-names>J</given-names></name><name><surname>Saad</surname><given-names>Y</given-names></name></person-group><article-title xml:lang="en">Trace optimization and eigenproblems in dimension reduction methods</article-title><source>Numer Linear Algebra Appl</source><year>2011</year><volume>18</volume><issue>3</issue><fpage>565</fpage><lpage>602</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">2760068</pub-id><pub-id pub-id-type="doi">10.1002/nla.743</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1249.65075</pub-id></mixed-citation></ref><ref id="CR44"><mixed-citation publication-type="other">Kreutz-Delgado K (2009) The complex gradient operator and the CR-calculus (Preprint). <ext-link xlink:href="https://arxiv.org/abs/0906.4835" ext-link-type="uri">https://arxiv.org/abs/0906.4835</ext-link></mixed-citation></ref><ref id="CR45"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kuang</surname><given-names>Z</given-names></name><name><surname>Miller</surname><given-names>OD</given-names></name></person-group><article-title xml:lang="en">Computational bounds to light-matter interactions via local conservation laws</article-title><source>Phys Rev Lett</source><year>2020</year><volume>125</volume><issue>26</issue><fpage>263607</fpage><pub-id pub-id-type="doi">10.1103/PhysRevLett.125.263607</pub-id></mixed-citation></ref><ref id="CR46"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lalanne</surname><given-names>P</given-names></name><name><surname>Yan</surname><given-names>W</given-names></name><name><surname>Vynck</surname><given-names>K</given-names></name><etal/></person-group><article-title xml:lang="en">Light interaction with photonic and plasmonic resonances</article-title><source>Laser Photonics Rev</source><year>2018</year><volume>12</volume><issue>5</issue><fpage>1700113</fpage><pub-id pub-id-type="doi">10.1002/lpor.201700113</pub-id></mixed-citation></ref><ref id="CR47"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lanczos</surname><given-names>C</given-names></name></person-group><article-title xml:lang="en">An iteration method for the solution of the eigenvalue problem of linear differential and integral operators</article-title><source>J Res Natl Bur Stand</source><year>1950</year><volume>45</volume><issue>4</issue><fpage>255</fpage><lpage>282</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">42791</pub-id><pub-id pub-id-type="doi">10.6028/JRES.045.026</pub-id></mixed-citation></ref><ref id="CR48"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Landau</surname><given-names>L</given-names></name><name><surname>Lifšic</surname><given-names>E</given-names></name><name><surname>Lifshitz</surname><given-names>E</given-names></name><etal/></person-group><source>Statistical physics: theory of the condensed state</source><year>1980</year><publisher-loc>Amsterdam</publisher-loc><publisher-name>Elsevier Science</publisher-name></mixed-citation></ref><ref id="CR49"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Lax</surname><given-names>P</given-names></name></person-group><source>Linear algebra and its applications</source><year>2013</year><publisher-loc>Hoboken</publisher-loc><publisher-name>Wiley</publisher-name></mixed-citation></ref><ref id="CR50"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lazarov</surname><given-names>BS</given-names></name><name><surname>Sigmund</surname><given-names>O</given-names></name></person-group><article-title xml:lang="en">Filters in topology optimization based on Helmholtz-type differential equations</article-title><source>Int J Numer Methods Eng</source><year>2011</year><volume>86</volume><issue>6</issue><fpage>765</fpage><lpage>781</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">2815893</pub-id><pub-id pub-id-type="doi">10.1002/nme.3072</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1235.74258</pub-id></mixed-citation></ref><ref id="CR51"><mixed-citation publication-type="other">Li RC (2015) Rayleigh quotient based optimization methods for eigenvalue problems. Series in contemporary applied mathematics. HEP, pp 76–108</mixed-citation></ref><ref id="CR52"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liang</surname><given-names>X</given-names></name><name><surname>Johnson</surname><given-names>SG</given-names></name></person-group><article-title xml:lang="en">Formulation for scalable optimization of microcavities via the frequency-averaged local density of states</article-title><source>Opt Express</source><year>2013</year><volume>21</volume><issue>25</issue><fpage>30812</fpage><lpage>30841</lpage><pub-id pub-id-type="doi">10.1364/OE.21.030812</pub-id></mixed-citation></ref><ref id="CR53"><mixed-citation publication-type="other">Lin HC, Wang Z, Hsu CW (2022) Full-wave solver for massively multi-channel optics using augmented partial factorization. arXiv preprint. <ext-link xlink:href="http://arxiv.org/abs/2205.07887" ext-link-type="uri">arXiv:2205.07887</ext-link></mixed-citation></ref><ref id="CR54"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luo</surname><given-names>C</given-names></name><name><surname>Narayanaswamy</surname><given-names>A</given-names></name><name><surname>Chen</surname><given-names>G</given-names></name><etal/></person-group><article-title xml:lang="en">Thermal radiation from photonic crystals: a direct calculation</article-title><source>Phys Rev Lett</source><year>2004</year><volume>93</volume><fpage>213905</fpage><lpage>213908</lpage><pub-id pub-id-type="doi">10.1103/PhysRevLett.93.213905</pub-id></mixed-citation></ref><ref id="CR55"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Markovsky</surname><given-names>I</given-names></name></person-group><source>Low rank approximation</source><year>2012</year><publisher-loc>London</publisher-loc><publisher-name>Springer</publisher-name><pub-id pub-id-type="doi">10.1007/978-1-4471-2227-2</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1245.93005</pub-id></mixed-citation></ref><ref id="CR56"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Miller</surname><given-names>OD</given-names></name><name><surname>Johnson</surname><given-names>SG</given-names></name><name><surname>Rodriguez</surname><given-names>AW</given-names></name></person-group><article-title xml:lang="en">Shape-independent limits to near-field radiative heat transfer</article-title><source>Phys Rev Lett</source><year>2015</year><volume>115</volume><issue>204</issue><fpage>302</fpage></mixed-citation></ref><ref id="CR57"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Miller</surname><given-names>OD</given-names></name><name><surname>Polimeridis</surname><given-names>AG</given-names></name><name><surname>Reid</surname><given-names>MTH</given-names></name><etal/></person-group><article-title xml:lang="en">Fundamental limits to optical response in absorptive systems</article-title><source>Opt Express</source><year>2016</year><volume>24</volume><issue>4</issue><fpage>3329</fpage><lpage>3364</lpage><pub-id pub-id-type="doi">10.1364/OE.24.003329</pub-id></mixed-citation></ref><ref id="CR58"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Milonni</surname><given-names>P</given-names></name></person-group><article-title xml:lang="en">Semiclassical and quantum-electrodynamical approaches in nonrelativistic radiation theory</article-title><source>Phys Rep</source><year>1976</year><volume>25</volume><fpage>1</fpage><lpage>81</lpage><pub-id pub-id-type="doi">10.1016/0370-1573(76)90037-5</pub-id></mixed-citation></ref><ref id="CR59"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Molesky</surname><given-names>S</given-names></name><name><surname>Lin</surname><given-names>Z</given-names></name><name><surname>Piggott</surname><given-names>AY</given-names></name><etal/></person-group><article-title xml:lang="en">Inverse design in nanophotonics</article-title><source>Nat Photonics</source><year>2018</year><volume>12</volume><issue>11</issue><fpage>659</fpage><lpage>670</lpage><pub-id pub-id-type="doi">10.1038/s41566-018-0246-9</pub-id></mixed-citation></ref><ref id="CR60"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Molesky</surname><given-names>S</given-names></name><name><surname>Venkataram</surname><given-names>PS</given-names></name><name><surname>Jin</surname><given-names>W</given-names></name><etal/></person-group><article-title xml:lang="en">Fundamental limits to radiative heat transfer: theory</article-title><source>Phys Rev B</source><year>2020</year><volume>101</volume><issue>035</issue><fpage>408</fpage><pub-id pub-id-type="doi">10.1103/PhysRevB.101.035408</pub-id></mixed-citation></ref><ref id="CR61"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mutapcic</surname><given-names>A</given-names></name><name><surname>Boyd</surname><given-names>S</given-names></name><name><surname>Farjadpour</surname><given-names>A</given-names></name><etal/></person-group><article-title xml:lang="en">Robust design of slow-light tapers in periodic waveguides</article-title><source>Eng Optim</source><year>2009</year><volume>41</volume><fpage>365</fpage><lpage>384</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">2515346</pub-id><pub-id pub-id-type="doi">10.1080/03052150802576797</pub-id></mixed-citation></ref><ref id="CR62"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Noda</surname><given-names>S</given-names></name><name><surname>Fujita</surname><given-names>M</given-names></name></person-group><article-title xml:lang="en">Photonic crystal efficiency boost</article-title><source>Nat Photonics</source><year>2009</year><volume>3</volume><fpage>129</fpage><lpage>130</lpage><pub-id pub-id-type="doi">10.1038/nphoton.2009.15</pub-id></mixed-citation></ref><ref id="CR63"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Nussenzveig</surname><given-names>H</given-names></name></person-group><source>Causality and dispersion relations</source><year>1972</year><publisher-loc>New York</publisher-loc><publisher-name>Academic</publisher-name></mixed-citation></ref><ref id="CR64"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Oskooi</surname><given-names>A</given-names></name><name><surname>Johnson</surname><given-names>SG</given-names></name></person-group><article-title xml:lang="en">Distinguishing correct from incorrect PML proposals and a corrected unsplit PML for anisotropic, dispersive media</article-title><source>J Comput Phys</source><year>2011</year><volume>230</volume><fpage>2369</fpage><lpage>2377</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">2772919</pub-id><pub-id pub-id-type="doi">10.1016/j.jcp.2011.01.006</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1219.78139</pub-id></mixed-citation></ref><ref id="CR65"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Oskooi</surname><given-names>A</given-names></name><name><surname>Johnson</surname><given-names>SG</given-names></name></person-group><person-group person-group-type="editor"><name><surname>Taflove</surname><given-names>A</given-names></name><name><surname>Oskooi</surname><given-names>A</given-names></name><name><surname>Johnson</surname><given-names>SG</given-names></name></person-group><article-title xml:lang="en">Chap 4: electromagnetic wave source conditions</article-title><source>Advances in FDTD computational electrodynamics: photonics and nanotechnology</source><year>2013</year><publisher-loc>Boston</publisher-loc><publisher-name>Artech</publisher-name><fpage>65</fpage><lpage>100</lpage></mixed-citation></ref><ref id="CR66"><mixed-citation publication-type="other">Pan Y, Christiansen RE, Michon J et al (2021) Topology optimization of surface-enhanced Raman scattering substrates (Preprint). <ext-link xlink:href="https://arxiv.org/abs/2101.11352" ext-link-type="uri">https://arxiv.org/abs/2101.11352</ext-link></mixed-citation></ref><ref id="CR67"><mixed-citation publication-type="other">Patra M (2015) On quantum optics of random media. PhD Thesis, University of Leiden</mixed-citation></ref><ref id="CR68"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Payne</surname><given-names>FP</given-names></name><name><surname>Lacey</surname><given-names>JPR</given-names></name></person-group><article-title xml:lang="en">A theoretical analysis of scattering loss from planar optical waveguides</article-title><source>Opt Quantum Electron</source><year>1994</year><volume>26</volume><fpage>977</fpage><lpage>986</lpage><pub-id pub-id-type="doi">10.1007/BF00708339</pub-id></mixed-citation></ref><ref id="CR69"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Petersen</surname><given-names>KB</given-names></name><name><surname>Pedersen</surname><given-names>MS</given-names></name></person-group><source>The matrix cookbook</source><year>2012</year><publisher-loc>Kgs. Lyngby</publisher-loc><publisher-name>Technical University of Denmark</publisher-name></mixed-citation></ref><ref id="CR70"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pick</surname><given-names>A</given-names></name><name><surname>Cerjan</surname><given-names>A</given-names></name><name><surname>Liu</surname><given-names>D</given-names></name><etal/></person-group><article-title xml:lang="en">Ab-initio multimode linewidth theory for arbitrary inhomogeneous laser cavities</article-title><source>Phys Rev A</source><year>2015</year><volume>91</volume><issue>063</issue><fpage>806</fpage><pub-id pub-id-type="doi">10.1103/PhysRevA.91.063806</pub-id></mixed-citation></ref><ref id="CR71"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pilot</surname><given-names>R</given-names></name><name><surname>Signorini</surname><given-names>R</given-names></name><name><surname>Durante</surname><given-names>C</given-names></name><etal/></person-group><article-title xml:lang="en">A review on surface-enhanced Raman scattering</article-title><source>Biosensors</source><year>2019</year><volume>9</volume><issue>2</issue><fpage>57</fpage><pub-id pub-id-type="doi">10.3390/bios9020057</pub-id></mixed-citation></ref><ref id="CR72"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Polimeridis</surname><given-names>AG</given-names></name><name><surname>Reid</surname><given-names>MTH</given-names></name><name><surname>Jin</surname><given-names>W</given-names></name><etal/></person-group><article-title xml:lang="en">Fluctuating volume-current formulation of electromagnetic fluctuations in inhomogeneous media: incandescence and luminescence in arbitrary geometries</article-title><source>Phys Rev B</source><year>2015</year><volume>92</volume><issue>134</issue><fpage>202</fpage><pub-id pub-id-type="doi">10.1103/PhysRevB.92.134202</pub-id></mixed-citation></ref><ref id="CR73"><mixed-citation publication-type="other">Reid MTH, Miller OD, Polimeridis AG et al (2017) Photon torpedoes and Rytov pinwheels: integral-equation modeling of non-equilibrium fluctuation-induced forces and torques on nanoparticles (Preprint). <ext-link xlink:href="https://arxiv.org/abs/1708.01985" ext-link-type="uri">https://arxiv.org/abs/1708.01985</ext-link></mixed-citation></ref><ref id="CR74"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Reif</surname><given-names>F</given-names></name></person-group><source>Fundamentals of statistical and thermal physics</source><year>1965</year><publisher-loc>New York</publisher-loc><publisher-name>McGraw-Hill</publisher-name></mixed-citation></ref><ref id="CR75"><mixed-citation publication-type="other">Revels J, Lubin M, Papamarkou T (2016) Forward-mode automatic differentiation in Julia (Preprint). <ext-link xlink:href="https://arxiv.org/abs/1607.07892" ext-link-type="uri">https://arxiv.org/abs/1607.07892</ext-link></mixed-citation></ref><ref id="CR76"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rodriguez</surname><given-names>AW</given-names></name><name><surname>Ilic</surname><given-names>O</given-names></name><name><surname>Bermel</surname><given-names>P</given-names></name><etal/></person-group><article-title xml:lang="en">Frequency-selective near-field radiative heat transfer between photonic crystal slabs: a computational approach for arbitrary geometries and materials</article-title><source>Phys Rev Lett</source><year>2011</year><volume>107</volume><issue>114</issue><fpage>302</fpage><pub-id pub-id-type="doi">10.1103/PhysRevLett.107.114302</pub-id></mixed-citation></ref><ref id="CR77"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rodriguez</surname><given-names>AW</given-names></name><name><surname>Reid</surname><given-names>MTH</given-names></name><name><surname>Johnson</surname><given-names>SG</given-names></name></person-group><article-title xml:lang="en">Fluctuating surface-current formulation of radiative heat transfer: theory and applications</article-title><source>Phys Rev B</source><year>2013</year><volume>88</volume><issue>054</issue><fpage>305</fpage><pub-id pub-id-type="doi">10.1103/PhysRevB.88.054305</pub-id></mixed-citation></ref><ref id="CR78"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rogobete</surname><given-names>L</given-names></name><name><surname>Schniepp</surname><given-names>H</given-names></name><name><surname>Sandoghdar</surname><given-names>V</given-names></name><etal/></person-group><article-title xml:lang="en">Spontaneous emission in nanoscopic dielectric particles</article-title><source>Opt Lett</source><year>2003</year><volume>28</volume><issue>19</issue><fpage>1736</fpage><lpage>1738</lpage><pub-id pub-id-type="doi">10.1364/OL.28.001736</pub-id></mixed-citation></ref><ref id="CR79"><mixed-citation publication-type="other">Roques-Carmes C, Rivera N, Ghorashi A et al (2021) A general framework for scintillation in nanophotonics (Preprint). <ext-link xlink:href="https://arxiv.org/abs/2110.11492" ext-link-type="uri">https://arxiv.org/abs/2110.11492</ext-link></mixed-citation></ref><ref id="CR80"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Schneider</surname><given-names>PI</given-names></name><name><surname>Santiago</surname><given-names>XG</given-names></name><name><surname>Soltwisch</surname><given-names>V</given-names></name><etal/></person-group><article-title xml:lang="en">Benchmarking five global optimization approaches for nano-optical shape optimization and parameter reconstruction</article-title><source>ACS Photonics</source><year>2019</year><volume>6</volume><issue>11</issue><fpage>2726</fpage><lpage>2733</lpage><pub-id pub-id-type="doi">10.1021/acsphotonics.9b00706</pub-id></mixed-citation></ref><ref id="CR81"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Snyder</surname><given-names>AW</given-names></name><name><surname>Love</surname><given-names>JD</given-names></name></person-group><source>Optical waveguide theory</source><year>1983</year><publisher-loc>New York</publisher-loc><publisher-name>Springer</publisher-name></mixed-citation></ref><ref id="CR82"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Svanberg</surname><given-names>K</given-names></name></person-group><article-title xml:lang="en">A class of globally convergent optimization methods based on conservative convex separable approximations</article-title><source>SIAM J Optim</source><year>2002</year><volume>12</volume><issue>2</issue><fpage>555</fpage><lpage>573</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">1885575</pub-id><pub-id pub-id-type="doi">10.1137/S1052623499362822</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1035.90088</pub-id></mixed-citation></ref><ref id="CR83"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tortorelli</surname><given-names>DA</given-names></name><name><surname>Michaleris</surname><given-names>P</given-names></name></person-group><article-title xml:lang="en">Design sensitivity analysis: overview and review</article-title><source>Inverse Probl Eng</source><year>1994</year><volume>1</volume><issue>1</issue><fpage>71</fpage><lpage>105</lpage><pub-id pub-id-type="doi">10.1080/174159794088027573</pub-id></mixed-citation></ref><ref id="CR84"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Trefethen</surname><given-names>LN</given-names></name><name><surname>Bau</surname><given-names>D</given-names></name></person-group><source>Numerical linear algebra</source><year>1997</year><publisher-loc>Philadelphia</publisher-loc><publisher-name>SIAM</publisher-name><pub-id pub-id-type="doi">10.1137/1.9780898719574</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">0874.65013</pub-id></mixed-citation></ref><ref id="CR85"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Trefethen</surname><given-names>LN</given-names></name><name><surname>Weideman</surname><given-names>JAC</given-names></name></person-group><article-title xml:lang="en">The exponentially convergent trapezoidal rule</article-title><source>SIAM Rev</source><year>2014</year><volume>56</volume><issue>3</issue><fpage>385</fpage><lpage>458</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">3245858</pub-id><pub-id pub-id-type="doi">10.1137/130932132</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1307.65031</pub-id></mixed-citation></ref><ref id="CR86"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ubaru</surname><given-names>S</given-names></name><name><surname>Chen</surname><given-names>J</given-names></name><name><surname>Saad</surname><given-names>Y</given-names></name></person-group><article-title xml:lang="en">Fast estimation of <inline-formula id="IEq335"><alternatives><mml:math id="IEq335_Math"><mml:mrow><mml:mi mathvariant="normal">tr</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">A</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq335_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rm tr (f(A))$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq335.gif"/></alternatives></inline-formula> via stochastic Lanczos quadrature</article-title><source>SIAM J Matrix Anal Appl</source><year>2017</year><volume>38</volume><fpage>1075</fpage><lpage>1099</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">3707895</pub-id><pub-id pub-id-type="doi">10.1137/16M1104974</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1386.65125</pub-id></mixed-citation></ref><ref id="CR19"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>van Dijk</surname><given-names>N</given-names></name><name><surname>Maute</surname><given-names>K</given-names></name><name><surname>Langelaar</surname><given-names>M</given-names></name><etal/></person-group><article-title xml:lang="en">Level-set methods for structural topology optimization: a review</article-title><source>Struct Multidisc Optim</source><year>2013</year><volume>48</volume><fpage>437</fpage><lpage>472</lpage><pub-id pub-id-type="other" assigning-authority="American Mathematical Society">3107583</pub-id><pub-id pub-id-type="doi">10.1007/s00158-013-0912-y</pub-id></mixed-citation></ref><ref id="CR87"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>F</given-names></name><name><surname>Lazarov</surname><given-names>BS</given-names></name><name><surname>Sigmund</surname><given-names>O</given-names></name></person-group><article-title xml:lang="en">On projection methods, convergence and robust formulations in topology optimization</article-title><source>Struct Multidisc Optim</source><year>2010</year><volume>43</volume><issue>6</issue><fpage>767</fpage><lpage>784</lpage><pub-id pub-id-type="doi">10.1007/s00158-010-0602-y</pub-id><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1274.74409</pub-id></mixed-citation></ref><ref id="CR88"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>F</given-names></name><name><surname>Christiansen</surname><given-names>RE</given-names></name><name><surname>Yu</surname><given-names>Y</given-names></name><etal/></person-group><article-title xml:lang="en">Maximizing the quality factor to mode volume ratio for ultra-small photonic crystal cavities</article-title><source>Appl Phys Lett</source><year>2018</year><volume>113</volume><issue>24</issue><fpage>241101</fpage><pub-id pub-id-type="doi">10.1063/1.5064468</pub-id></mixed-citation></ref><ref id="CR89"><mixed-citation publication-type="book"><person-group person-group-type="author"><name><surname>Wolf</surname><given-names>E</given-names></name></person-group><source>Introduction to the theory of coherence and polarization of light</source><year>2007</year><publisher-loc>Cambridge</publisher-loc><publisher-name>Cambridge University Press</publisher-name><pub-id pub-id-type="other" assigning-authority="Zentralblatt MATH">1138.78001</pub-id></mixed-citation></ref><ref id="CR90"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yang</surname><given-names>S</given-names></name><name><surname>Wang</surname><given-names>Y</given-names></name><name><surname>Sun</surname><given-names>H</given-names></name></person-group><article-title xml:lang="en">Advances and prospects for whispering gallery mode microcavities</article-title><source>Adv Opt Mater</source><year>2015</year><volume>3</volume><issue>9</issue><fpage>1136</fpage><lpage>1162</lpage><pub-id pub-id-type="doi">10.1002/adom.201500232</pub-id></mixed-citation></ref><ref id="CR91"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yao</surname><given-names>W</given-names></name><name><surname>Benzaouia</surname><given-names>M</given-names></name><name><surname>Miller</surname><given-names>OD</given-names></name><etal/></person-group><article-title xml:lang="en">Approaching the upper limits of the local density of states via optimized metallic cavities</article-title><source>Opt Express</source><year>2020</year><volume>28</volume><fpage>24185</fpage><lpage>24197</lpage><pub-id pub-id-type="doi">10.1364/OE.397502</pub-id></mixed-citation></ref><ref id="CR92"><mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yu</surname><given-names>Z</given-names></name><name><surname>Raman</surname><given-names>A</given-names></name><name><surname>Fan</surname><given-names>S</given-names></name></person-group><article-title xml:lang="en">Fundamental limit of nanophotonic light trapping in solar cells</article-title><source>Proc Natl Acad Sci USA</source><year>2010</year><volume>107</volume><issue>41</issue><fpage>17491</fpage><lpage>17496</lpage><pub-id pub-id-type="doi">10.1073/pnas.1008296107</pub-id></mixed-citation></ref></ref-list></ref-list><app-group><app id="App1"><sec id="Sec14"><title>Appendix 1: Correlation matrix</title><p id="Par46">In this section, we show how to compute the correlation matrix <inline-formula id="IEq212"><alternatives><mml:math id="IEq212_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq212_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq212.gif"/></alternatives></inline-formula> corresponding to random current sources <inline-formula id="IEq213"><alternatives><mml:math id="IEq213_Math"><mml:mi mathvariant="bold">J</mml:mi></mml:math><tex-math id="IEq213_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq213.gif"/></alternatives></inline-formula> discretized in a finite-element basis. One can express the frequency-domain Maxwell equations either in terms of the electric field <inline-formula id="IEq214"><alternatives><mml:math id="IEq214_Math"><mml:mi mathvariant="bold">E</mml:mi></mml:math><tex-math id="IEq214_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {E}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq214.gif"/></alternatives></inline-formula>, in which case the source term is proportional to <inline-formula id="IEq215"><alternatives><mml:math id="IEq215_Math"><mml:mi mathvariant="bold">J</mml:mi></mml:math><tex-math id="IEq215_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq215.gif"/></alternatives></inline-formula>, or in terms of the magnetic field <inline-formula id="IEq216"><alternatives><mml:math id="IEq216_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq216_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq216.gif"/></alternatives></inline-formula>, in which case the source term is proportional to <inline-formula id="IEq217"><alternatives><mml:math id="IEq217_Math"><mml:mrow><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mi mathvariant="bold">J</mml:mi></mml:mrow></mml:math><tex-math id="IEq217_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\nabla \times \mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq217.gif"/></alternatives></inline-formula> (Jin <xref ref-type="bibr" rid="CR34">2014</xref>). These two formulations lead to different <inline-formula id="IEq218"><alternatives><mml:math id="IEq218_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq218_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq218.gif"/></alternatives></inline-formula> correlation matrices.</p><p id="Par47">In particular, we consider the case where the currents <inline-formula id="IEq219"><alternatives><mml:math id="IEq219_Math"><mml:mi mathvariant="bold">J</mml:mi></mml:math><tex-math id="IEq219_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq219.gif"/></alternatives></inline-formula> (at a frequency <inline-formula id="IEq220"><alternatives><mml:math id="IEq220_Math"><mml:mi>ω</mml:mi></mml:math><tex-math id="IEq220_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\omega$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq220.gif"/></alternatives></inline-formula>) are spatially uncorrelated with a given correlation function:<disp-formula id="Equ19"><label>19</label><alternatives><mml:math display="block" id="Equ19_Math"><mml:mrow><mml:mfenced close="〉" open="〈"><mml:mi mathvariant="bold">J</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">J</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mo>′</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup></mml:mfenced><mml:mo>=</mml:mo><mml:mi mathvariant="bold">C</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>δ</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo>-</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mo>′</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ19_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left\langle \mathbf {J}(\mathbf {x})\mathbf {J}(\mathbf {x}^{\prime} )^{\dagger} \right\rangle = \mathbf {C}(\mathbf {x}) \delta (\mathbf {x}-\mathbf {x}^{\prime} ) ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ19.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq221"><alternatives><mml:math id="IEq221_Math"><mml:mi mathvariant="bold">C</mml:mi></mml:math><tex-math id="IEq221_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {C}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq221.gif"/></alternatives></inline-formula> is a given <inline-formula id="IEq222"><alternatives><mml:math id="IEq222_Math"><mml:mrow><mml:mn>3</mml:mn><mml:mo>×</mml:mo><mml:mn>3</mml:mn></mml:mrow></mml:math><tex-math id="IEq222_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$3\times 3$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq222.gif"/></alternatives></inline-formula> Hermitian positive-semidefinite correlation matrix. For example, in 2D with in-plane electric currents, as in the examples of Sect. <xref rid="Sec9" ref-type="sec">4</xref>, one has<disp-formula id="Equ20"><label>20</label><alternatives><mml:math display="block" id="Equ20_Math"><mml:mrow><mml:mi mathvariant="bold">C</mml:mi><mml:mo>=</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:msubsup><mml:mi>J</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mn>2</mml:mn></mml:msubsup></mml:mtd><mml:mtd><mml:mrow/></mml:mtd><mml:mtd><mml:mrow/></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow/></mml:mtd><mml:mtd><mml:mrow><mml:mrow/><mml:msubsup><mml:mi>J</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mtd><mml:mtd><mml:mrow/></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow/></mml:mtd><mml:mtd><mml:mrow/></mml:mtd><mml:mtd><mml:mrow><mml:mrow/><mml:mn>0</mml:mn></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ20_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {C} = \begin{pmatrix} J_{0}^{2} &amp;{} &amp;{} \\ &amp;{} J_{0}^{2} &amp;{} \\ &amp;{} &amp;{} 0 \end{pmatrix},$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ20.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq223"><alternatives><mml:math id="IEq223_Math"><mml:mrow><mml:msubsup><mml:mi>J</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mn>2</mml:mn></mml:msubsup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><tex-math id="IEq223_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$J_{0}^{2}(\mathbf {x})$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq223.gif"/></alternatives></inline-formula> is the mean-square current at <inline-formula id="IEq224"><alternatives><mml:math id="IEq224_Math"><mml:mi mathvariant="bold">x</mml:mi></mml:math><tex-math id="IEq224_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {x}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq224.gif"/></alternatives></inline-formula>. For isotropic random currents, <inline-formula id="IEq225"><alternatives><mml:math id="IEq225_Math"><mml:mrow><mml:mi mathvariant="bold">C</mml:mi><mml:mo>=</mml:mo><mml:msubsup><mml:mi>J</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mn>2</mml:mn></mml:msubsup><mml:mi mathvariant="bold">I</mml:mi></mml:mrow></mml:math><tex-math id="IEq225_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {C}=J_{0}^{2} \mathbf {I}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq225.gif"/></alternatives></inline-formula> where <inline-formula id="IEq226"><alternatives><mml:math id="IEq226_Math"><mml:mi mathvariant="bold">I</mml:mi></mml:math><tex-math id="IEq226_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {I}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq226.gif"/></alternatives></inline-formula> is the identity matrix.</p><p id="Par48">In a finite-element method, the source vector <inline-formula id="IEq227"><alternatives><mml:math id="IEq227_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq227_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq227.gif"/></alternatives></inline-formula> is constructed by taking inner products of the source current with real vector-valued basis “element” functions <inline-formula id="IEq228"><alternatives><mml:math id="IEq228_Math"><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub></mml:math><tex-math id="IEq228_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{\mathbf {v}}_{n}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq228.gif"/></alternatives></inline-formula> (Nedelec elements in 3D, or <inline-formula id="IEq229"><alternatives><mml:math id="IEq229_Math"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">z</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:math><tex-math id="IEq229_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{v}}_{n} \hat{\mathbf {z}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq229.gif"/></alternatives></inline-formula> with scalar Lagrange elements <inline-formula id="IEq230"><alternatives><mml:math id="IEq230_Math"><mml:msub><mml:mover accent="true"><mml:mi>v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub></mml:math><tex-math id="IEq230_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{v}}_{n}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq230.gif"/></alternatives></inline-formula> in 2D for <italic>z</italic>-polarized fields) (Jin <xref ref-type="bibr" rid="CR34">2014</xref>). That is, the components of <inline-formula id="IEq231"><alternatives><mml:math id="IEq231_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq231_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq231.gif"/></alternatives></inline-formula> are<disp-formula id="Equ21"><label>21</label><alternatives><mml:math display="block" id="Equ21_Math"><mml:mrow><mml:msub><mml:mi>b</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mo>∫</mml:mo><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:mtext>(source</mml:mtext><mml:mspace width="0.333333em"/><mml:mspace width="0.333333em"/><mml:mtext>current)</mml:mtext><mml:mspace width="0.333333em"/><mml:mspace width="0.166667em"/><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ21_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$b_{n} = \int \hat{\mathbf {v}}_{n} \cdot \text{(source } \text{ current) } \, {\text {d}}\varOmega .$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ21.gif" position="anchor"/></alternatives></disp-formula>For an electric-field formulation with a source current <inline-formula id="IEq232"><alternatives><mml:math id="IEq232_Math"><mml:mi mathvariant="bold">J</mml:mi></mml:math><tex-math id="IEq232_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq232.gif"/></alternatives></inline-formula>, we obtain the correlation function:<disp-formula id="Equ22"><label>22</label><alternatives><mml:math display="block" id="Equ22_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:msub><mml:mi>B</mml:mi><mml:mrow><mml:mi mathvariant="italic">mn</mml:mi></mml:mrow></mml:msub></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>=</mml:mo><mml:mo stretchy="false">⟨</mml:mo><mml:msub><mml:mi>b</mml:mi><mml:mi>m</mml:mi></mml:msub><mml:msubsup><mml:mi>b</mml:mi><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mo stretchy="false">⟩</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow/></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>=</mml:mo><mml:mfenced close="〉" open="〈"><mml:mo>∬</mml:mo><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>m</mml:mi></mml:msub><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>T</mml:mi></mml:msup><mml:mi mathvariant="bold">J</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">J</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mo>′</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mo>′</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mspace width="0.166667em"/><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mtext>d</mml:mtext><mml:msup><mml:mi>Ω</mml:mi><mml:mo>′</mml:mo></mml:msup></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow/></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>=</mml:mo><mml:mo>∬</mml:mo><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>m</mml:mi></mml:msub><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>T</mml:mi></mml:msup><mml:mfenced close="〉" open="〈"><mml:mi mathvariant="bold">J</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">J</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo>′</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup></mml:mfenced><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mo>′</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mspace width="0.166667em"/><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mtext>d</mml:mtext><mml:msup><mml:mi>Ω</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow/></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>=</mml:mo><mml:mo>∫</mml:mo><mml:msubsup><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mi>T</mml:mi></mml:msubsup><mml:mi mathvariant="bold">C</mml:mi><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mspace width="0.166667em"/><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mo>.</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ22_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} B_{mn}&amp;= \langle b_{m} b_{n}^{*} \rangle , \\&amp;= \left\langle \iint \hat{\mathbf {v}}_{m}(\mathbf {x})^{T} \mathbf {J}(\mathbf {x}) \mathbf {J}(\mathbf {x}^{\prime} )^{\dagger} \hat{\mathbf {v}}_{n}(\mathbf {x}^{\prime} ) \, {\text {d}}\varOmega {\text {d}}\varOmega ^{\prime} \right\rangle , \\&amp;= \iint \hat{\mathbf {v}}_{m}(\mathbf {x})^{T} \left\langle \mathbf {J}(\mathbf {x}) \mathbf {J}(\mathbf {x}\prime )^{\dagger} \right\rangle \hat{\mathbf {v}}_{n}(\mathbf {x}^{\prime} ) \, {\text {d}}\varOmega {\text {d}}\varOmega ^{\prime} , \\&amp;= \int \hat{\mathbf {v}}_{m}^{T} \mathbf {C} \hat{\mathbf {v}}_{n} \, {\text {d}}\varOmega . \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ22.gif" position="anchor"/></alternatives></disp-formula>For localized basis functions (as in a finite-element method), this results in an extremely sparse matrix <inline-formula id="IEq233"><alternatives><mml:math id="IEq233_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq233_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq233.gif"/></alternatives></inline-formula>—it is zero if <inline-formula id="IEq234"><alternatives><mml:math id="IEq234_Math"><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>m</mml:mi></mml:msub></mml:math><tex-math id="IEq234_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{\mathbf {v}}_{m}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq234.gif"/></alternatives></inline-formula> and <inline-formula id="IEq235"><alternatives><mml:math id="IEq235_Math"><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub></mml:math><tex-math id="IEq235_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{\mathbf {v}}_{n}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq235.gif"/></alternatives></inline-formula> do not overlap, or in regions where the mean-square current <inline-formula id="IEq236"><alternatives><mml:math id="IEq236_Math"><mml:mi mathvariant="bold">C</mml:mi></mml:math><tex-math id="IEq236_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {C}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq236.gif"/></alternatives></inline-formula> is zero. (If <inline-formula id="IEq237"><alternatives><mml:math id="IEq237_Math"><mml:mi mathvariant="bold">C</mml:mi></mml:math><tex-math id="IEq237_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {C}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq237.gif"/></alternatives></inline-formula> is the identity, <inline-formula id="IEq238"><alternatives><mml:math id="IEq238_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq238_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq238.gif"/></alternatives></inline-formula> is equal to the Gram matrix of the basis.) Note also that, by construction, <inline-formula id="IEq239"><alternatives><mml:math id="IEq239_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq239_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq239.gif"/></alternatives></inline-formula> is a Hermitian semidefinite matrix, so it has factorization <inline-formula id="IEq240"><alternatives><mml:math id="IEq240_Math"><mml:mrow><mml:mi mathvariant="bold">B</mml:mi><mml:mo>=</mml:mo><mml:mi mathvariant="bold">D</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup></mml:mrow></mml:math><tex-math id="IEq240_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B} = \mathbf {D}\mathbf {D}^{\dagger}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq240.gif"/></alternatives></inline-formula>, such as a Cholesky factorization (Trefethen and Bau <xref ref-type="bibr" rid="CR84">1997</xref>).</p><p id="Par49">For a magnetic-field formulation, <inline-formula id="IEq241"><alternatives><mml:math id="IEq241_Math"><mml:mi mathvariant="bold">J</mml:mi></mml:math><tex-math id="IEq241_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq241.gif"/></alternatives></inline-formula> is replaced by <inline-formula id="IEq242"><alternatives><mml:math id="IEq242_Math"><mml:mrow><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mi mathvariant="bold">J</mml:mi></mml:mrow></mml:math><tex-math id="IEq242_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\nabla \times \mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq242.gif"/></alternatives></inline-formula> above, but we can simply integrate by parts (Joannopoulos et al. <xref ref-type="bibr" rid="CR35">2008</xref>) to move the <inline-formula id="IEq243"><alternatives><mml:math id="IEq243_Math"><mml:mrow><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mrow/></mml:mrow></mml:math><tex-math id="IEq243_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\nabla \times {}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq243.gif"/></alternatives></inline-formula> curl operation to act on the basis functions, yielding<disp-formula id="Equ23"><label>23</label><alternatives><mml:math display="block" id="Equ23_Math"><mml:mrow><mml:msub><mml:mi>B</mml:mi><mml:mrow><mml:mi mathvariant="italic">mn</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:msub><mml:mi>b</mml:mi><mml:mi>m</mml:mi></mml:msub><mml:msubsup><mml:mi>b</mml:mi><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mo>∫</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>m</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>T</mml:mi></mml:msup><mml:mi mathvariant="bold">C</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mspace width="0.166667em"/><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ23_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$B_{mn} = \langle b_{m} b_{n}^{*} \rangle = \int (\nabla \times \hat{\mathbf {v}}_{m})^{T} \mathbf {C} (\nabla \times \hat{\mathbf {v}}_{n}) \, {\text {d}}\varOmega .$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ23.gif" position="anchor"/></alternatives></disp-formula>Again, this yields a sparse Hermitian semidefinite matrix <inline-formula id="IEq244"><alternatives><mml:math id="IEq244_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq244_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq244.gif"/></alternatives></inline-formula>.</p><p id="Par50">In the 2D examples of Sect. <xref rid="Sec9" ref-type="sec">4</xref>, we employed a magnetic-field formulation with an out-of-plane magnetic field <inline-formula id="IEq245"><alternatives><mml:math id="IEq245_Math"><mml:mrow><mml:mi mathvariant="bold">H</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">z</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:math><tex-math id="IEq245_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H} = H_{z} \hat{\mathbf {z}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq245.gif"/></alternatives></inline-formula> and corresponding basis functions <inline-formula id="IEq246"><alternatives><mml:math id="IEq246_Math"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">z</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:math><tex-math id="IEq246_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{v}}_{n} \hat{\mathbf {z}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq246.gif"/></alternatives></inline-formula>, along with in-plane current sources corresponding to Eq. (<xref rid="Equ20" ref-type="disp-formula">20</xref>). In this case, Eq. (<xref rid="Equ23" ref-type="disp-formula">23</xref>) simplifies to<disp-formula id="Equ24"><label>24</label><alternatives><mml:math display="block" id="Equ24_Math"><mml:mrow><mml:msub><mml:mi>B</mml:mi><mml:mrow><mml:mi mathvariant="italic">mn</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mo>∫</mml:mo><mml:mi>Ω</mml:mi></mml:msub><mml:msubsup><mml:mi>J</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mn>2</mml:mn></mml:msubsup><mml:mfenced close=")" open="("><mml:mi mathvariant="normal">∇</mml:mi><mml:msub><mml:mover accent="true"><mml:mi>v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>m</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:msub><mml:mover accent="true"><mml:mi>v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub></mml:mfenced><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ24_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$B_{mn} =\int _{\varOmega} J_{0}^{2}\left( \nabla {\hat{v}}_{m}\cdot \nabla {\hat{v}}_{n}\right) {\text {d}}\varOmega .$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ24.gif" position="anchor"/></alternatives></disp-formula></p></sec></app><app id="App2"><sec id="Sec15"><title>Appendix 2: Factorization-free trace formulation</title><p id="Par51">Although it is conceptually attractive to use a trace formulation equation (<xref rid="Equ7" ref-type="disp-formula">7</xref>) in terms of the Hermitian matrix <inline-formula id="IEq247"><alternatives><mml:math id="IEq247_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq247_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq247.gif"/></alternatives></inline-formula>, this formulation required a factorization <inline-formula id="IEq248"><alternatives><mml:math id="IEq248_Math"><mml:mrow><mml:mi mathvariant="bold">B</mml:mi><mml:mo>=</mml:mo><mml:mi mathvariant="bold">D</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup></mml:mrow></mml:math><tex-math id="IEq248_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B} = \mathbf {D}\mathbf {D}^{\dagger}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq248.gif"/></alternatives></inline-formula> of the correlation matrix <inline-formula id="IEq249"><alternatives><mml:math id="IEq249_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq249_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq249.gif"/></alternatives></inline-formula>. Computationally, it is desirable to avoid this factorization, especially if the current distribution (and hence <inline-formula id="IEq250"><alternatives><mml:math id="IEq250_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq250_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq250.gif"/></alternatives></inline-formula>) depends on the geometric degrees of freedom <inline-formula id="IEq251"><alternatives><mml:math id="IEq251_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq251_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rho }$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq251.gif"/></alternatives></inline-formula> (which would require us to differentiate through the matrix factorization in our adjoint calculation). Instead, it is straightforward to reformulate our optimization problem equations (<xref rid="Equ11" ref-type="disp-formula">11</xref>) and (<xref rid="Equ15" ref-type="disp-formula">15</xref>) in terms of <inline-formula id="IEq252"><alternatives><mml:math id="IEq252_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq252_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq252.gif"/></alternatives></inline-formula> alone using a change of variables.</p><p id="Par52">For the few-output-channel case in Sect. <xref rid="Sec5" ref-type="sec">2.3</xref>, one can simply start with Eq. (<xref rid="Equ7" ref-type="disp-formula">7</xref>) and rewrite it as <inline-formula id="IEq253"><alternatives><mml:math id="IEq253_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mtext>tr</mml:mtext><mml:mrow><mml:mo stretchy="false">[</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:mrow></mml:math><tex-math id="IEq253_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle P \rangle = {\text {tr}}[ \mathbf {A}^{-\dagger } \mathbf {O} \mathbf {A}^{-1} \mathbf {B} ]$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq253.gif"/></alternatives></inline-formula>, which for a low-rank <inline-formula id="IEq254"><alternatives><mml:math id="IEq254_Math"><mml:mi mathvariant="bold">O</mml:mi></mml:math><tex-math id="IEq254_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {O}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq254.gif"/></alternatives></inline-formula> simplifies, similar to Eq. (<xref rid="Equ11" ref-type="disp-formula">11</xref>), to<disp-formula id="Equ25"><label>25</label><alternatives><mml:math display="block" id="Equ25_Math"><mml:mrow><mml:mi>g</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msubsup><mml:mi mathvariant="bold">u</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:mi mathvariant="bold">B</mml:mi><mml:msub><mml:mi mathvariant="bold">u</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ25_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$g(\rho ) = \langle P \rangle =\sum _{i=1}^{K} \mathbf {u}_{i}^{\dagger} \mathbf {B}\mathbf {u}_{i},$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ25.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq255"><alternatives><mml:math id="IEq255_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msub><mml:mi mathvariant="bold">u</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math><tex-math id="IEq255_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{\dagger} \mathbf {u}_{i}=\mathbf {o}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq255.gif"/></alternatives></inline-formula>, and we have defined the parameter <inline-formula id="IEq256"><alternatives><mml:math id="IEq256_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq256_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq256.gif"/></alternatives></inline-formula> dependence (which can effect both <inline-formula id="IEq257"><alternatives><mml:math id="IEq257_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq257_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq257.gif"/></alternatives></inline-formula> and <inline-formula id="IEq258"><alternatives><mml:math id="IEq258_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq258_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq258.gif"/></alternatives></inline-formula>) as a function <inline-formula id="IEq259"><alternatives><mml:math id="IEq259_Math"><mml:mrow><mml:mi>g</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq259_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$g(\rho )$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq259.gif"/></alternatives></inline-formula> for use in the adjoint formulation of “<xref rid="Sec16" ref-type="sec">Appendix 3</xref>”.</p><p id="Par53">For the many-channel case of Eq. (<xref rid="Equ15" ref-type="disp-formula">15</xref>), the key point is that we can choose <inline-formula id="IEq260"><alternatives><mml:math id="IEq260_Math"><mml:mi mathvariant="bold">V</mml:mi></mml:math><tex-math id="IEq260_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq260.gif"/></alternatives></inline-formula> to be orthogonal to the nullspace <inline-formula id="IEq261"><alternatives><mml:math id="IEq261_Math"><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">D</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq261_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N(\mathbf {D})$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq261.gif"/></alternatives></inline-formula> of <inline-formula id="IEq262"><alternatives><mml:math id="IEq262_Math"><mml:mi mathvariant="bold">D</mml:mi></mml:math><tex-math id="IEq262_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {D}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq262.gif"/></alternatives></inline-formula>, as any nullspace component would contribute nothing to the trace (<inline-formula id="IEq263"><alternatives><mml:math id="IEq263_Math"><mml:mrow><mml:mi mathvariant="bold">D</mml:mi><mml:mi mathvariant="bold">V</mml:mi></mml:mrow></mml:math><tex-math id="IEq263_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {D}\mathbf {V}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq263.gif"/></alternatives></inline-formula> projects it to zero). Equivalently, we can choose <inline-formula id="IEq264"><alternatives><mml:math id="IEq264_Math"><mml:mrow><mml:mi mathvariant="bold">V</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">D</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi>W</mml:mi></mml:mrow></mml:math><tex-math id="IEq264_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {V}=\mathbf {D}^{\dagger} W$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq264.gif"/></alternatives></inline-formula> (<inline-formula id="IEq265"><alternatives><mml:math id="IEq265_Math"><mml:mrow><mml:mo>⊥</mml:mo><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>D</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq265_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\perp N(D)$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq265.gif"/></alternatives></inline-formula> (Lax <xref ref-type="bibr" rid="CR49">2013</xref>) for any <inline-formula id="IEq266"><alternatives><mml:math id="IEq266_Math"><mml:mrow><mml:mi>N</mml:mi><mml:mo>×</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:math><tex-math id="IEq266_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N\times K$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq266.gif"/></alternatives></inline-formula> matrix <inline-formula id="IEq267"><alternatives><mml:math id="IEq267_Math"><mml:mi mathvariant="bold">W</mml:mi></mml:math><tex-math id="IEq267_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {W}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq267.gif"/></alternatives></inline-formula>, and this change of variables yields a new optimization problem:<disp-formula id="Equ26"><label>26</label><alternatives><mml:math display="block" id="Equ26_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd/><mml:mtd columnalign="left"><mml:mrow><mml:mi>g</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msup><mml:mfenced close=")" open="("><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi></mml:mfenced><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:munder><mml:munder accentunder="true"><mml:mfenced close=")" open="("><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi></mml:mfenced><mml:mo>⏟</mml:mo></mml:munder><mml:mi mathvariant="bold">U</mml:mi></mml:munder><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mfenced></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow/></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mspace width="1em"/><mml:mo>=</mml:mo><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mi mathvariant="bold">U</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ26_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned}&amp;g(\rho ,\mathbf {W})={\text {tr}}\left[ \left( \mathbf {A}^{-1}\mathbf {B}\mathbf {W}\right) ^{\dagger} \mathbf {O}\underbrace{\left( \mathbf {A}^{-1}\mathbf {B}\mathbf {W}\right) }_{\mathbf {U}}(\mathbf {W}^{\dagger} \mathbf {B}\mathbf {W})^{-1}\right] \\&amp;\quad ={\text {tr}}\left[ \mathbf {U}^{\dagger} \mathbf {O}\mathbf {U}(\mathbf {W}^{\dagger} \mathbf {B}\mathbf {W})^{-1}\right] , \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ26.gif" position="anchor"/></alternatives></disp-formula>where again we have defined the function <inline-formula id="IEq268"><alternatives><mml:math id="IEq268_Math"><mml:mrow><mml:mi>g</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq268_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$g(\rho ,\mathbf {W})$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq268.gif"/></alternatives></inline-formula> for the parameter and <inline-formula id="IEq269"><alternatives><mml:math id="IEq269_Math"><mml:mi mathvariant="bold">W</mml:mi></mml:math><tex-math id="IEq269_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {W}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq269.gif"/></alternatives></inline-formula> dependence, along with <inline-formula id="IEq270"><alternatives><mml:math id="IEq270_Math"><mml:mrow><mml:mi mathvariant="bold">U</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">BW</mml:mi></mml:mrow></mml:math><tex-math id="IEq270_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {U} = \mathbf {A}^{-1} \mathbf {BW}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq270.gif"/></alternatives></inline-formula>, for use in the adjoint formulation of “<xref rid="Sec16" ref-type="sec">Appendix 3</xref>”.</p></sec></app><app id="App3"><sec id="Sec16"><title>Appendix 3: Numerical formulation</title><p id="Par54">In this section, we provide details of the mathematical formulation and numerical implementation of the examples in Sect. <xref rid="Sec9" ref-type="sec">4</xref>, including the adjoint analysis.</p><p id="Par55">We employ the frequency-domain Maxwell equations for the magnetic field <inline-formula id="IEq271"><alternatives><mml:math id="IEq271_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq271_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq271.gif"/></alternatives></inline-formula> arising from an electric current <inline-formula id="IEq272"><alternatives><mml:math id="IEq272_Math"><mml:mi mathvariant="bold">J</mml:mi></mml:math><tex-math id="IEq272_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq272.gif"/></alternatives></inline-formula> with a dielectric function (relative permittivity) <inline-formula id="IEq273"><alternatives><mml:math id="IEq273_Math"><mml:mi>ε</mml:mi></mml:math><tex-math id="IEq273_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varepsilon$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq273.gif"/></alternatives></inline-formula> and a relative magnetic permeability <inline-formula id="IEq274"><alternatives><mml:math id="IEq274_Math"><mml:mi>μ</mml:mi></mml:math><tex-math id="IEq274_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq274.gif"/></alternatives></inline-formula>:<disp-formula id="Equ27"><label>27</label><alternatives><mml:math display="block" id="Equ27_Math"><mml:mrow><mml:mfenced close="]" open="["><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>ε</mml:mi></mml:mfrac><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mo>-</mml:mo><mml:msup><mml:mfenced close=")" open="("><mml:mfrac><mml:mi>ω</mml:mi><mml:mi>c</mml:mi></mml:mfrac></mml:mfenced><mml:mn>2</mml:mn></mml:msup><mml:mi>μ</mml:mi></mml:mfenced><mml:mi mathvariant="bold">H</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mfenced close="]" open="["><mml:mfrac><mml:mn>1</mml:mn><mml:mi>ε</mml:mi></mml:mfrac><mml:mi mathvariant="bold">J</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ27_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left[ \nabla \times \frac{1}{\varepsilon }\nabla \times -\left( \frac{\omega }{c}\right) ^{2}\mu \right] \mathbf {H}(\mathbf {x})=\nabla \times \left[ \frac{1}{\varepsilon }\mathbf {J}(\mathbf {x})\right] .$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ27.gif" position="anchor"/></alternatives></disp-formula>For 2D (<italic>z</italic>-invariant) problems, we chose in-plane currents <inline-formula id="IEq275"><alternatives><mml:math id="IEq275_Math"><mml:mi mathvariant="bold">J</mml:mi></mml:math><tex-math id="IEq275_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq275.gif"/></alternatives></inline-formula>, so that the resulting magnetic fields <inline-formula id="IEq276"><alternatives><mml:math id="IEq276_Math"><mml:mrow><mml:mi mathvariant="bold">H</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold">z</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:math><tex-math id="IEq276_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}=H_{z}\hat{\mathbf {z}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq276.gif"/></alternatives></inline-formula> are polarized purely in the <italic>z</italic>-direction (Joannopoulos et al. <xref ref-type="bibr" rid="CR35">2008</xref>). In this case, Eq. (<xref rid="Equ27" ref-type="disp-formula">27</xref>) simplifies to a scalar Helmholtz equation:<disp-formula id="Equ28"><label>28</label><alternatives><mml:math display="block" id="Equ28_Math"><mml:mrow><mml:mfenced close="]" open="["><mml:mo>-</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>·</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>ε</mml:mi></mml:mfrac><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>-</mml:mo><mml:msup><mml:mfenced close=")" open="("><mml:mfrac><mml:mi>ω</mml:mi><mml:mi>c</mml:mi></mml:mfrac></mml:mfenced><mml:mn>2</mml:mn></mml:msup><mml:mi>μ</mml:mi></mml:mfenced><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfenced close=")" open="("><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mfenced close="]" open="["><mml:mfrac><mml:mn>1</mml:mn><mml:mi>ε</mml:mi></mml:mfrac><mml:mi mathvariant="bold">J</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfenced></mml:mfenced><mml:mo>·</mml:mo><mml:mover accent="true"><mml:mi mathvariant="bold">z</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ28_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left[ -\nabla \cdot \frac{1}{\varepsilon }\nabla -\left( \frac{\omega }{c}\right) ^{2}\mu \right] H_{z}=\left( \nabla \times \left[ \frac{1}{\varepsilon }\mathbf {J}(\mathbf {x})\right] \right) \cdot \hat{\mathbf {z}}.$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ28.gif" position="anchor"/></alternatives></disp-formula>Note that, for the correlation functions in the previous discussion, we simplified the right-hand side by absorbing the <inline-formula id="IEq277"><alternatives><mml:math id="IEq277_Math"><mml:mrow><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:mi>ε</mml:mi></mml:mrow></mml:math><tex-math id="IEq277_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$1/\varepsilon$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq277.gif"/></alternatives></inline-formula> scaling into <inline-formula id="IEq278"><alternatives><mml:math id="IEq278_Math"><mml:mi mathvariant="bold">J</mml:mi></mml:math><tex-math id="IEq278_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {J}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq278.gif"/></alternatives></inline-formula>.</p><p id="Par56">We employ perfectly matched layers (PMLs) for absorbing boundaries, with Dirichlet (<inline-formula id="IEq279"><alternatives><mml:math id="IEq279_Math"><mml:mrow><mml:mi>u</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math><tex-math id="IEq279_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$u=0$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq279.gif"/></alternatives></inline-formula>) boundary conditions behind the PML. The implementation of the “stretched-coordinate” PML is simply a replacement <inline-formula id="IEq280"><alternatives><mml:math id="IEq280_Math"><mml:mrow><mml:mi mathvariant="normal">∇</mml:mi><mml:mo stretchy="false">→</mml:mo><mml:mi>Λ</mml:mi><mml:mi mathvariant="normal">∇</mml:mi></mml:mrow></mml:math><tex-math id="IEq280_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\nabla \rightarrow \varLambda \nabla$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq280.gif"/></alternatives></inline-formula> in Eq. (<xref rid="Equ28" ref-type="disp-formula">28</xref>) (Oskooi and Johnson <xref ref-type="bibr" rid="CR64">2011</xref>; Jin <xref ref-type="bibr" rid="CR34">2014</xref>):<disp-formula id="Equ29"><label>29</label><alternatives><mml:math display="block" id="Equ29_Math"><mml:mrow><mml:mfenced close="]" open="["><mml:mo>-</mml:mo><mml:mi>Λ</mml:mi><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>·</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>ε</mml:mi></mml:mfrac><mml:mi>Λ</mml:mi><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>-</mml:mo><mml:msup><mml:mfenced close=")" open="("><mml:mfrac><mml:mi>ω</mml:mi><mml:mi>c</mml:mi></mml:mfrac></mml:mfenced><mml:mn>2</mml:mn></mml:msup><mml:mi>μ</mml:mi></mml:mfenced><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfenced close=")" open="("><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mfenced close="]" open="["><mml:mfrac><mml:mn>1</mml:mn><mml:mi>ε</mml:mi></mml:mfrac><mml:mi mathvariant="bold">J</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfenced></mml:mfenced><mml:mo>·</mml:mo><mml:mover accent="true"><mml:mi mathvariant="bold">z</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ29_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left[ -\varLambda \nabla \cdot \frac{1}{\varepsilon }\varLambda \nabla -\left( \frac{\omega }{c}\right) ^{2}\mu \right] H_{z}=\left( \nabla \times \left[ \frac{1}{\varepsilon }\mathbf {J}(\mathbf {x})\right] \right) \cdot \hat{\mathbf {z}},$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ29.gif" position="anchor"/></alternatives></disp-formula>where<disp-formula id="Equ30"><label>30</label><alternatives><mml:math display="block" id="Equ30_Math"><mml:mrow><mml:mi>Λ</mml:mi><mml:mo>=</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mtext>i</mml:mtext><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mi>x</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo stretchy="false">/</mml:mo><mml:mi>ω</mml:mi></mml:mrow></mml:mfrac></mml:mtd><mml:mtd><mml:mrow/></mml:mtd><mml:mtd><mml:mrow/></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow/></mml:mtd><mml:mtd><mml:mrow><mml:mrow/><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mtext>i</mml:mtext><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mi>y</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo stretchy="false">/</mml:mo><mml:mi>ω</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mtd><mml:mtd><mml:mrow/></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow/></mml:mtd><mml:mtd><mml:mrow/></mml:mtd><mml:mtd><mml:mrow><mml:mrow/><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mtext>i</mml:mtext><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo stretchy="false">/</mml:mo><mml:mi>ω</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ30_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varLambda = \begin{pmatrix} \frac{1}{1+{\text {i}}{\sigma _x(\mathbf {x})}/{\omega }} &amp;{} &amp;{} \\ &amp;{} \frac{1}{1+{\text {i}}{\sigma _y(\mathbf {x})}/{\omega }} &amp;{} \\ &amp;{} &amp;{} \frac{1}{1+{\text {i}}{\sigma _{z}(\mathbf {x})}/{\omega }} \end{pmatrix}.$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ30.gif" position="anchor"/></alternatives></disp-formula>The PML conductivity <inline-formula id="IEq281"><alternatives><mml:math id="IEq281_Math"><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mi>ℓ</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><tex-math id="IEq281_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma _{\ell} (\mathbf {x})$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq281.gif"/></alternatives></inline-formula>, <inline-formula id="IEq282"><alternatives><mml:math id="IEq282_Math"><mml:mrow><mml:mi>ℓ</mml:mi><mml:mo>=</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:math><tex-math id="IEq282_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\ell =x,y,z$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq282.gif"/></alternatives></inline-formula> function is used to gradually “turn on” the PML to compensate for discretization errors (Oskooi and Johnson <xref ref-type="bibr" rid="CR64">2011</xref>), and we use a quadratic profile <inline-formula id="IEq283"><alternatives><mml:math id="IEq283_Math"><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mi>ℓ</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>σ</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mtext>PML</mml:mtext></mml:msub><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>d</mml:mi><mml:mtext>PML</mml:mtext></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:math><tex-math id="IEq283_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma _{\ell} (\mathbf {x})=\sigma _{0}(x_{{\text {PML}}}/d_{{\text {PML}}})^{2}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq283.gif"/></alternatives></inline-formula> (where <inline-formula id="IEq284"><alternatives><mml:math id="IEq284_Math"><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mtext>PML</mml:mtext></mml:msub><mml:mo>∈</mml:mo><mml:mrow><mml:mo stretchy="false">[</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:msub><mml:mi>d</mml:mi><mml:mtext>PML</mml:mtext></mml:msub><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:mrow></mml:math><tex-math id="IEq284_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$x_{{\text {PML}}} \in [0,d_{{\text {PML}}}]$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq284.gif"/></alternatives></inline-formula> is the distance inside the PML).</p><sec id="Sec17"><title>C.1: Fluorescent particle</title><p id="Par57">For the problem of Sect. <xref rid="Sec10" ref-type="sec">4.1</xref>, the governing equation is exactly Eq. (<xref rid="Equ29" ref-type="disp-formula">29</xref>) with <inline-formula id="IEq285"><alternatives><mml:math id="IEq285_Math"><mml:mrow><mml:mi>μ</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><tex-math id="IEq285_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu = 1$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq285.gif"/></alternatives></inline-formula>, whose weak form is (Jin <xref ref-type="bibr" rid="CR34">2014</xref>):<disp-formula id="Equ31"><label>31</label><alternatives><mml:math display="block" id="Equ31_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi>a</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi>b</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mi>a</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:msub><mml:mo>∫</mml:mo><mml:mi>Ω</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mi>Λ</mml:mi><mml:mi>v</mml:mi><mml:mo>·</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>ε</mml:mi></mml:mfrac><mml:mi>Λ</mml:mi><mml:mi mathvariant="normal">∇</mml:mi><mml:mi>u</mml:mi><mml:mo>-</mml:mo><mml:msubsup><mml:mi>k</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mn>2</mml:mn></mml:msubsup><mml:mi>v</mml:mi><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mi>b</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:msub><mml:mo>∫</mml:mo><mml:mi>Ω</mml:mi></mml:msub><mml:mi>v</mml:mi><mml:mi>f</mml:mi><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ31_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} a(u,v)= &amp; {} b(v), \\ a(u,v)= &amp; {} \int _{\varOmega} (\nabla \varLambda v\cdot \frac{1}{\varepsilon }\varLambda \nabla u-k_{0}^{2} vu){\text {d}}\varOmega , \\ b(v)= &amp; {} \int _{\varOmega} vf{\text {d}}\varOmega , \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ31.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq286"><alternatives><mml:math id="IEq286_Math"><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:mi>ω</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>c</mml:mi></mml:mrow></mml:math><tex-math id="IEq286_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k_{0}=\omega /c$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq286.gif"/></alternatives></inline-formula> is the free-space wave number, <inline-formula id="IEq287"><alternatives><mml:math id="IEq287_Math"><mml:mrow><mml:mi>f</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>×</mml:mo><mml:mi mathvariant="bold">J</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>·</mml:mo><mml:mover accent="true"><mml:mi mathvariant="bold">z</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:math><tex-math id="IEq287_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f=(\nabla \times \mathbf {J})\cdot \hat{\mathbf {z}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq287.gif"/></alternatives></inline-formula> is the source term, and <inline-formula id="IEq288"><alternatives><mml:math id="IEq288_Math"><mml:mrow><mml:mi mathvariant="normal">∇</mml:mi><mml:mi>Λ</mml:mi></mml:mrow></mml:math><tex-math id="IEq288_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\nabla \varLambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq288.gif"/></alternatives></inline-formula> denotes the linear operator <inline-formula id="IEq289"><alternatives><mml:math id="IEq289_Math"><mml:mrow><mml:mi mathvariant="normal">∇</mml:mi><mml:mi>Λ</mml:mi><mml:mi>u</mml:mi><mml:mo>=</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>Λ</mml:mi><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><tex-math id="IEq289_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\nabla \varLambda u = \nabla (\varLambda u)$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq289.gif"/></alternatives></inline-formula>. The matrix <inline-formula id="IEq290"><alternatives><mml:math id="IEq290_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq290_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq290.gif"/></alternatives></inline-formula> and the source vector <inline-formula id="IEq291"><alternatives><mml:math id="IEq291_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq291_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq291.gif"/></alternatives></inline-formula> for the discretized Maxwell equation (<xref rid="Equ2" ref-type="disp-formula">2</xref>) are obtained by replacing <italic>u</italic> and <italic>v</italic> with the finite-element basis functions <inline-formula id="IEq292"><alternatives><mml:math id="IEq292_Math"><mml:msub><mml:mover accent="true"><mml:mi>u</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub></mml:math><tex-math id="IEq292_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{u}}_{n}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq292.gif"/></alternatives></inline-formula> and <inline-formula id="IEq293"><alternatives><mml:math id="IEq293_Math"><mml:msub><mml:mover accent="true"><mml:mi>v</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub></mml:math><tex-math id="IEq293_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{v}}_{n}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq293.gif"/></alternatives></inline-formula>, using first-order Lagrange elements on a triangular mesh (Jin <xref ref-type="bibr" rid="CR34">2014</xref>). The mesh was generated with Gmsh (Geuzaine and Remacle <xref ref-type="bibr" rid="CR22">2009</xref>), corresponding to a spatial resolution of roughly <inline-formula id="IEq294"><alternatives><mml:math id="IEq294_Math"><mml:mrow><mml:mi>λ</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mn>40</mml:mn></mml:mrow></mml:math><tex-math id="IEq294_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda /40$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq294.gif"/></alternatives></inline-formula> in the air and <inline-formula id="IEq295"><alternatives><mml:math id="IEq295_Math"><mml:mrow><mml:mi>λ</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mn>80</mml:mn></mml:mrow></mml:math><tex-math id="IEq295_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda /80$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq295.gif"/></alternatives></inline-formula> in the design region.</p><p id="Par58">Notice that in Eq. (<xref rid="Equ26" ref-type="disp-formula">26</xref>), only <inline-formula id="IEq296"><alternatives><mml:math id="IEq296_Math"><mml:mi mathvariant="bold">U</mml:mi></mml:math><tex-math id="IEq296_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {U}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq296.gif"/></alternatives></inline-formula> (via <inline-formula id="IEq297"><alternatives><mml:math id="IEq297_Math"><mml:mi mathvariant="bold">A</mml:mi></mml:math><tex-math id="IEq297_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq297.gif"/></alternatives></inline-formula>) and <inline-formula id="IEq298"><alternatives><mml:math id="IEq298_Math"><mml:mi mathvariant="bold">B</mml:mi></mml:math><tex-math id="IEq298_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {B}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq298.gif"/></alternatives></inline-formula> (describing emission only in the dielectric) depend on the design parameters <inline-formula id="IEq299"><alternatives><mml:math id="IEq299_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq299_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq299.gif"/></alternatives></inline-formula>. We have now the optimization problem as follows:<disp-formula id="Equ32"><label>32</label><alternatives><mml:math display="block" id="Equ32_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi>g</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:munder><mml:mo movablelimits="true">max</mml:mo><mml:mrow><mml:mi>ρ</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">W</mml:mi></mml:mrow></mml:munder><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:mi mathvariant="bold">U</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mi mathvariant="bold">U</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mi mathvariant="bold">U</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="bold">A</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">W</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mn>0</mml:mn><mml:mo>≤</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi>ρ</mml:mi><mml:mo>≤</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mo>∫</mml:mo><mml:mi>ρ</mml:mi><mml:mtext>d</mml:mtext><mml:msub><mml:mi>Ω</mml:mi><mml:mtext>d</mml:mtext></mml:msub><mml:mo>&lt;</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mo>∫</mml:mo><mml:msub><mml:mi>R</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mtext>d</mml:mtext><mml:msub><mml:mi>Ω</mml:mi><mml:mtext>d</mml:mtext></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ32_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} g(\rho ,\mathbf {W})= &amp; {} \max _{\rho ,\mathbf {W}}{\text {tr}}\left[ \mathbf {U}(\rho )^{\dagger} \mathbf {O}\mathbf {U}(\rho )(\mathbf {W}^{\dagger} \mathbf {B}(\rho )\mathbf {W})^{-1}\right] , \\ \mathbf {U}(\rho )= &amp; {} \mathbf {A}(\rho )^{-1}\mathbf {B}(\rho )\mathbf {W}, \\ 0\le &amp; {} \rho \le 1, \\ \int \rho {\text {d}}\varOmega _{\text {d}}&lt; &amp; {} \int R_f{\text {d}}\varOmega _{\text {d}}, \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ32.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq300"><alternatives><mml:math id="IEq300_Math"><mml:msub><mml:mi>R</mml:mi><mml:mtext>f</mml:mtext></mml:msub></mml:math><tex-math id="IEq300_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$R_{\text {f}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq300.gif"/></alternatives></inline-formula> is the area-filling ratio.</p><p id="Par59">Applying adjoint-method analysis (Molesky et al. <xref ref-type="bibr" rid="CR59">2018</xref>; Tortorelli and Michaleris <xref ref-type="bibr" rid="CR83">1994</xref>), we obtain the partial derivatives:<disp-formula id="Equ33"><label>33</label><alternatives><mml:math display="block" id="Equ33_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd/><mml:mtd columnalign="left"><mml:mrow><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi>ρ</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mo>-</mml:mo><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mi mathvariant="bold">U</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mfenced close=")" open="("><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:mfrac><mml:mi mathvariant="bold">W</mml:mi></mml:mfenced><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mfenced></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow/></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mspace width="1em"/><mml:mo>-</mml:mo><mml:mn>2</mml:mn><mml:mtext>Re</mml:mtext><mml:mfenced close="}" open="{"><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msup><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mfenced close=")" open="("><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi>ρ</mml:mi></mml:mrow></mml:mfrac><mml:mi mathvariant="bold">U</mml:mi><mml:mo>-</mml:mo><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi>ρ</mml:mi></mml:mrow></mml:mfrac><mml:mi mathvariant="bold">W</mml:mi></mml:mfenced></mml:mfenced></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ33_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned}&amp;\frac{\partial g}{\partial \rho }=-{\text {tr}}\left[ \mathbf {U}^{\dagger} \mathbf {O}\mathbf {U}(\mathbf {W}^{\dagger} \mathbf {B}\mathbf {W})^{-1}\left( \mathbf {W}^{\dagger} \frac{\partial \mathbf {B}}{\partial p}\mathbf {W}\right) (\mathbf {W}^{\dagger} \mathbf {B}\mathbf {W})^{-1}\right] \\&amp;\quad -2{\text {Re}}\left\{ {\text {tr}}\left[ \mathbf {Z}^{\dagger} \left( \frac{\partial \mathbf {A}}{\partial \rho }\mathbf {U}-\frac{\partial \mathbf {B}}{\partial \rho }\mathbf {W}\right) \right] \right\} , \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ33.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq301"><alternatives><mml:math id="IEq301_Math"><mml:mi mathvariant="bold">Z</mml:mi></mml:math><tex-math id="IEq301_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {Z}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq301.gif"/></alternatives></inline-formula> is the result of an adjoint solve:<disp-formula id="Equ34"><label>34</label><alternatives><mml:math display="block" id="Equ34_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">Z</mml:mi><mml:mo>=</mml:mo><mml:mi mathvariant="bold">O</mml:mi><mml:mi mathvariant="bold">U</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ34_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{\dagger} \mathbf {Z}=\mathbf {O}\mathbf {U}(\mathbf {W}^{\dagger} \mathbf {B}\mathbf {W})^{-1}.$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ34.gif" position="anchor"/></alternatives></disp-formula>The partial derivative with respect to <inline-formula id="IEq302"><alternatives><mml:math id="IEq302_Math"><mml:mi mathvariant="bold">W</mml:mi></mml:math><tex-math id="IEq302_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {W}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq302.gif"/></alternatives></inline-formula> is simply obtained via matrix (Petersen and Pedersen <xref ref-type="bibr" rid="CR69">2012</xref>) CR calculus (Kreutz-Delgado <xref ref-type="bibr" rid="CR44">2009</xref>):<disp-formula id="Equ35"><label>35</label><alternatives><mml:math display="block" id="Equ35_Math"><mml:mrow><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi mathvariant="bold">W</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mfenced close="]" open="["><mml:mi mathvariant="bold">I</mml:mi><mml:mo>-</mml:mo><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup></mml:mfenced><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mi mathvariant="bold">U</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ35_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\frac{\partial g}{\partial \mathbf {W}}=\left[ \mathbf {I}-\mathbf {B}\mathbf {W}(\mathbf {W}^{\dagger} \mathbf {B}\mathbf {W})^{-1}\mathbf {W}^{\dagger} \right] (\mathbf {A}^{-1}\mathbf {B})^{\dagger} \mathbf {O}\mathbf {U}(\mathbf {W}^{\dagger} \mathbf {B}\mathbf {W})^{-1}.$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ35.gif" position="anchor"/></alternatives></disp-formula>We validated the derivatives from the adjoint method against finite differences at random points, and found that the relative error was only about <inline-formula id="IEq303"><alternatives><mml:math id="IEq303_Math"><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:math><tex-math id="IEq303_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$10^{-6}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq303.gif"/></alternatives></inline-formula> or less, which is not a problem for the CCSA algorithm when converging the optimum to only a few decimal places.</p><p id="Par60">The analysis workflow for this example is shown in Fig. <xref rid="Fig4" ref-type="fig">4</xref>. This CCSA update is implemented with NLopt in Julia (Johnson <xref ref-type="bibr" rid="CR38">2021</xref>) for an increasing series of <inline-formula id="IEq304"><alternatives><mml:math id="IEq304_Math"><mml:mrow><mml:mi>β</mml:mi><mml:mo>=</mml:mo><mml:mn>5</mml:mn><mml:mo>,</mml:mo><mml:mn>10</mml:mn><mml:mo>,</mml:mo><mml:mn>20</mml:mn><mml:mo>,</mml:mo><mml:mn>40</mml:mn><mml:mo>,</mml:mo><mml:mn>80</mml:mn></mml:mrow></mml:math><tex-math id="IEq304_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta =5, 10, 20, 40, 80$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq304.gif"/></alternatives></inline-formula>. And for each <inline-formula id="IEq305"><alternatives><mml:math id="IEq305_Math"><mml:mi>β</mml:mi></mml:math><tex-math id="IEq305_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq305.gif"/></alternatives></inline-formula>, the loop is terminated either a relative difference of <inline-formula id="IEq306"><alternatives><mml:math id="IEq306_Math"><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>8</mml:mn></mml:mrow></mml:msup></mml:math><tex-math id="IEq306_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$10^{-8}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq306.gif"/></alternatives></inline-formula> is achieved or the maximum iteration reaches 200. The design parameter <inline-formula id="IEq307"><alternatives><mml:math id="IEq307_Math"><mml:mi>ρ</mml:mi></mml:math><tex-math id="IEq307_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\rho$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq307.gif"/></alternatives></inline-formula> is bounded from 0 to 1.<fig id="Fig4"><label>Fig. 4</label><caption xml:lang="en"><p>Flowchart of the optimization steps for the fluorescent particle and periodic emitting surface examples</p></caption><graphic specific-use="web" mime-subtype="PNG" xlink:href="MediaObjects/158_2022_3389_Fig4_HTML.png" position="anchor" id="MO39"/></fig></p></sec><sec id="Sec18"><title>C.2: Periodic emitting surface</title><p id="Par61">For the problem of Sect. <xref rid="Sec11" ref-type="sec">4.2</xref>, we simulate a single unit cell with Bloch-periodic boundary conditions in <italic>x</italic>. Since Gridap only supports periodic boundary conditions in its current version, we make a change of variables <inline-formula id="IEq308"><alternatives><mml:math id="IEq308_Math"><mml:mrow><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:mo stretchy="false">→</mml:mo><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:msup><mml:mrow><mml:mtext>e</mml:mtext></mml:mrow><mml:mrow><mml:mtext>i</mml:mtext><mml:mi>k</mml:mi><mml:mi>x</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><tex-math id="IEq308_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{z} \rightarrow H_{z} {\text {e}}^{{\text {i}}kx}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq308.gif"/></alternatives></inline-formula> so that <inline-formula id="IEq309"><alternatives><mml:math id="IEq309_Math"><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub></mml:math><tex-math id="IEq309_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{z}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq309.gif"/></alternatives></inline-formula> is the periodic “Bloch envelope” function (Joannopoulos et al. <xref ref-type="bibr" rid="CR35">2008</xref>). In comparison to Eq. (<xref rid="Equ28" ref-type="disp-formula">28</xref>) in “Appendix C.1,” this corresponds to the transformation <inline-formula id="IEq310"><alternatives><mml:math id="IEq310_Math"><mml:mrow><mml:mi mathvariant="normal">∇</mml:mi><mml:mo stretchy="false">→</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>+</mml:mo><mml:mtext>i</mml:mtext><mml:mi>k</mml:mi><mml:mover accent="true"><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:math><tex-math id="IEq310_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\nabla \rightarrow \nabla + {\text {i}}k\hat{\mathbf {x}}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq310.gif"/></alternatives></inline-formula> (Joannopoulos et al. <xref ref-type="bibr" rid="CR35">2008</xref>):<disp-formula id="Equ36"><label>36</label><alternatives><mml:math display="block" id="Equ36_Math"><mml:mrow><mml:mfenced close="]" open="["><mml:mo>-</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>+</mml:mo><mml:mtext>i</mml:mtext><mml:mi>k</mml:mi><mml:mover accent="true"><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>·</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>ε</mml:mi></mml:mfrac><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>+</mml:mo><mml:mtext>i</mml:mtext><mml:mi>k</mml:mi><mml:mover accent="true"><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>-</mml:mo><mml:msubsup><mml:mi>k</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mn>2</mml:mn></mml:msubsup></mml:mfenced><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>f</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ36_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left[ -(\nabla +{\text {i}}k\hat{\mathbf {x}})\cdot \frac{1}{\varepsilon }(\nabla +{\text {i}}k\hat{\mathbf {x}}) -k_{0}^{2}\right] H_{z} = f,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ36.gif" position="anchor"/></alternatives></disp-formula>with periodic boundaries in <italic>x</italic>, of which weak form (including PML in <italic>y</italic>) can then be obtained via integration by parts:<disp-formula id="Equ37"><label>37</label><alternatives><mml:math display="block" id="Equ37_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi>a</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi>b</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mi>a</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:msub><mml:mo>∫</mml:mo><mml:mi>Ω</mml:mi></mml:msub><mml:mfenced close="]" open="["><mml:mfenced close=")" open="("><mml:mi mathvariant="normal">∇</mml:mi><mml:mi>Λ</mml:mi><mml:mo>-</mml:mo><mml:mtext>i</mml:mtext><mml:mi>k</mml:mi><mml:mover accent="true"><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mfenced><mml:mi>v</mml:mi><mml:mo>·</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>ε</mml:mi></mml:mfrac><mml:mo>·</mml:mo><mml:mfenced close=")" open="("><mml:mi>Λ</mml:mi><mml:mi mathvariant="normal">∇</mml:mi><mml:mo>+</mml:mo><mml:mtext>i</mml:mtext><mml:mi>k</mml:mi><mml:mover accent="true"><mml:mi mathvariant="bold">x</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mfenced><mml:mi>u</mml:mi><mml:mo>-</mml:mo><mml:msubsup><mml:mi>k</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mn>2</mml:mn></mml:msubsup><mml:mi>v</mml:mi><mml:mi>u</mml:mi></mml:mfenced><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mi>b</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:msub><mml:mo>∫</mml:mo><mml:mi>Ω</mml:mi></mml:msub><mml:mi>v</mml:mi><mml:mi>f</mml:mi><mml:mtext>d</mml:mtext><mml:mi>Ω</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ37_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} a(u,v)= &amp; {} b(v), \\ a(u,v)= &amp; {} \int _{\varOmega} \left[ \left( \nabla \varLambda -{\text {i}}k\hat{\mathbf {x}}\right) v\cdot \frac{1}{\varepsilon }\cdot \left( \varLambda \nabla +{\text {i}}k\hat{\mathbf {x}}\right) u-k_{0}^{2} vu\right] {\text {d}}\varOmega , \\ b(v)= &amp; {} \int _{\varOmega} vf{\text {d}}\varOmega , \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ37.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq311"><alternatives><mml:math id="IEq311_Math"><mml:mi>Λ</mml:mi></mml:math><tex-math id="IEq311_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varLambda$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq311.gif"/></alternatives></inline-formula> is the diagonal PML “stretching” matrix equation (<xref rid="Equ30" ref-type="disp-formula">C12</xref>).</p><p id="Par62">The objective (average power) is then constructed by a Brillouin-zone integration over the Bloch wavevector <italic>k</italic> (Capolino et al. <xref ref-type="bibr" rid="CR11">2007</xref>):<disp-formula id="Equ38"><label>38</label><alternatives><mml:math display="block" id="Equ38_Math"><mml:mrow><mml:mi>g</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mi>L</mml:mi><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi></mml:mrow></mml:mfrac><mml:msubsup><mml:mo>∫</mml:mo><mml:mrow><mml:mo>-</mml:mo><mml:mi>π</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>L</mml:mi></mml:mrow><mml:mrow><mml:mi>π</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msubsup><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msup><mml:mfenced close=")" open="("><mml:msubsup><mml:mi mathvariant="bold">A</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mi mathvariant="bold">D</mml:mi></mml:mfenced><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:mfenced close=")" open="("><mml:msubsup><mml:mi mathvariant="bold">A</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mi mathvariant="bold">D</mml:mi></mml:mfenced></mml:mfenced><mml:mtext>d</mml:mtext><mml:mi>k</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ38_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$g(\rho )=\frac{L}{2\pi }\int _{-\pi /L}^{\pi /L}{\text {tr}}\left[ \left( \mathbf {A}_{k}^{-1}\mathbf {D}\right) ^{\dagger} \mathbf {O}\left( \mathbf {A}_{k}^{-1}\mathbf {D}\right) \right] {\text {d}}k,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ38.gif" position="anchor"/></alternatives></disp-formula>where <italic>L</italic> is the period of the unit cell and <inline-formula id="IEq312"><alternatives><mml:math id="IEq312_Math"><mml:msub><mml:mi mathvariant="bold">A</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:math><tex-math id="IEq312_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}_{k}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq312.gif"/></alternatives></inline-formula> is assembled using Eq. (<xref rid="Equ37" ref-type="disp-formula">37</xref>). Since this integrand is a periodic function of <italic>k</italic>, the integral can be approximated by a simple trapezoidal sum over equally spaced points <italic>k</italic> with exponential accuracy (Trefethen and Weideman <xref ref-type="bibr" rid="CR85">2014</xref>); we used 100 <italic>k</italic> points in order to resolve sharp resonances.</p><p id="Par63">Commuting the integral and the trace in Eq. (<xref rid="Equ38" ref-type="disp-formula">38</xref>), similarly to “<xref rid="Sec15" ref-type="sec">Appendix 2</xref>” (noting that <inline-formula id="IEq313"><alternatives><mml:math id="IEq313_Math"><mml:mrow><mml:mo>∫</mml:mo><mml:mtext>tr</mml:mtext><mml:mo>=</mml:mo><mml:mtext>tr</mml:mtext><mml:mo>∫</mml:mo></mml:mrow></mml:math><tex-math id="IEq313_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\int {\text {tr}}= {\text {tr}}\int$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq313.gif"/></alternatives></inline-formula>), we obtain<disp-formula id="Equ39"><label>39</label><alternatives><mml:math display="block" id="Equ39_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi>g</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:munder><mml:mo movablelimits="true">max</mml:mo><mml:mrow><mml:mi>ρ</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">W</mml:mi></mml:mrow></mml:munder><mml:mfrac><mml:mi>L</mml:mi><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi></mml:mrow></mml:mfrac><mml:msubsup><mml:mo>∫</mml:mo><mml:mrow><mml:mo>-</mml:mo><mml:mi>π</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>L</mml:mi></mml:mrow><mml:mrow><mml:mi>π</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msubsup><mml:mtext>tr</mml:mtext><mml:mfenced close="]" open="["><mml:msub><mml:mi mathvariant="bold">U</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">O</mml:mi><mml:msub><mml:mi mathvariant="bold">U</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">W</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">W</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mfenced><mml:mtext>d</mml:mtext><mml:mi>k</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:msub><mml:mi mathvariant="bold">U</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:msub><mml:mi mathvariant="bold">A</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">W</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mn>0</mml:mn><mml:mo>≤</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi>ρ</mml:mi><mml:mo>≤</mml:mo><mml:mn>1</mml:mn><mml:mo>.</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ39_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} g(\rho ,\mathbf {W})= &amp; {} \max _{\rho ,\mathbf {W}}\frac{L}{2\pi }\int _{-\pi /L}^{\pi /L}{\text {tr}}\left[ \mathbf {U}_{k}(\rho )^{\dagger} \mathbf {O}\mathbf {U}_{k}(\rho )(\mathbf {W}^{\dagger} \mathbf {B}(\rho )\mathbf {W})^{-1}\right] {\text {d}}k , \\ \mathbf {U}_{k}(\rho )= &amp; {} \mathbf {A}_{k}(\rho )^{-1}\mathbf {B}(\rho )\mathbf {W}, \\ 0\le &amp; {} \rho \le 1. \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ39.gif" position="anchor"/></alternatives></disp-formula>The adjoint analysis for Eq. (<xref rid="Equ39" ref-type="disp-formula">39</xref>) is almost the same as in “Appendix C.1,” except for the additional integration over <italic>k</italic>. Also, it shares the same analysis workflow as in “Appendix C.1.”</p></sec><sec id="Sec19"><title>C.3: Emission into a waveguide</title><p id="Par64">For the problem of Sect. <xref rid="Sec12" ref-type="sec">4.3</xref>, the governing equation and the weak form are identical to “Appendix C.1.” The main difference is our objective function, which is now the power in a waveguide mode, computed via an overlap integral using mode orthogonality (Snyder and Love <xref ref-type="bibr" rid="CR81">1983</xref>), rather than a total Poynting flux. Here, we briefly review how this overlap integral is implemented in the finite-element method.</p><p id="Par65">For a propagating waveguide mode with electric and magnetic fields <inline-formula id="IEq314"><alternatives><mml:math id="IEq314_Math"><mml:msub><mml:mi mathvariant="bold">e</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><tex-math id="IEq314_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {e}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq314.gif"/></alternatives></inline-formula> and <inline-formula id="IEq315"><alternatives><mml:math id="IEq315_Math"><mml:msub><mml:mi mathvariant="bold">h</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><tex-math id="IEq315_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {h}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq315.gif"/></alternatives></inline-formula>, the modal-expansion coefficient <inline-formula id="IEq316"><alternatives><mml:math id="IEq316_Math"><mml:msub><mml:mi>α</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><tex-math id="IEq316_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq316.gif"/></alternatives></inline-formula> of that mode for a total magnetic field <inline-formula id="IEq317"><alternatives><mml:math id="IEq317_Math"><mml:mi mathvariant="bold">H</mml:mi></mml:math><tex-math id="IEq317_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {H}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq317.gif"/></alternatives></inline-formula> is given by the overlap integral (Snyder and Love <xref ref-type="bibr" rid="CR81">1983</xref>):<disp-formula id="Equ40"><label>40</label><alternatives><mml:math display="block" id="Equ40_Math"><mml:mrow><mml:msubsup><mml:mi>α</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>∫</mml:mo><mml:msub><mml:mi mathvariant="bold">e</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo>·</mml:mo><mml:mtext>d</mml:mtext><mml:mi mathvariant="bold">S</mml:mi></mml:mrow><mml:mrow><mml:mo>∫</mml:mo><mml:msub><mml:mi mathvariant="bold">e</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msubsup><mml:mi mathvariant="bold">h</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mo>·</mml:mo><mml:mtext>d</mml:mtext><mml:mi mathvariant="bold">S</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>∫</mml:mo><mml:msub><mml:mi>e</mml:mi><mml:mrow><mml:mi mathvariant="italic">yi</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mi>H</mml:mi><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mtext>d</mml:mtext><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mo>∫</mml:mo><mml:msub><mml:mi>e</mml:mi><mml:mrow><mml:mi mathvariant="italic">yi</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mi>h</mml:mi><mml:mrow><mml:mi mathvariant="italic">zi</mml:mi></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mtext>d</mml:mtext><mml:mi>y</mml:mi></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ40_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{i}^{*} = \frac{\int \mathbf {e}_{i}\times \mathbf {H}^{*}\cdot {\text {d}}\mathbf {S}}{\int \mathbf {e}_{i}\times \mathbf {h}_{i}^{*}\cdot {\text {d}}\mathbf {S}}=\frac{\int e_{yi}H_{z}^{*}{\text {d}}y}{\int e_{yi}h_{zi}^{*}{\text {d}}y},$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ40.gif" position="anchor"/></alternatives></disp-formula>where we have assumed an <italic>x</italic>-oriented waveguide in 2D and an in-plane electric-field polarization. The power carried by this mode is then simply <inline-formula id="IEq318"><alternatives><mml:math id="IEq318_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:math><tex-math id="IEq318_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\vert \alpha _{i}\vert ^{2}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq318.gif"/></alternatives></inline-formula>. In Sect. <xref rid="Sec12" ref-type="sec">4.3</xref>, our objective is the power <inline-formula id="IEq319"><alternatives><mml:math id="IEq319_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:msup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:math><tex-math id="IEq319_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\vert \alpha _{0}\vert ^{2}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq319.gif"/></alternatives></inline-formula> in a single mode:<disp-formula id="Equ41"><label>41</label><alternatives><mml:math display="block" id="Equ41_Math"><mml:mrow><mml:mrow><mml:mrow><mml:mo stretchy="false">⟨</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">⟩</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:msup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mfenced close="|" open="|"><mml:mfrac><mml:mn>1</mml:mn><mml:msub><mml:mi>N</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mfrac><mml:mo>∫</mml:mo><mml:msub><mml:mi>e</mml:mi><mml:mrow><mml:mi>y</mml:mi><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msubsup><mml:mi>H</mml:mi><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mrow/><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mtext>d</mml:mtext><mml:mi>y</mml:mi></mml:mfenced><mml:mn>2</mml:mn></mml:msup><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ41_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\langle P\rangle = \vert \alpha _{0}\vert ^{2}= \left| \frac{1}{N_{0}} \int e_{y0}H_{z}^{*}{\text {d}}y\right| ^{2} ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ41.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq320"><alternatives><mml:math id="IEq320_Math"><mml:msub><mml:mi>N</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:math><tex-math id="IEq320_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N_{0}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq320.gif"/></alternatives></inline-formula> is the normalization (which can be omitted for optimization) from Eq. (<xref rid="Equ40" ref-type="disp-formula">40</xref>). If <inline-formula id="IEq321"><alternatives><mml:math id="IEq321_Math"><mml:msub><mml:mi>H</mml:mi><mml:mi>z</mml:mi></mml:msub></mml:math><tex-math id="IEq321_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H_{z}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq321.gif"/></alternatives></inline-formula> is expressed as a linear combination <inline-formula id="IEq322"><alternatives><mml:math id="IEq322_Math"><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mi>n</mml:mi></mml:msub><mml:msub><mml:mi>u</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:msub><mml:mover accent="true"><mml:mi>u</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub></mml:mrow></mml:math><tex-math id="IEq322_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sum _{n} u_{n} {\hat{u}}_{n}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq322.gif"/></alternatives></inline-formula> of finite-element basis functions <inline-formula id="IEq323"><alternatives><mml:math id="IEq323_Math"><mml:msub><mml:mover accent="true"><mml:mi>u</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub></mml:math><tex-math id="IEq323_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{u}}_{n}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq323.gif"/></alternatives></inline-formula>, Eq. (<xref rid="Equ41" ref-type="disp-formula">41</xref>) becomes <inline-formula id="IEq324"><alternatives><mml:math id="IEq324_Math"><mml:mrow><mml:mrow><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">o</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">u</mml:mi><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:math><tex-math id="IEq324_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\Vert \mathbf {o}^{\dagger} \mathbf {u}\Vert ^{2}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq324.gif"/></alternatives></inline-formula> as in Eq. (<xref rid="Equ10" ref-type="disp-formula">10</xref>), where <inline-formula id="IEq325"><alternatives><mml:math id="IEq325_Math"><mml:mi mathvariant="bold">o</mml:mi></mml:math><tex-math id="IEq325_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {o}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq325.gif"/></alternatives></inline-formula> has components <inline-formula id="IEq326"><alternatives><mml:math id="IEq326_Math"><mml:msub><mml:mi>o</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math><tex-math id="IEq326_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$o_{n}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq326.gif"/></alternatives></inline-formula> given by the linear functional:<disp-formula id="Equ42"><label>42</label><alternatives><mml:math display="block" id="Equ42_Math"><mml:mrow><mml:msub><mml:mi>o</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>o</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>u</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:msub><mml:mi>N</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mfrac><mml:mo>∫</mml:mo><mml:msub><mml:mi>e</mml:mi><mml:mrow><mml:mi>y</mml:mi><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mover accent="true"><mml:mi>u</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mtext>d</mml:mtext><mml:mi>y</mml:mi><mml:mo>.</mml:mo></mml:mrow></mml:math><tex-math id="Equ42_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$o_{n} = o({\hat{u}}_{n}) =\frac{1}{N_{0}}\int e_{y0} {\hat{u}}_{n} {\text {d}}y .$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ42.gif" position="anchor"/></alternatives></disp-formula>Computationally, the assembly of <inline-formula id="IEq327"><alternatives><mml:math id="IEq327_Math"><mml:mi mathvariant="bold">o</mml:mi></mml:math><tex-math id="IEq327_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {o}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq327.gif"/></alternatives></inline-formula> in finite-element software is equivalent to constructing a right-hand-side (source) vector <inline-formula id="IEq328"><alternatives><mml:math id="IEq328_Math"><mml:mi mathvariant="bold">b</mml:mi></mml:math><tex-math id="IEq328_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {b}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq328.gif"/></alternatives></inline-formula>.</p><p id="Par66">The optimization becomes<disp-formula id="Equ43"><label>43</label><alternatives><mml:math display="block" id="Equ43_Math"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi>g</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:munder><mml:mo movablelimits="true">max</mml:mo><mml:mi>ρ</mml:mi></mml:munder><mml:mfenced close="]" open="["><mml:mi mathvariant="bold">u</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:mi mathvariant="bold">B</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">u</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mi mathvariant="bold">u</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="bold">A</mml:mi><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mo>†</mml:mo></mml:mrow></mml:msup><mml:mi mathvariant="bold">o</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mn>0</mml:mn><mml:mo>≤</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi>ρ</mml:mi><mml:mo>≤</mml:mo><mml:mn>1</mml:mn><mml:mo>.</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><tex-math id="Equ43_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} g(\rho )= &amp; {} \max _{\rho } \left[ \mathbf {u}(\rho )^{\dagger} \mathbf {B}(\rho )\mathbf {u}(\rho )\right] , \\ \mathbf {u}(\rho )= &amp; {} \mathbf {A}(\rho )^{-\dagger }\mathbf {o}, \\ 0\le &amp; {} \rho \le 1. \end{aligned}$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ43.gif" position="anchor"/></alternatives></disp-formula>By the adjoint method, for any <italic>K</italic>, we obtain the derivatives:<disp-formula id="Equ44"><label>44</label><alternatives><mml:math display="block" id="Equ44_Math"><mml:mrow><mml:mfrac><mml:mrow><mml:mtext>d</mml:mtext><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mtext>d</mml:mtext><mml:mi>p</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:mfenced close="}" open="{"><mml:msubsup><mml:mi mathvariant="bold">u</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:mfrac><mml:mrow><mml:mtext>d</mml:mtext><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mtext>d</mml:mtext><mml:mi>p</mml:mi></mml:mrow></mml:mfrac><mml:msub><mml:mi mathvariant="bold">u</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:mn>2</mml:mn><mml:mtext>Re</mml:mtext><mml:mfenced close="]" open="["><mml:msubsup><mml:mi mathvariant="bold">w</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msubsup><mml:mfenced close=")" open="("><mml:mfrac><mml:mrow><mml:mtext>d</mml:mtext><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup></mml:mrow><mml:mrow><mml:mtext>d</mml:mtext><mml:mi>p</mml:mi></mml:mrow></mml:mfrac><mml:msub><mml:mi mathvariant="bold">u</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mfenced></mml:mfenced></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:math><tex-math id="Equ44_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\frac{{\text {d}} g}{{\text {d}}p}=\sum _{i=1}^{K}\left\{ \mathbf {u}_{i}^{\dagger} \frac{{\text {d}}\mathbf {B}}{{\text {d}}p}\mathbf {u}_{i}-2{\text {Re}}\left[ \mathbf {w}_{i}^{\dagger} \left( \frac{{\text {d}}\mathbf {A}^{\dagger} }{{\text {d}}p}\mathbf {u}_{i}\right) \right] \right\} ,$$\end{document}</tex-math><graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_Equ44.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq329"><alternatives><mml:math id="IEq329_Math"><mml:msub><mml:mi mathvariant="bold">w</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><tex-math id="IEq329_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {w}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq329.gif"/></alternatives></inline-formula> solves <inline-formula id="IEq330"><alternatives><mml:math id="IEq330_Math"><mml:mrow><mml:mi mathvariant="bold">A</mml:mi><mml:msub><mml:mi mathvariant="bold">w</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi mathvariant="bold">B</mml:mi><mml:msub><mml:mi mathvariant="bold">u</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math><tex-math id="IEq330_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}\mathbf {w}_{i}=\mathbf {B}\mathbf {u}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq330.gif"/></alternatives></inline-formula> and <inline-formula id="IEq331"><alternatives><mml:math id="IEq331_Math"><mml:msub><mml:mi mathvariant="bold">u</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><tex-math id="IEq331_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {u}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq331.gif"/></alternatives></inline-formula> solves the reciprocal problem <inline-formula id="IEq332"><alternatives><mml:math id="IEq332_Math"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">A</mml:mi></mml:mrow><mml:mo>†</mml:mo></mml:msup><mml:msub><mml:mi mathvariant="bold">u</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi mathvariant="bold">o</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math><tex-math id="IEq332_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf {A}^{\dagger} \mathbf {u}_{i} = \mathbf {o}_{i}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq332.gif"/></alternatives></inline-formula> from Eq. (<xref rid="Equ25" ref-type="disp-formula">25</xref>). This derivative is also compared with the finite difference method and a difference of about <inline-formula id="IEq333"><alternatives><mml:math id="IEq333_Math"><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:math><tex-math id="IEq333_TeX">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym}
				\usepackage{amsfonts}
				\usepackage{amssymb}
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$10^{-6}$$\end{document}</tex-math><inline-graphic specific-use="web" mime-subtype="GIF" xlink:href="158_2022_3389_Article_IEq333.gif"/></alternatives></inline-formula> is observed. The analysis work flow is provided in Fig. <xref rid="Fig5" ref-type="fig">5</xref>.<fig id="Fig5"><label>Fig. 5</label><caption xml:lang="en"><p>Flowchart of the optimization steps for the emission into a waveguide example</p></caption><graphic specific-use="web" mime-subtype="PNG" xlink:href="MediaObjects/158_2022_3389_Fig5_HTML.png" position="anchor" id="MO44"/></fig></p></sec></sec></app></app-group><notes notes-type="Misc"><title>Publisher's Note</title><p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p></notes></back></article></records><facets><facet name="subject"><facet-value count="1">Computational Mathematics and Numerical Analysis</facet-value><facet-value count="1">Engineering</facet-value><facet-value count="1">Engineering Design</facet-value><facet-value count="1">Theoretical and Applied Mechanics</facet-value></facet><facet name="keyword"><facet-value count="1">Incoherent emission</facet-value><facet-value count="1">Inverse design</facet-value><facet-value count="1">Topology optimization</facet-value></facet><facet name="pub"><facet-value count="1">Structural and Multidisciplinary Optimization</facet-value></facet><facet name="year"><facet-value count="1">2022</facet-value></facet><facet name="country"><facet-value count="1">Denmark</facet-value><facet-value count="1">Spain</facet-value><facet-value count="1">United States</facet-value></facet><facet name="type"><facet-value count="1">Journal</facet-value></facet></facets></response>
